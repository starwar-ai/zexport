# 版本控制策略

<cite>
**本文档引用的文件**   
- [pom.xml](file://pom.xml)
- [yudao-dependencies/pom.xml](file://yudao-dependencies/pom.xml)
- [yudao-server/pom.xml](file://yudao-server/pom.xml)
- [eplus-module-crm/pom.xml](file://eplus-module-crm/pom.xml)
- [eplus-module-dms/pom.xml](file://eplus-module-dms/pom.xml)
- [eplus-flyway/pom.xml](file://eplus-flyway/pom.xml)
- [eplus-module-crm/eplus-module-crm-biz/pom.xml](file://eplus-module-crm/eplus-module-crm-biz/pom.xml)
- [eplus-module-dms/eplus-module-dms-biz/pom.xml](file://eplus-module-dms/eplus-module-dms-biz/pom.xml)
- [yudao-framework/pom.xml](file://yudao-framework/pom.xml)
- [README.md](file://README.md)
- [eplus-framework/README.md](file://eplus-framework/README.md)
- [eplus-module-infra/eplus-module-infra-biz/src/main/java/com/syj/eplus/module/infra/dal/dataobject/version/VersionDO.java](file://eplus-module-infra/eplus-module-infra-biz/src/main/java/com/syj/eplus/module/infra/dal/dataobject/version/VersionDO.java)
- [eplus-flyway/src/main/java/db/migration/common/V1_0_0_136__vender表修改ver字段.java](file://eplus-flyway/src/main/java/db/migration/common/V1_0_0_136__vender表修改ver字段.java)
</cite>

## 目录
1. [引言](#引言)
2. [语义化版本控制规范](#语义化版本控制规范)
3. [Maven版本管理机制](#maven版本管理机制)
4. [SNAPSHOT版本使用场景](#snapshot版本使用场景)
5. [发布版本流程](#发布版本流程)
6. [版本兼容性策略](#版本兼容性策略)
7. [版本升级操作指南](#版本升级操作指南)
8. [结论](#结论)

## 引言

eplus-admin-server项目采用严格的版本控制策略，确保多模块协同开发的稳定性和可维护性。本项目基于Spring Boot构建，采用Maven作为构建工具，通过BOM（Bill of Materials）机制统一管理依赖版本。项目结构包含18个核心业务模块和多个基础设施模块，通过语义化版本控制规范和Flyway数据库迁移工具，实现了代码、配置和数据库的版本同步管理。项目的版本策略不仅关注功能迭代，还特别重视向后兼容性、依赖管理和发布流程的规范化。

**Section sources**
- [README.md](file://README.md)

## 语义化版本控制规范

eplus-admin-server项目严格遵循语义化版本控制（Semantic Versioning）规范，版本号格式为`主版本号.次版本号.修订号`（MAJOR.MINOR.PATCH），每个部分具有明确的含义：

- **主版本号（MAJOR）**：当进行不兼容的API修改或重大架构变更时递增。例如，从v1.x.x升级到v2.x.x表示存在破坏性变更，需要开发者进行代码适配。
- **次版本号（MINOR）**：当以向后兼容的方式添加新功能时递增。例如，v1.1.x相对于v1.0.x增加了新API，但不影响现有功能的使用。
- **修订号（PATCH）**：当进行向后兼容的问题修复时递增。例如，v1.0.1修复了v1.0.0中的bug，但不包含新功能。

项目在`pom.xml`文件中通过`${revision}`属性统一管理版本号，确保所有模块使用相同的版本标识。在`yudao-dependencies/pom.xml`中，`<properties>`部分定义了`<revision>1.0.0</revision>`，作为整个项目的基准版本。这种集中式管理方式避免了版本碎片化，确保了构建的一致性。

**Section sources**
- [pom.xml](file://pom.xml#L51)
- [yudao-dependencies/pom.xml](file://yudao-dependencies/pom.xml#L17)

## Maven版本管理机制

eplus-admin-server项目通过Maven的BOM（Bill of Materials）机制实现依赖版本的统一升级。核心配置位于`yudao-dependencies/pom.xml`文件中，该文件作为项目的依赖管理中枢，定义了所有第三方库和内部模块的版本。

在`yudao-dependencies/pom.xml`的`<dependencyManagement>`部分，通过`<dependencies>`标签声明了所有依赖的版本。例如：
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-dependencies</artifactId>
    <version>${spring.boot.version}</version>
    <type>pom</type>
    <scope>import</scope>
</dependency>
```
这种方式将Spring Boot及其所有相关组件的版本锁定，确保了框架内部的兼容性。

在根`pom.xml`文件中，通过`<dependencyManagement>`引入该BOM：
```xml
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>cn.iocoder.boot</groupId>
            <artifactId>yudao-dependencies</artifactId>
            <version>${revision}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
```
这种设计使得所有子模块无需指定依赖版本，只需声明`groupId`和`artifactId`，版本由BOM自动提供。当需要升级依赖时，只需修改`yudao-dependencies/pom.xml`中的版本号，所有模块将自动继承新版本，实现了依赖的统一升级。

**Section sources**
- [pom.xml](file://pom.xml#L66-L76)
- [yudao-dependencies/pom.xml](file://yudao-dependencies/pom.xml#L78-L655)

## SNAPSHOT版本使用场景

SNAPSHOT版本在eplus-admin-server项目中主要用于开发环境，表示一个正在积极开发中的不稳定版本。当模块的版本号包含`-SNAPSHOT`后缀（如`1.0.0-SNAPSHOT`）时，Maven会将其识别为快照版本。

SNAPSHOT版本的主要使用场景包括：
1. **日常开发**：开发人员在功能分支上进行开发时，使用SNAPSHOT版本以便频繁发布和测试。
2. **模块间依赖**：当一个模块（如`eplus-module-crm-biz`）依赖另一个正在开发的模块时，可以依赖其SNAPSHOT版本，确保获取最新的代码变更。
3. **持续集成**：CI/CD流水线在构建开发分支时，自动发布SNAPSHOT版本到私有仓库，供其他团队成员使用。

在`pom.xml`文件中，通过`${revision}`属性可以灵活切换版本模式。开发时，`revision`可设置为`1.0.0-SNAPSHOT`，而在发布时改为稳定的版本号。Maven会自动处理SNAPSHOT版本的更新，每次构建时检查远程仓库是否有更新的SNAPSHOT版本。

**Section sources**
- [pom.xml](file://pom.xml#L8)
- [yudao-dependencies/pom.xml](file://yudao-dependencies/pom.xml#L9)

## 发布版本流程

eplus-admin-server项目的发布版本流程是一个严谨的多步骤过程，确保了发布的稳定性和可追溯性：

1. **版本冻结**：在发布前，确定版本号（如v1.0.0），并将所有模块的`${revision}`属性从`-SNAPSHOT`改为稳定版本号。
2. **代码审查**：对所有变更进行代码审查，确保符合编码规范和质量标准。
3. **测试验证**：运行完整的单元测试、集成测试和回归测试，确保功能完整性和稳定性。
4. **数据库迁移**：使用Flyway执行数据库迁移脚本。在`eplus-flyway`模块中，SQL脚本按版本号命名（如`V1_0_0_125__xxx.sql`），确保数据库结构与代码版本同步。
5. **构建打包**：使用Maven执行`mvn clean install`命令，构建所有模块的JAR包。
6. **部署发布**：将构建产物部署到生产环境，并更新版本记录。

在`README.md`中记录了详细的更新日志，包括重构优化、技术栈升级、新增功能和Bug修复等内容，为用户提供清晰的版本变更信息。

**Section sources**
- [README.md](file://README.md#L709-L743)
- [eplus-flyway/pom.xml](file://eplus-flyway/pom.xml#L51-L72)

## 版本兼容性策略

eplus-admin-server项目高度重视版本兼容性，采用多层次策略保障API的向后兼容性：

1. **API版本化**：通过`eplus-api-aggregator`模块聚合所有业务模块的API接口，确保API定义的稳定性和一致性。业务模块通过依赖此聚合模块，避免了直接依赖实现模块，降低了耦合度。
2. **接口隔离**：采用API层和BIZ层分离的设计模式。API模块（如`eplus-module-crm-api`）仅包含DTO、枚举和接口定义，BIZ模块（如`eplus-module-crm-biz`）实现具体业务逻辑。这种设计允许在不破坏API的情况下重构内部实现。
3. **数据库兼容性**：通过Flyway管理数据库变更。在`eplus-flyway/src/main/java/db/migration/common/V1_0_0_136__vender表修改ver字段.java`中，可以看到通过`changeColumn`方法修改字段定义，确保数据库变更的平滑过渡。
4. **错误码管理**：通过`yudao-spring-boot-starter-error-code`组件统一管理错误码，确保错误信息的稳定性和可预测性。

对于不兼容的变更，项目采用主版本号递增的策略，并提供详细的迁移指南，帮助用户平滑升级。

**Section sources**
- [eplus-module-crm/pom.xml](file://eplus-module-crm/pom.xml)
- [eplus-module-dms/pom.xml](file://eplus-module-dms/pom.xml)
- [eplus-flyway/src/main/java/db/migration/common/V1_0_0_136__vender表修改ver字段.java](file://eplus-flyway/src/main/java/db/migration/common/V1_0_0_136__vender表修改ver字段.java#L20)

## 版本升级操作指南

### 依赖更新
升级项目依赖时，应遵循以下步骤：
1. 修改`yudao-dependencies/pom.xml`中相应依赖的版本号。
2. 运行`mvn versions:display-dependency-updates`检查依赖更新。
3. 执行`mvn clean install`重新构建项目。
4. 验证所有测试用例通过。

### 冲突解决
当出现依赖冲突时，可通过以下方式解决：
1. 使用`mvn dependency:tree`分析依赖树，定位冲突来源。
2. 在`dependencyManagement`中显式声明冲突依赖的版本。
3. 使用`<exclusions>`排除不需要的传递依赖。

### 回归测试
版本升级后必须执行完整的回归测试：
1. 运行所有单元测试：`mvn test`
2. 执行集成测试，验证模块间交互。
3. 进行手动测试，覆盖核心业务流程。
4. 检查系统监控指标，确保性能无退化。

在`eplus-module-infra-biz`模块中，`SnServiceImplTest`提供了并发测试示例，验证了序列号生成服务的线程安全性，体现了项目对质量的重视。

**Section sources**
- [yudao-dependencies/pom.xml](file://yudao-dependencies/pom.xml)
- [eplus-module-infra/eplus-module-infra-biz/src/test/java/com/syj/eplus/module/infra/service/sn/SnServiceImplTest.java](file://eplus-module-infra/eplus-module-infra-biz/src/test/java/com/syj/eplus/module/infra/service/sn/SnServiceImplTest.java)

## 结论

eplus-admin-server项目通过语义化版本控制、Maven BOM依赖管理、Flyway数据库迁移和严格的发布流程，建立了一套完善的版本控制体系。该体系确保了多模块协同开发的稳定性，支持平滑的版本升级和向后兼容性。通过集中式版本管理，项目有效避免了依赖冲突和版本碎片化问题。建议在未来的开发中，继续遵循这些最佳实践，并考虑引入自动化发布工具，进一步提升发布效率和可靠性。