# 服务间通信机制

<cite>
**本文档引用文件**   
- [eplus-api-aggregator/pom.xml](file://eplus-api-aggregator/pom.xml)
- [eplus-module-scm-biz/pom.xml](file://eplus-module-scm/eplus-module-scm-biz/pom.xml)
- [eplus-module-sms-api/src/main/java/com/syj/eplus/module/sms/api/SaleContractApi.java](file://eplus-module-sms/eplus-module-sms-api/src/main/java/com/syj/eplus/module/sms/api/SaleContractApi.java)
- [eplus-module-scm-biz/src/main/java/com/syj/eplus/module/scm/api/PurchaseContractApiImpl.java](file://eplus-module-scm/eplus-module-scm-biz/src/main/java/com/syj/eplus/module/scm/api/PurchaseContractApiImpl.java)
- [eplus-module-scm-biz/src/main/java/com/syj/eplus/module/scm/service/purchasecontract/PurchaseContractServiceImpl.java](file://eplus-module-scm/eplus-module-scm-biz/src/main/java/com/syj/eplus/module/scm/service/purchasecontract/PurchaseContractServiceImpl.java)
- [eplus-module-crm-biz/src/main/java/com/syj/eplus/module/crm/api/CustApiImpl.java](file://eplus-module-crm/eplus-module-crm-biz/src/main/java/com/syj/eplus/module/crm/api/CustApiImpl.java)
- [README.md](file://README.md)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 引言
本项目采用模块化架构设计，通过清晰的分层和依赖管理实现服务间的高效通信。系统基于Spring Boot框架，利用Maven进行依赖管理，通过API聚合模块简化跨模块调用。各业务模块独立开发，通过定义良好的API接口进行通信，实现了高内聚、低耦合的系统架构。

## 项目结构
项目采用多模块Maven结构，分为核心基础层、系统基础模块、核心业务模块、工具模块和应用启动模块。这种分层架构使得各模块职责清晰，便于维护和扩展。

```mermaid
graph TD
subgraph "核心基础层"
A[yudao-dependencies]
B[yudao-framework]
C[eplus-framework]
end
subgraph "系统基础模块"
D[yudao-module-system]
E[yudao-module-infra]
F[eplus-module-infra]
G[yudao-module-bpm]
end
subgraph "核心业务模块"
H[eplus-module-scm]
I[eplus-module-sms]
J[eplus-module-wms]
K[eplus-module-fms]
L[eplus-module-pms]
M[eplus-module-crm]
N[eplus-module-qms]
O[eplus-module-mms]
P[eplus-module-dms]
Q[eplus-module-oa]
R[eplus-module-home]
S[eplus-module-dpms]
T[eplus-module-dtms]
U[eplus-module-ems]
V[eplus-module-exms]
W[eplus-module-pjms]
X[eplus-module-report]
Y[eplus-module-social]
end
subgraph "工具模块"
Z[eplus-api-aggregator]
AA[eplus-flyway]
end
subgraph "应用启动"
AB[yudao-server]
end
A --> B
A --> C
B --> D
B --> E
B --> G
B --> F
B --> H
B --> I
B --> J
B --> K
B --> L
B --> M
B --> N
B --> O
B --> P
B --> Q
B --> R
B --> S
B --> T
B --> U
B --> V
B --> W
B --> X
B --> Y
Z --> H
Z --> I
Z --> J
Z --> K
Z --> L
Z --> M
Z --> N
Z --> O
Z --> P
Z --> Q
Z --> R
Z --> S
Z --> T
Z --> U
Z --> V
Z --> W
Z --> X
Z --> Y
AB --> Z
AB --> D
AB --> E
AB --> F
AB --> G
AB --> H
AB --> I
AB --> J
AB --> K
AB --> L
AB --> M
AB --> N
AB --> O
AB --> P
AB --> Q
AB --> R
AB --> S
AB --> T
AB --> U
AB --> V
AB --> W
AB --> X
AB --> Y
```

**图表来源**
- [README.md](file://README.md#L62-L179)

**本节来源**
- [README.md](file://README.md#L62-L179)

## 核心组件
项目的核心组件包括API聚合模块、各业务模块的API和BIZ实现，以及基础框架组件。API聚合模块统一管理所有业务模块的API依赖，简化了业务模块的依赖声明。

**本节来源**
- [eplus-api-aggregator/pom.xml](file://eplus-api-aggregator/pom.xml#L1-L151)
- [eplus-module-scm-biz/pom.xml](file://eplus-module-scm/eplus-module-scm-biz/pom.xml#L1-L74)

## 架构概述
系统采用分层架构，通过API聚合模块实现服务间通信。各业务模块通过依赖API聚合模块，获得所有其他模块的API接口，实现服务调用。

```mermaid
graph TD
A[yudao-server] --> B[eplus-api-aggregator]
B --> C[eplus-module-scm-api]
B --> D[eplus-module-sms-api]
B --> E[eplus-module-wms-api]
B --> F[eplus-module-fms-api]
B --> G[eplus-module-pms-api]
B --> H[eplus-module-crm-api]
B --> I[eplus-module-qms-api]
B --> J[eplus-module-mms-api]
B --> K[eplus-module-dms-api]
B --> L[eplus-module-oa-api]
B --> M[eplus-module-home-api]
B --> N[eplus-module-dpms-api]
B --> O[eplus-module-dtms-api]
B --> P[eplus-module-ems-api]
B --> Q[eplus-module-exms-api]
B --> R[eplus-module-pjms-api]
B --> S[eplus-module-report-api]
B --> T[eplus-module-social-api]
A --> U[yudao-framework]
U --> V[yudao-common]
U --> W[yudao-spring-boot-starter-web]
U --> X[yudao-spring-boot-starter-security]
U --> Y[yudao-spring-boot-starter-mybatis]
U --> Z[yudao-spring-boot-starter-redis]
```

**图表来源**
- [README.md](file://README.md#L183-L257)

**本节来源**
- [README.md](file://README.md#L183-L257)

## 详细组件分析

### API聚合模块分析
API聚合模块是服务间通信的核心，它统一聚合所有业务模块的API，简化了业务模块的依赖管理。

```mermaid
classDiagram
class eplus_api_aggregator {
+pom.xml
}
class eplus_module_scm_api {
+PurchaseContractApi
+PurchasePlanApi
+VenderApi
}
class eplus_module_sms_api {
+SaleContractApi
+AddSubItemApi
+SaleAuxiliaryAllocationApi
}
class eplus_module_wms_api {
+StockApi
+WarehouseApi
+StockNoticeApi
}
class eplus_module_fms_api {
+PaymentApi
+ReceiptApi
+CustClaimApi
}
class eplus_module_pms_api {
+SkuApi
+CategoryApi
+PackageTypeApi
}
class eplus_module_crm_api {
+CustApi
+OpportunityApi
+ServiceApi
}
class eplus_module_qms_api {
+QualityInspectionApi
}
class eplus_module_mms_api {
+ManufactureApi
}
class eplus_module_dms_api {
+ShipmentApi
+ForwarderFeeApi
+ShipmentPlanApi
}
class eplus_module_oa_api {
+PaymentAppApi
+ReimbApi
+TravelAppApi
+LoanAppApi
}
class eplus_module_home_api {
+InvoiceHolderApi
}
class eplus_module_dpms_api {
+ErrorCodeConstants
}
class eplus_module_dtms_api {
+DesignApi
+DesignItemApi
+ErrorCodeConstants
}
class eplus_module_ems_api {
+SendApi
+SendBillApi
+SendProductApi
}
class eplus_module_exms_api {
+ExhibitionApi
}
class eplus_module_pjms_api {
+ProjectApi
}
class eplus_module_report_api {
+ReportApi
}
class eplus_module_social_api {
+WechatApi
}
eplus_api_aggregator --> eplus_module_scm_api : "聚合"
eplus_api_aggregator --> eplus_module_sms_api : "聚合"
eplus_api_aggregator --> eplus_module_wms_api : "聚合"
eplus_api_aggregator --> eplus_module_fms_api : "聚合"
eplus_api_aggregator --> eplus_module_pms_api : "聚合"
eplus_api_aggregator --> eplus_module_crm_api : "聚合"
eplus_api_aggregator --> eplus_module_qms_api : "聚合"
eplus_api_aggregator --> eplus_module_mms_api : "聚合"
eplus_api_aggregator --> eplus_module_dms_api : "聚合"
eplus_api_aggregator --> eplus_module_oa_api : "聚合"
eplus_api_aggregator --> eplus_module_home_api : "聚合"
eplus_api_aggregator --> eplus_module_dpms_api : "聚合"
eplus_api_aggregator --> eplus_module_dtms_api : "聚合"
eplus_api_aggregator --> eplus_module_ems_api : "聚合"
eplus_api_aggregator --> eplus_module_exms_api : "聚合"
eplus_api_aggregator --> eplus_module_pjms_api : "聚合"
eplus_api_aggregator --> eplus_module_report_api : "聚合"
eplus_api_aggregator --> eplus_module_social_api : "聚合"
```

**图表来源**
- [eplus-api-aggregator/pom.xml](file://eplus-api-aggregator/pom.xml#L24-L148)

**本节来源**
- [eplus-api-aggregator/pom.xml](file://eplus-api-aggregator/pom.xml#L1-L151)

### 服务调用实现分析
服务调用通过Spring的依赖注入机制实现，BIZ模块依赖API模块来调用其他服务。

```mermaid
sequenceDiagram
participant PurchaseContractServiceImpl
participant SaleContractApi
participant SaleContractApiImpl
participant SaleContractService
PurchaseContractServiceImpl->>SaleContractApi : getSaleContractById(id)
SaleContractApi->>SaleContractApiImpl : getSaleContractById(id)
SaleContractApiImpl->>SaleContractService : getSaleContractById(id)
SaleContractService-->>SaleContractApiImpl : SaleContractDTO
SaleContractApiImpl-->>SaleContractApi : SaleContractDTO
SaleContractApi-->>PurchaseContractServiceImpl : SaleContractDTO
```

**图表来源**
- [eplus-module-scm-biz/src/main/java/com/syj/eplus/module/scm/service/purchasecontract/PurchaseContractServiceImpl.java](file://eplus-module-scm/eplus-module-scm-biz/src/main/java/com/syj/eplus/module/scm/service/purchasecontract/PurchaseContractServiceImpl.java#L242-L296)
- [eplus-module-sms-api/src/main/java/com/syj/eplus/module/sms/api/SaleContractApi.java](file://eplus-module-sms/eplus-module-sms-api/src/main/java/com/syj/eplus/module/sms/api/SaleContractApi.java#L1-L475)

**本节来源**
- [eplus-module-scm-biz/src/main/java/com/syj/eplus/module/scm/service/purchasecontract/PurchaseContractServiceImpl.java](file://eplus-module-scm/eplus-module-scm-biz/src/main/java/com/syj/eplus/module/scm/service/purchasecontract/PurchaseContractServiceImpl.java#L242-L296)
- [eplus-module-sms-api/src/main/java/com/syj/eplus/module/sms/api/SaleContractApi.java](file://eplus-module-sms/eplus-module-sms-api/src/main/java/com/syj/eplus/module/sms/api/SaleContractApi.java#L1-L475)

### 依赖注入机制分析
基于Spring的依赖注入实现服务引用，通过@Resource注解注入API接口。

```mermaid
classDiagram
class PurchaseContractServiceImpl {
-SaleContractApi saleContractApi
-CustApi custApi
-VenderApi venderApi
-CompanyApi companyApi
-ReportApi reportApi
-FileApi fileApi
-PackageTypeApi packageTypeApi
-FeeShareApi feeShareApi
-IStockApi stockApi
-IWarehouseApi warehouseApi
-PaymentApplyService paymentApplyService
-FormChangeApi formChangeApi
-PurchaseContractApi purchaseContractApi
-ShipmentApi shipmentApi
-RateApi rateApi
}
class SaleContractApi {
+getSaleContractById(Long id)
+getAddSubItemListByContractCodeList(List<String> saleContractCodeList)
+batchUpdateAddSubItem(List<AddSubItemDTO> addSubItemDTOList)
+updateShipmentQuantity(Map<Long, Integer> shipmentQuantityMap, boolean cancelFlag)
+writeBackContract(List<WriteBackDTO> writeBackDTOList, boolean rollbackFlag)
}
class CustApi {
+getCustNameCache(String code)
+getSimpleCustRespDTO(List<Long> idList)
+getSimpleCustRespDTOMap(List<Long> idList)
}
class VenderApi {
+getSimpleVenderRespDTO(List<Long> idList)
+getSimpleVenderRespDTOMap(List<Long> idList)
}
class CompanyApi {
+getCompanyById(Long id)
+getCompanyByCode(String code)
+getCompanyListByIds(List<Long> ids)
}
class ReportApi {
+getReportData(String reportCode, Map<String, Object> params)
+exportReport(String reportCode, Map<String, Object> params)
}
class FileApi {
+uploadFile(MultipartFile file)
+downloadFile(String fileId)
+deleteFile(String fileId)
}
class PackageTypeApi {
+getPackageTypeById(Long id)
+getPackageTypeByCode(String code)
+getPackageTypeListByIds(List<Long> ids)
}
class FeeShareApi {
+calculateFeeShare(FeeShareReqDTO reqDTO)
+getFeeShareResult(Long resultId)
}
class IStockApi {
+getStockInfo(Long skuId, Long warehouseId)
+lockStock(LockStockReqVO reqVO)
+unlockStock(UnlockStockReqVO reqVO)
+updateStock(UpdateStockReqVO reqVO)
}
class IWarehouseApi {
+getWarehouseById(Long id)
+getWarehouseByCode(String code)
+getWarehouseListByIds(List<Long> ids)
}
class PaymentApplyService {
+createPaymentApply(PaymentApplySaveReqVO saveReqVO)
+getPaymentApplyById(Long id)
+updatePaymentApply(PaymentApplyUpdateReqVO updateReqVO)
+deletePaymentApply(Long id)
}
class FormChangeApi {
+createFormChange(FormChangeDTO formChangeDTO)
+getFormChangeById(Long id)
+updateFormChange(FormChangeDTO formChangeDTO)
+deleteFormChange(Long id)
}
class PurchaseContractApi {
+getPurchaseContractById(Long id)
+getPurchaseContractByCode(String code)
+getPurchaseContractListByIds(List<Long> ids)
}
class ShipmentApi {
+getShipmentById(Long id)
+getShipmentByCode(String code)
+getShipmentListByIds(List<Long> ids)
}
class RateApi {
+getExchangeRate(String fromCurrency, String toCurrency)
+getExchangeRateBatch(List<String> currencyPairs)
}
PurchaseContractServiceImpl --> SaleContractApi : "依赖"
PurchaseContractServiceImpl --> CustApi : "依赖"
PurchaseContractServiceImpl --> VenderApi : "依赖"
PurchaseContractServiceImpl --> CompanyApi : "依赖"
PurchaseContractServiceImpl --> ReportApi : "依赖"
PurchaseContractServiceImpl --> FileApi : "依赖"
PurchaseContractServiceImpl --> PackageTypeApi : "依赖"
PurchaseContractServiceImpl --> FeeShareApi : "依赖"
PurchaseContractServiceImpl --> IStockApi : "依赖"
PurchaseContractServiceImpl --> IWarehouseApi : "依赖"
PurchaseContractServiceImpl --> PaymentApplyService : "依赖"
PurchaseContractServiceImpl --> FormChangeApi : "依赖"
PurchaseContractServiceImpl --> PurchaseContractApi : "依赖"
PurchaseContractServiceImpl --> ShipmentApi : "依赖"
PurchaseContractServiceImpl --> RateApi : "依赖"
```

**图表来源**
- [eplus-module-scm-biz/src/main/java/com/syj/eplus/module/scm/service/purchasecontract/PurchaseContractServiceImpl.java](file://eplus-module-scm/eplus-module-scm-biz/src/main/java/com/syj/eplus/module/scm/service/purchasecontract/PurchaseContractServiceImpl.java#L242-L296)

**本节来源**
- [eplus-module-scm-biz/src/main/java/com/syj/eplus/module/scm/service/purchasecontract/PurchaseContractServiceImpl.java](file://eplus-module-scm/eplus-module-scm-biz/src/main/java/com/syj/eplus/module/scm/service/purchasecontract/PurchaseContractServiceImpl.java#L242-L296)

## 依赖分析
项目通过Maven的依赖管理机制实现模块间的依赖关系，API聚合模块统一管理所有API依赖。

```mermaid
graph TD
A[eplus-api-aggregator] --> B[yudao-module-system-api]
A --> C[yudao-module-infra-api]
A --> D[yudao-module-bpm-api]
A --> E[eplus-module-infra-api]
A --> F[eplus-module-scm-api]
A --> G[eplus-module-pms-api]
A --> H[eplus-module-wms-api]
A --> I[eplus-module-sms-api]
A --> J[eplus-module-crm-api]
A --> K[eplus-module-fms-api]
A --> L[eplus-module-qms-api]
A --> M[eplus-module-dms-api]
A --> N[eplus-module-oa-api]
A --> O[eplus-module-home-api]
A --> P[eplus-module-ems-api]
A --> Q[eplus-module-mms-api]
A --> R[eplus-module-exms-api]
A --> S[eplus-module-pjms-api]
A --> T[eplus-module-dtms-api]
A --> U[eplus-module-dpms-api]
A --> V[eplus-module-report-api]
W[eplus-module-scm-biz] --> A
X[eplus-module-sms-biz] --> A
Y[eplus-module-wms-biz] --> A
Z[eplus-module-fms-biz] --> A
AA[eplus-module-pms-biz] --> A
AB[eplus-module-crm-biz] --> A
AC[eplus-module-qms-biz] --> A
AD[eplus-module-mms-biz] --> A
AE[eplus-module-dms-biz] --> A
AF[eplus-module-oa-biz] --> A
AG[eplus-module-home-biz] --> A
AH[eplus-module-dpms-biz] --> A
AI[eplus-module-dtms-biz] --> A
AJ[eplus-module-ems-biz] --> A
AK[eplus-module-exms-biz] --> A
AL[eplus-module-pjms-biz] --> A
AM[eplus-module-report-biz] --> A
AN[eplus-module-social-biz] --> A
```

**图表来源**
- [eplus-api-aggregator/pom.xml](file://eplus-api-aggregator/pom.xml#L24-L148)
- [eplus-module-scm-biz/pom.xml](file://eplus-module-scm/eplus-module-scm-biz/pom.xml#L23-L27)

**本节来源**
- [eplus-api-aggregator/pom.xml](file://eplus-api-aggregator/pom.xml#L1-L151)
- [eplus-module-scm-biz/pom.xml](file://eplus-module-scm/eplus-module-scm-biz/pom.xml#L1-L74)

## 性能考虑
当前架构下的调用性能特征主要体现在本地JVM调用，由于所有服务都在同一个JVM进程中，服务间调用实际上是本地方法调用，性能开销较小。

**本节来源**
- [README.md](file://README.md#L234-L239)

## 故障排除指南
服务间通信的错误处理主要通过异常传播策略实现，当服务调用出现异常时，异常会沿着调用链向上传播。

**本节来源**
- [eplus-module-scm-biz/src/main/java/com/syj/eplus/module/scm/service/purchasecontract/PurchaseContractServiceImpl.java](file://eplus-module-scm/eplus-module-scm-biz/src/main/java/com/syj/eplus/module/scm/service/purchasecontract/PurchaseContractServiceImpl.java#L181-L195)

## 结论
本项目通过API聚合模块实现了高效的服务间通信机制，各业务模块通过依赖API聚合模块来调用其他服务，基于Spring的依赖注入实现服务引用。由于所有服务都在同一个JVM进程中，服务间调用实际上是本地方法调用，具有较高的性能。错误处理通过异常传播策略实现，确保了系统的稳定性和可靠性。