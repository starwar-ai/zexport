# 银行登记

<cite>
**本文档引用的文件**  
- [BankRegistrationDO.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/dal/dataobject/bankregistration/BankRegistrationDO.java)
- [BankRegistrationService.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/service/bankregistration/BankRegistrationService.java)
- [BankRegistrationServiceImpl.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/service/bankregistration/BankRegistrationServiceImpl.java)
- [BankRegistrationController.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/controller/admin/bankregistration/BankRegistrationController.java)
- [BankRegistrationMapper.xml](file://eplus-module-fms/eplus-module-fms-biz/src/main/resources/mapper/BankRegistrationMapper.xml)
- [CompanyBank.java](file://eplus-module-infra/eplus-module-infra-biz/src/main/java/com/syj/eplus/module/infra/dal/dataobject/company/CompanyBank.java)
- [V1_0_0_008__新建公司银行表.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_008__新建公司银行表.sql)
- [V1_0_0_073__付款相关表.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_073__付款相关表.sql)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 引言
银行登记功能是企业财务管理中的关键模块，用于管理公司银行账户、客户银行账户和供应商银行账户的信息。该功能支持银行信息的创建、维护，并在收付款业务中使用这些信息。本文档详细介绍了银行登记的实现细节，包括数据模型、业务流程、权限控制和安全保护措施。

## 项目结构
银行登记功能主要分布在FMS（财务管理系统）模块中，涉及多个子模块和组件。以下是相关文件的组织结构：

```mermaid
graph TD
subgraph "eplus-module-fms"
A[controller/admin/bankregistration] --> B[BankRegistrationController]
C[service/bankregistration] --> D[BankRegistrationService]
C --> E[BankRegistrationServiceImpl]
F[dal/dataobject/bankregistration] --> G[BankRegistrationDO]
H[dal/mysql/bankregistration] --> I[BankRegistrationMapper]
J[convert/bankregistration] --> K[BankRegistrationConvert]
L[resources/mapper] --> M[BankRegistrationMapper.xml]
end
subgraph "eplus-module-infra"
N[dal/dataobject/company] --> O[CompanyBank]
end
subgraph "eplus-flyway"
P[db/migration/common] --> Q[V1_0_0_008__新建公司银行表.sql]
P --> R[V1_0_0_073__付款相关表.sql]
end
B --> D
D --> E
E --> G
E --> I
G --> M
O --> M
```

**图源**  
- [BankRegistrationController.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/controller/admin/bankregistration/BankRegistrationController.java)
- [BankRegistrationService.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/service/bankregistration/BankRegistrationService.java)
- [BankRegistrationServiceImpl.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/service/bankregistration/BankRegistrationServiceImpl.java)
- [BankRegistrationDO.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/dal/dataobject/bankregistration/BankRegistrationDO.java)
- [BankRegistrationMapper.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/dal/mysql/bankregistration/BankRegistrationMapper.java)
- [BankRegistrationMapper.xml](file://eplus-module-fms/eplus-module-fms-biz/src/main/resources/mapper/BankRegistrationMapper.xml)
- [CompanyBank.java](file://eplus-module-infra/eplus-module-infra-biz/src/main/java/com/syj/eplus/module/infra/dal/dataobject/company/CompanyBank.java)
- [V1_0_0_008__新建公司银行表.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_008__新建公司银行表.sql)

## 核心组件
银行登记功能的核心组件包括控制器、服务层、数据访问层和数据模型。这些组件协同工作，实现了银行信息的全生命周期管理。

**节源**  
- [BankRegistrationController.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/controller/admin/bankregistration/BankRegistrationController.java)
- [BankRegistrationService.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/service/bankregistration/BankRegistrationService.java)
- [BankRegistrationServiceImpl.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/service/bankregistration/BankRegistrationServiceImpl.java)
- [BankRegistrationDO.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/dal/dataobject/bankregistration/BankRegistrationDO.java)

## 架构概述
银行登记功能采用典型的分层架构，包括表现层、业务逻辑层和数据访问层。这种架构确保了代码的可维护性和可扩展性。

```mermaid
graph TD
A[前端界面] --> B[BankRegistrationController]
B --> C[BankRegistrationService]
C --> D[BankRegistrationServiceImpl]
D --> E[BankRegistrationMapper]
E --> F[fms_bank_registration 表]
D --> G[CompanyBankMapper]
G --> H[system_company_bank 表]
```

**图源**  
- [BankRegistrationController.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/controller/admin/bankregistration/BankRegistrationController.java)
- [BankRegistrationService.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/service/bankregistration/BankRegistrationService.java)
- [BankRegistrationServiceImpl.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/service/bankregistration/BankRegistrationServiceImpl.java)
- [BankRegistrationMapper.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/dal/mysql/bankregistration/BankRegistrationMapper.java)
- [CompanyBank.java](file://eplus-module-infra/eplus-module-infra-biz/src/main/java/com/syj/eplus/module/infra/dal/dataobject/company/CompanyBank.java)

## 详细组件分析
### 银行登记数据模型
银行登记功能的数据模型包括两个主要实体：`BankRegistrationDO` 和 `CompanyBank`。`BankRegistrationDO` 用于存储银行登记的详细信息，而 `CompanyBank` 用于存储公司银行账户的基本信息。

#### BankRegistrationDO 类图
```mermaid
classDiagram
class BankRegistrationDO {
+Long id
+String code
+UserDept registeredBy
+LocalDateTime registrationDate
+Long companyId
+String companyName
+String companyTitle
+LocalDateTime bankPostingDate
+String bank
+String bankAccount
+String bankAddress
+String bankPoc
+String bankCode
+String currency
+BigDecimal amount
+String remark
+String custCode
+String custName
+UserDept manager
+UserDept claimManager
+Integer claimStatus
+LocalDateTime claimDate
+String linkSaleContractCode
+BigDecimal claimedAmount
+Integer status
+UserDept[] managerList
+SimpleData[] custList
}
```

**图源**  
- [BankRegistrationDO.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/dal/dataobject/bankregistration/BankRegistrationDO.java)

#### CompanyBank 类图
```mermaid
classDiagram
class CompanyBank {
+Long id
+Long companyId
+String companyName
+String companyNameEng
+String bankName
+String bankNameEng
+String bankAddress
+String bankAddressEng
+String bankCode
+String swiftCode
+Integer defaultFlag
}
```

**图源**  
- [CompanyBank.java](file://eplus-module-infra/eplus-module-infra-biz/src/main/java/com/syj/eplus/module/infra/dal/dataobject/company/CompanyBank.java)

### 银行登记流程
银行登记的创建和维护流程涉及多个步骤，从用户请求到数据库持久化。

#### 创建银行登记序列图
```mermaid
sequenceDiagram
participant User as "用户"
participant Controller as "BankRegistrationController"
participant Service as "BankRegistrationService"
participant Mapper as "BankRegistrationMapper"
participant DB as "数据库"
User->>Controller : POST /fms/bank-registration/create
Controller->>Service : createBankRegistration(createReqVO)
Service->>Service : 生成编号
Service->>Service : 设置状态
Service->>Service : 获取客户信息
Service->>Mapper : insertBatch(bankRegistrationDOList)
Mapper->>DB : 批量插入记录
DB-->>Mapper : 插入成功
Mapper-->>Service : 返回结果
Service-->>Controller : 返回结果
Controller-->>User : 返回成功响应
```

**图源**  
- [BankRegistrationController.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/controller/admin/bankregistration/BankRegistrationController.java)
- [BankRegistrationService.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/service/bankregistration/BankRegistrationService.java)
- [BankRegistrationServiceImpl.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/service/bankregistration/BankRegistrationServiceImpl.java)
- [BankRegistrationMapper.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/dal/mysql/bankregistration/BankRegistrationMapper.java)

### 银行信息使用规则
银行信息在收付款业务中被广泛使用，确保交易的准确性和安全性。

#### 收付款业务流程图
```mermaid
flowchart TD
Start([开始]) --> ValidateInput["验证输入参数"]
ValidateInput --> InputValid{"输入有效?"}
InputValid --> |否| ReturnError["返回错误响应"]
InputValid --> |是| CheckBankInfo["检查银行信息"]
CheckBankInfo --> BankInfoValid{"银行信息有效?"}
BankInfoValid --> |否| ReturnError
BankInfoValid --> |是| ProcessPayment["处理支付"]
ProcessPayment --> UpdateBankInfo["更新银行信息"]
UpdateBankInfo --> ReturnResult["返回结果"]
ReturnError --> End([结束])
ReturnResult --> End
```

**图源**  
- [BankRegistrationDO.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/dal/dataobject/bankregistration/BankRegistrationDO.java)
- [BankRegistrationService.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/service/bankregistration/BankRegistrationService.java)

## 依赖分析
银行登记功能依赖于多个外部组件和服务，包括用户管理、客户管理和供应商管理。

```mermaid
graph TD
A[BankRegistrationService] --> B[CodeGeneratorApi]
A --> C[CustApi]
A --> D[VenderApi]
A --> E[AdminUserApi]
B --> F[生成编号]
C --> G[获取客户信息]
D --> H[获取供应商信息]
E --> I[获取用户信息]
```

**图源**  
- [BankRegistrationServiceImpl.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/service/bankregistration/BankRegistrationServiceImpl.java)

## 性能考虑
银行登记功能在设计时考虑了性能优化，特别是在批量操作和查询方面。

- **批量插入**：使用 `insertBatch` 方法进行批量插入，提高数据持久化效率。
- **分页查询**：支持分页查询，避免一次性加载大量数据。
- **缓存机制**：通过 `@Cacheable` 注解实现数据缓存，减少数据库访问频率。

## 故障排除指南
### 常见问题及解决方案
- **问题**：创建银行登记失败
  - **原因**：输入参数验证失败或数据库连接问题
  - **解决方案**：检查输入参数是否符合要求，确认数据库连接正常

- **问题**：查询银行登记信息超时
  - **原因**：数据量过大或查询条件不合理
  - **解决方案**：优化查询条件，使用分页查询

**节源**  
- [BankRegistrationController.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/controller/admin/bankregistration/BankRegistrationController.java)
- [BankRegistrationServiceImpl.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/service/bankregistration/BankRegistrationServiceImpl.java)

## 结论
银行登记功能通过分层架构和模块化设计，实现了对公司银行账户、客户银行账户和供应商银行账户的全面管理。该功能不仅支持银行信息的创建和维护，还在收付款业务中发挥了重要作用。通过权限控制和安全保护措施，确保了数据的安全性和完整性。