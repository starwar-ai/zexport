# 客户管理

<cite>
**本文档引用的文件**
- [V1_0_0_002__Eplus初始化.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_002__Eplus初始化.sql)
- [CustApi.java](file://eplus-module-crm/eplus-module-crm-api/src/main/java/com/syj/eplus/module/crm/api/cust/CustApi.java)
- [CustService.java](file://eplus-module-crm/eplus-module-crm-biz/src/main/java/com/syj/eplus/module/crm/service/cust/CustService.java)
- [CustDO.java](file://eplus-module-crm/eplus-module-crm-biz/src/main/java/com/syj/eplus/module/crm/dal/dataobject/cust/CustDO.java)
- [CrmCategoryService.java](file://eplus-module-crm/eplus-module-crm-biz/src/main/java/com/syj/eplus/module/crm/service/category/CrmCategoryService.java)
- [CustomerStageEnum.java](file://eplus-module-crm/eplus-module-crm-api/src/main/java/com/syj/eplus/module/crm/enums/cust/CustomerStageEnum.java)
- [CustomerLevelEnum.java](file://eplus-framework/eplus-common/src/main/java/com/syj/eplus/framework/common/enums/CustomerLevelEnum.java)
- [SimpleCustRespVO.java](file://eplus-module-sms/eplus-module-sms-biz/src/main/java/com/syj/eplus/module/sms/controller/admin/salecontract/vo/SimpleContractRespVO.java)
</cite>

## 目录
1. [客户主数据模型设计](#客户主数据模型设计)
2. [客户分类体系](#客户分类体系)
3. [客户信用管理](#客户信用管理)
4. [客户与销售合同的关联关系](#客户与销售合同的关联关系)
5. [客户信息在销售流程中的应用](#客户信息在销售流程中的应用)
6. [客户管理业务流程](#客户管理业务流程)
7. [客户管理关键业务规则](#客户管理关键业务规则)

## 客户主数据模型设计

客户主数据模型是客户管理功能的核心，包含客户的基本信息、财务信息和联系人信息等关键数据。通过数据库表 `crm_cust` 实现客户信息的持久化存储。

```mermaid
erDiagram
crm_cust {
bigint id PK "主键"
int ver "版本号"
varchar(100) name "企业名称"
varchar(100) shortname "简称"
varchar(10) code "客户编号"
bigint country_id "国家编码"
varchar(100) homepage "官网"
varchar(100) email "电子邮件"
varchar(100) customer_types "客户类型"
tinyint stage_type "客户阶段"
varchar(3) currency "币种"
bigint settle_code "收款方式id"
tinyint transport_type "运输方式"
varchar(100) credit_limit "信用额度"
varchar(100) tax_number "税号"
varchar(255) address "地址"
varchar(100) phone "电话"
varchar(100) fax "传真"
varchar(100) website "网站"
varchar(100) industry "行业"
varchar(100) level "客户等级"
datetime create_time "创建时间"
datetime update_time "更新时间"
bit deleted "是否删除"
}
crm_cust_poc {
bigint id PK "主键"
bigint cust_id FK "客户ID"
varchar(100) name "联系人姓名"
varchar(100) position "职位"
varchar(100) phone "电话"
varchar(100) email "电子邮件"
varchar(100) department "部门"
bit primary_contact "是否为主要联系人"
datetime create_time "创建时间"
datetime update_time "更新时间"
}
crm_cust_bank_account {
bigint id PK "主键"
bigint cust_id FK "客户ID"
varchar(100) bank_name "银行名称"
varchar(100) account_number "银行账号"
varchar(100) swift_code "SWIFT代码"
varchar(100) iban "IBAN"
varchar(100) address "银行地址"
varchar(100) title "银行抬头"
bit default_account "是否为默认账户"
datetime create_time "创建时间"
datetime update_time "更新时间"
}
crm_cust_settlement {
bigint id PK "主键"
bigint cust_id FK "客户ID"
varchar(100) settlement_cycle "结算周期"
varchar(100) payment_terms "付款条件"
varchar(100) currency "币种"
varchar(100) tax_rate "税率"
datetime create_time "创建时间"
datetime update_time "更新时间"
}
crm_cust ||--o{ crm_cust_poc : "包含"
crm_cust ||--o{ crm_cust_bank_account : "包含"
crm_cust ||--o{ crm_cust_settlement : "包含"
```

**图示来源**
- [V1_0_0_002__Eplus初始化.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_002__Eplus初始化.sql#L49-L63)

**本节来源**
- [V1_0_0_002__Eplus初始化.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_002__Eplus初始化.sql#L49-L63)
- [CustDO.java](file://eplus-module-crm/eplus-module-crm-biz/src/main/java/com/syj/eplus/module/crm/dal/dataobject/cust/CustDO.java)

## 客户分类体系

客户分类体系是客户管理的重要组成部分，通过多维度的分类标准实现客户精细化管理。系统提供了客户类型、客户等级和行业分类等分类维度。

### 客户类型分类

客户类型定义了客户的业务属性，包括电商、进口商、零售商、贸易商、批发商、售后公司和邮购商等类型。这些类型通过 `customer_types` 字段在 `crm_cust` 表中存储。

### 客户等级分类

客户等级反映了客户的重要程度和价值，通过 `level` 字段在 `crm_cust` 表中存储。系统定义了不同的客户等级，如VIP客户、重要客户、普通客户等。

```mermaid
classDiagram
class CustomerLevelEnum {
+String VIP "VIP客户"
+String IMPORTANT "重要客户"
+String NORMAL "普通客户"
+String POTENTIAL "潜在客户"
}
```

**图示来源**
- [CustomerLevelEnum.java](file://eplus-framework/eplus-common/src/main/java/com/syj/eplus/framework/common/enums/CustomerLevelEnum.java)

### 客户阶段分类

客户阶段表示客户在生命周期中的状态，通过 `stage_type` 字段在 `crm_cust` 表中存储。系统定义了三种客户阶段：

```mermaid
classDiagram
class CustomerStageEnum {
+Integer POTENTIAL "潜在客户"
+Integer FORMAL "正式客户"
+Integer RETIRED "退休客户"
}
```

**图示来源**
- [CustomerStageEnum.java](file://eplus-module-crm/eplus-module-crm-api/src/main/java/com/syj/eplus/module/crm/enums/cust/CustomerStageEnum.java)

### 行业分类

行业分类用于按行业领域对客户进行分组，便于行业分析和市场策略制定。系统通过分类树形结构管理行业分类。

```mermaid
classDiagram
class CrmCategoryService {
+List<CrmCategorySimpleRespVO> getSimpleList()
+String getProfixCode(Long id)
+List<CrmCategoryDO> getListByIdList(List<Long> list)
+String getNameByIdList(List<Long> list)
+Map<Long, String> getCategroyNameMap(List<Long> list)
}
```

**图示来源**
- [CrmCategoryService.java](file://eplus-module-crm/eplus-module-crm-biz/src/main/java/com/syj/eplus/module/crm/service/category/CrmCategoryService.java)

**本节来源**
- [CustomerLevelEnum.java](file://eplus-framework/eplus-common/src/main/java/com/syj/eplus/framework/common/enums/CustomerLevelEnum.java)
- [CustomerStageEnum.java](file://eplus-module-crm/eplus-module-crm-api/src/main/java/com/syj/eplus/module/crm/enums/cust/CustomerStageEnum.java)
- [CrmCategoryService.java](file://eplus-module-crm/eplus-module-crm-biz/src/main/java/com/syj/eplus/module/crm/service/category/CrmCategoryService.java)

## 客户信用管理

客户信用管理机制确保了交易的安全性和风险控制，包括信用额度设置、使用情况跟踪和超限控制等功能。

### 信用额度设置

信用额度通过 `credit_limit` 字段在 `crm_cust` 表中存储，表示客户可使用的最大信用金额。系统支持为不同客户设置不同的信用额度。

### 信用额度使用跟踪

系统通过集成财务模块，实时跟踪客户的信用额度使用情况。当客户发生交易时，系统会自动计算已使用信用额度。

### 超限控制

系统实现了严格的超限控制机制，当客户信用额度即将或已经超限时，系统会触发相应的控制措施：

1. 在销售订单创建时进行信用检查
2. 对超限订单进行审批流程控制
3. 生成信用预警通知

```mermaid
flowchart TD
Start([开始]) --> CheckCredit["检查客户信用额度"]
CheckCredit --> CreditAvailable{"信用额度可用?"}
CreditAvailable --> |是| Proceed["继续交易流程"]
CreditAvailable --> |否| CheckThreshold{"超过阈值?"}
CheckThreshold --> |是| Approval["启动审批流程"]
CheckThreshold --> |否| Warning["发出信用预警"]
Approval --> ApprovalResult{"审批通过?"}
ApprovalResult --> |是| Proceed
ApprovalResult --> |否| Reject["拒绝交易"]
Warning --> Proceed
Proceed --> End([结束])
Reject --> End
```

**本节来源**
- [V1_0_0_002__Eplus初始化.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_002__Eplus初始化.sql#L49-L63)
- [CustService.java](file://eplus-module-crm/eplus-module-crm-biz/src/main/java/com/syj/eplus/module/crm/service/cust/CustService.java)

## 客户与销售合同的关联关系

客户信息与销售合同紧密关联，确保销售流程的完整性和一致性。系统通过客户编号在销售合同中引用客户信息。

### 客户信息在销售合同中的应用

在销售合同中，客户信息以精简形式呈现，包括客户编号、客户名称等关键信息。

```mermaid
classDiagram
class SimpleCustResp {
+String code "客户编号"
+String name "客户名称"
+String shortname "客户简称"
+String email "电子邮件"
+String phone "电话"
}
class SimpleContractRespVO {
+String code "合同编号"
+String custCode "客户编号"
+String custName "客户名称"
}
SimpleContractRespVO --> SimpleCustResp : "引用"
```

**图示来源**
- [SimpleCustResp.java](file://eplus-module-crm/eplus-module-crm-api/src/main/java/com/syj/eplus/module/crm/api/cust/dto/SimpleCustResp.java)
- [SimpleContractRespVO.java](file://eplus-module-sms/eplus-module-sms-biz/src/main/java/com/syj/eplus/module/sms/controller/admin/salecontract/vo/SimpleContractRespVO.java)

### 客户变更影响分析

当客户信息发生变更时，系统会分析变更对现有销售合同的影响范围。

```mermaid
sequenceDiagram
participant UI as "用户界面"
participant Controller as "CustController"
participant Service as "CustService"
participant BPM as "BPM引擎"
UI->>Controller : 提交客户变更
Controller->>Service : changeCust()
Service->>Service : getChangeEffect()
Service->>BPM : 启动审批流程
BPM-->>Service : 返回流程实例
Service-->>Controller : 返回结果
Controller-->>UI : 显示审批状态
```

**图示来源**
- [CustService.java](file://eplus-module-crm/eplus-module-crm-biz/src/main/java/com/syj/eplus/module/crm/service/cust/CustService.java#L51-L133)
- [CustApi.java](file://eplus-module-crm/eplus-module-crm-api/src/main/java/com/syj/eplus/module/crm/api/cust/CustApi.java#L61-L69)

**本节来源**
- [CustService.java](file://eplus-module-crm/eplus-module-crm-biz/src/main/java/com/syj/eplus/module/crm/service/cust/CustService.java)
- [CustApi.java](file://eplus-module-crm/eplus-module-crm-api/src/main/java/com/syj/eplus/module/crm/api/cust/CustApi.java)
- [SimpleContractRespVO.java](file://eplus-module-sms/eplus-module-sms-biz/src/main/java/com/syj/eplus/module/sms/controller/admin/salecontract/vo/SimpleContractRespVO.java)

## 客户信息在销售流程中的应用

客户信息贯穿整个销售流程，从客户选择到合同创建，再到订单执行，确保销售活动的准确性和效率。

### 客户选择与验证

在销售流程开始时，系统提供客户选择功能，支持通过客户编号、名称等条件进行搜索和筛选。

```mermaid
flowchart TD
Start([销售流程开始]) --> SelectCustomer["选择客户"]
SelectCustomer --> ValidateCustomer["验证客户状态"]
ValidateCustomer --> ActiveCustomer{"客户是否启用?"}
ActiveCustomer --> |是| CheckCredit["检查信用额度"]
ActiveCustomer --> |否| Reject["选择其他客户"]
CheckCredit --> CreditAvailable{"信用额度充足?"}
CreditAvailable --> |是| CreateContract["创建销售合同"]
CreditAvailable --> |否| Review["审查信用状况"]
Review --> Approval["启动信用审批"]
Approval --> ApprovalResult{"审批通过?"}
ApprovalResult --> |是| CreateContract
ApprovalResult --> |否| Reject
CreateContract --> End([销售流程继续])
Reject --> End
```

### 客户信息自动填充

当选择客户后，系统自动填充客户的相关信息，减少手动输入错误。

**本节来源**
- [CustService.java](file://eplus-module-crm/eplus-module-crm-biz/src/main/java/com/syj/eplus/module/crm/service/cust/CustService.java)
- [CustApi.java](file://eplus-module-crm/eplus-module-crm-api/src/main/java/com/syj/eplus/module/crm/api/cust/CustApi.java)

## 客户管理业务流程

客户管理业务流程涵盖了客户从创建到维护的完整生命周期，包括客户创建、变更、启用/禁用等操作。

### 客户创建流程

```mermaid
sequenceDiagram
participant User as "用户"
participant UI as "用户界面"
participant Controller as "CustController"
participant Service as "CustService"
User->>UI : 填写客户信息
UI->>Controller : createCust()
Controller->>Service : createCust()
Service->>Service : 验证客户信息
Service->>Service : 检查客户名称重复
Service->>Service : 生成客户编号
Service->>Service : 保存客户信息
Service-->>Controller : 返回客户ID
Controller-->>UI : 显示创建成功
UI-->>User : 显示客户详情
```

**图示来源**
- [CustService.java](file://eplus-module-crm/eplus-module-crm-biz/src/main/java/com/syj/eplus/module/crm/service/cust/CustService.java#L37-L38)

### 客户变更流程

```mermaid
sequenceDiagram
participant User as "用户"
participant UI as "用户界面"
participant Controller as "CustController"
participant Service as "CustService"
participant BPM as "BPM引擎"
User->>UI : 提交客户变更
UI->>Controller : changeCust()
Controller->>Service : changeCust()
Service->>Service : 创建变更记录
Service->>Service : 分析变更影响
Service->>BPM : 启动变更审批流程
BPM-->>Service : 返回流程ID
Service-->>Controller : 返回结果
Controller-->>UI : 显示审批状态
UI-->>User : 显示流程进度
```

**图示来源**
- [CustService.java](file://eplus-module-crm/eplus-module-crm-biz/src/main/java/com/syj/eplus/module/crm/service/cust/CustService.java#L51-L58)

### 客户启用/禁用流程

```mermaid
sequenceDiagram
participant User as "用户"
participant UI as "用户界面"
participant Controller as "CustController"
participant Service as "CustService"
User->>UI : 请求启用客户
UI->>Controller : enableCust(id)
Controller->>Service : enableCust(id)
Service->>Service : 验证客户状态
Service->>Service : 更新客户状态
Service->>Service : 记录操作日志
Service-->>Controller : 返回结果
Controller-->>UI : 显示操作结果
UI-->>User : 显示客户状态
```

**图示来源**
- [CustService.java](file://eplus-module-crm/eplus-module-crm-biz/src/main/java/com/syj/eplus/module/crm/service/cust/CustService.java#L222-L229)

**本节来源**
- [CustService.java](file://eplus-module-crm/eplus-module-crm-biz/src/main/java/com/syj/eplus/module/crm/service/cust/CustService.java)

## 客户管理关键业务规则

客户管理功能包含一系列关键业务规则，确保数据的准确性、一致性和安全性。

### 客户信息变更审批规则

客户信息变更需要经过审批流程，确保变更的合法性和准确性。系统通过BPM引擎实现审批流程。

```mermaid
stateDiagram-v2
[*] --> Draft
Draft --> PendingApproval : submitTask()
PendingApproval --> Approved : approveTask()
PendingApproval --> Rejected : rejectTask()
Approved --> Active : changeSuccess()
Rejected --> Draft : 修改后重新提交
Active --> [*]
```

**图示来源**
- [CustService.java](file://eplus-module-crm/eplus-module-crm-biz/src/main/java/com/syj/eplus/module/crm/service/cust/CustService.java#L141-L149)

### 客户状态管理规则

客户状态管理规则定义了客户在不同状态间的转换条件和操作限制。

```mermaid
stateDiagram-v2
[*] --> Potential
Potential --> Formal : convertCust()
Formal --> Retired : disableCust()
Retired --> Formal : enableCust()
Formal --> [*]
```

**图示来源**
- [CustService.java](file://eplus-module-crm/eplus-module-crm-biz/src/main/java/com/syj/eplus/module/crm/service/cust/CustService.java#L215-L230)

### 客户信息重复检查规则

系统在创建客户时执行重复检查，防止创建重复的客户记录。

```mermaid
flowchart TD
Start([创建客户]) --> CheckDuplicate["检查客户名称重复"]
CheckDuplicate --> HasDuplicate{"存在相似名称?"}
HasDuplicate --> |是| ShowWarning["显示相似客户列表"]
HasDuplicate --> |否| Continue["继续创建流程"]
ShowWarning --> Confirm["确认是否继续"]
Confirm --> UserConfirm{"用户确认?"}
UserConfirm --> |是| Continue
UserConfirm --> |否| Abort["中止创建"]
Continue --> Save["保存客户信息"]
Save --> End([客户创建完成])
Abort --> End
```

**本节来源**
- [CustService.java](file://eplus-module-crm/eplus-module-crm-biz/src/main/java/com/syj/eplus/module/crm/service/cust/CustService.java)