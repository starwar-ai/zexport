# 测试

<cite>
**本文档引用的文件**
- [README.md](file://README.md)
- [eplus-framework/README.md](file://eplus-framework/README.md)
- [eplus-flyway/pom.xml](file://eplus-flyway/pom.xml)
- [eplus-framework/eplus-common/pom.xml](file://eplus-framework/eplus-common/pom.xml)
- [eplus-module-crm/eplus-module-crm-biz/pom.xml](file://eplus-module-crm/eplus-module-crm-biz/pom.xml)
- [eplus-module-dms/eplus-module-dms-biz/pom.xml](file://eplus-module-dms/eplus-module-dms-biz/pom.xml)
- [eplus-module-oa/eplus-module-oa-biz/pom.xml](file://eplus-module-oa/eplus-module-oa-biz/pom.xml)
- [yudao-framework/yudao-spring-boot-starter-test/pom.xml](file://yudao-framework/yudao-spring-boot-starter-test/pom.xml)
- [eplus-module-social/src/test/java/com/syj/eplus/module/wechat/service/WechatServiceImplTest.java](file://eplus-module-social/src/test/java/com/syj/eplus/module/wechat/service/WechatServiceImplTest.java)
- [eplus-module-oa/eplus-module-oa-biz/src/main/test/java/com/syj/eplus/module/oa/job/TravelappJobTest.java](file://eplus-module-oa/eplus-module-oa-biz/src/main/test/java/com/syj/eplus/module/oa/job/TravelappJobTest.java)
- [eplus-framework/eplus-common/src/test/java/com/syj/eplus/framework/common/util/MoneyUtilTest.java](file://eplus-framework/eplus-common/src/test/java/com/syj/eplus/framework/common/util/MoneyUtilTest.java)
- [eplus-module-report/eplus-module-report-biz/src/test/java/com/syj/eplus/module/system/service/report/ReportServiceImplTest.java](file://eplus-module-report/eplus-module-report-biz/src/test/java/com/syj/eplus/module/system/service/report/ReportServiceImplTest.java)
</cite>

## 目录
1. [引言](#引言)
2. [测试策略概述](#测试策略概述)
3. [单元测试](#单元测试)
4. [集成测试](#集成测试)
5. [端到端测试](#端到端测试)
6. [测试覆盖率](#测试覆盖率)
7. [测试数据管理](#测试数据管理)
8. [常用测试工具与框架](#常用测试工具与框架)
9. [编写高质量测试用例的技巧](#编写高质量测试用例的技巧)
10. [结论](#结论)

## 引言

本测试文档旨在全面阐述 eplus-admin-server 项目中的测试策略与实践。该项目是一个基于 Spring Boot 的企业级 ERP 管理系统，涵盖供应链、销售、仓储、财务等多个核心业务领域。为确保系统的稳定性、可靠性和可维护性，建立了一套完善的测试体系。本文档将详细介绍单元测试、集成测试和端到端测试的编写规范、配置方法和最佳实践，并提供测试覆盖率目标、测试数据管理策略以及常用工具的使用指南。

**本文档引用的文件**
- [README.md](file://README.md#L505-L527)

## 测试策略概述

eplus-admin-server 项目采用分层测试策略，主要包括单元测试、集成测试和端到端测试。这种分层方法能够从不同粒度和层面验证代码的正确性。

- **单元测试 (Unit Testing)**：针对代码的最小可测试单元（通常是单个方法或类）进行测试，确保其逻辑正确。项目中广泛使用 Mockito 进行依赖模拟，以隔离被测单元。
- **集成测试 (Integration Testing)**：验证多个单元或组件协同工作时的行为，特别是与数据库、缓存等外部系统的交互。项目利用 H2 内存数据库和内嵌 Redis 来进行高效的数据库集成测试。
- **端到端测试 (End-to-End Testing)**：模拟真实用户场景，从用户界面或 API 入口开始，贯穿整个应用层、服务层和数据层，验证系统整体功能是否符合预期。

测试框架主要依赖于 `yudao-spring-boot-starter-test`，它封装了 Spring Boot Test、Mockito、H2、Jedis-Mock 等核心测试库，为开发者提供了开箱即用的测试环境。

**本文档引用的文件**
- [README.md](file://README.md#L505-L527)
- [yudao-framework/yudao-spring-boot-starter-test/pom.xml](file://yudao-framework/yudao-spring-boot-starter-test/pom.xml)

## 单元测试

单元测试是保证代码质量的第一道防线。在 eplus-admin-server 项目中，单元测试遵循以下规范和最佳实践。

### 编写规范与最佳实践

1.  **测试命名**：采用 `方法名_场景_预期结果` 的命名规范，例如 `createUser_WhenValidInput_ReturnsSuccess`。这使得测试意图清晰明了。
2.  **测试结构**：遵循 AAA (Arrange, Act, Assert) 模式。
    - **Arrange (准备)**：设置测试所需的数据和对象，包括使用 Mockito 模拟依赖。
    - **Act (执行)**：调用被测试的方法。
    - **Assert (断言)**：验证方法的执行结果是否符合预期。
3.  **隔离性**：每个测试用例必须是独立的，不依赖于其他测试的执行顺序或状态。测试结束后，所有模拟对象和状态都应被重置。
4.  **单一职责**：一个测试用例只验证一个特定的行为或场景。

### 使用 Mockito 进行依赖模拟

Mockito 是项目中用于创建和管理模拟对象的核心库。通过模拟依赖，可以将被测单元与外部系统（如数据库、网络服务）隔离开来，从而专注于单元本身的逻辑。

**示例**：
在 `WechatServiceImplTest` 中，`WechatServiceImpl` 依赖于 `WechatService` 接口。在单元测试中，可以使用 Mockito 创建一个模拟的 `WechatService`，并预设其方法的返回值，从而测试 `WechatServiceImpl` 在不同返回值下的行为。

```java
// 示例代码结构，非实际内容
@ExtendWith(MockitoExtension.class)
public class WechatServiceImplTest {

    @Mock
    private WechatService wechatService; // 模拟依赖

    @InjectMocks
    private WechatServiceImpl wechatServiceImpl; // 被测试的实例

    @Test
    public void testSomeMethod() {
        // Arrange: 预设模拟对象的行为
        when(wechatService.someApiCall()).thenReturn(expectedResponse);

        // Act: 执行被测方法
        Result result = wechatServiceImpl.methodToTest();

        // Assert: 验证结果
        assertEquals(expectedResult, result);
    }
}
```

**本文档引用的文件**
- [eplus-module-social/src/test/java/com/syj/eplus/module/wechat/service/WechatServiceImplTest.java](file://eplus-module-social/src/test/java/com/syj/eplus/module/wechat/service/WechatServiceImplTest.java#L10-L21)
- [yudao-framework/yudao-spring-boot-starter-test/pom.xml](file://yudao-framework/yudao-spring-boot-starter-test/pom.xml#L37-L38)

## 集成测试

集成测试用于验证业务逻辑与数据库、缓存等持久层的交互是否正确。eplus-admin-server 项目通过 `yudao-spring-boot-starter-test` 提供的工具简化了集成测试的配置。

### 配置与执行方式

1.  **测试环境**：集成测试使用 H2 内存数据库作为数据源。H2 数据库启动速度快，且数据在测试结束后自动销毁，保证了测试的纯净性和独立性。
2.  **事务管理**：为了确保测试数据的隔离性，每个集成测试方法通常运行在一个数据库事务中。该事务在测试方法执行完毕后会自动回滚，从而避免了测试数据对数据库的污染。这可以通过 `@Transactional` 和 `@Rollback` 注解来实现。
3.  **依赖注入**：使用 `@SpringBootTest` 注解加载整个 Spring 应用上下文，以便测试中可以注入真实的 `Service` 和 `Mapper` 实例。

**示例**：
`ReportServiceImplTest` 是一个典型的集成测试类。它会启动 Spring Boot 应用，加载 `ReportServiceImpl` 及其依赖的 `Mapper`，然后使用真实的数据库操作来验证服务层的业务逻辑。

```java
// 示例代码结构，非实际内容
@SpringBootTest
@Transactional
@Rollback
class ReportServiceImplTest {

    @Autowired
    private ReportServiceImpl reportService;

    @Test
    void testGenerateReport() {
        // Arrange: 准备测试数据
        ReportQuery query = new ReportQuery(...);

        // Act: 调用服务方法，该方法会执行数据库查询
        ReportData data = reportService.generateReport(query);

        // Assert: 验证返回的数据是否正确
        assertNotNull(data);
        assertEquals(expectedSize, data.getItems().size());
    }
}
```

**本文档引用的文件**
- [eplus-module-report/eplus-module-report-biz/src/test/java/com/syj/eplus/module/system/service/report/ReportServiceImplTest.java](file://eplus-module-report/eplus-module-report-biz/src/test/java/com/syj/eplus/module/system/service/report/ReportServiceImplTest.java)
- [yudao-framework/yudao-spring-boot-starter-test/pom.xml](file://yudao-framework/yudao-spring-boot-starter-test/pom.xml#L46-L48)

## 端到端测试

端到端测试（E2E）是验证系统整体功能的最终手段。它模拟真实用户的操作流程，从 API 请求开始，经过控制器、服务层，最终与数据库交互并返回响应。

### 范围与实施方法

1.  **测试范围**：端到端测试覆盖核心业务流程，例如“创建销售订单”、“提交费用报销”、“生成财务报表”等。它验证的是整个业务链路的正确性，包括参数校验、权限控制、业务逻辑处理和数据持久化。
2.  **实施方法**：
    - **API 测试**：使用 `@WebMvcTest` 或 `@RestClientTest` 等注解，仅加载 Web 层，通过 `MockMvc` 或 `TestRestTemplate` 发送 HTTP 请求，验证 API 的响应状态码、响应体和头信息。
    - **全栈测试**：使用 `@SpringBootTest` 加载完整的应用上下文，通过 `TestRestTemplate` 或 `WebTestClient` 对运行中的应用发起真实的 HTTP 请求。这种方式最接近生产环境，但执行速度较慢。
3.  **数据准备**：端到端测试通常需要更复杂的测试数据。可以使用 `@Sql` 注解在测试前执行 SQL 脚本来初始化数据，或在测试代码中通过服务层 API 来创建前置数据。

**本文档引用的文件**
- [README.md](file://README.md#L505-L527)

## 测试覆盖率

测试覆盖率是衡量测试完整性的重要指标。它帮助团队识别未被测试覆盖的代码路径，从而提高代码质量。

### 目标与测量方法

1.  **覆盖率目标**：项目设定的测试覆盖率目标为 **>70%**。这个目标涵盖了行覆盖率（Line Coverage）和分支覆盖率（Branch Coverage）。对于核心模块和工具类，建议追求更高的覆盖率（如 >80%）。
2.  **测量方法**：
    - **JaCoCo (Java Code Coverage)**：项目使用 JaCoCo 作为代码覆盖率工具。它可以通过 Maven 插件（`jacoco-maven-plugin`）在执行 `mvn test` 命令时自动生成覆盖率报告。
    - **报告生成**：执行 `mvn clean test jacoco:report` 命令后，JaCoCo 会生成 HTML 格式的报告，通常位于 `target/site/jacoco/` 目录下。报告中会以不同颜色高亮显示已覆盖、部分覆盖和未覆盖的代码行。
    - **集成 CI/CD**：建议将覆盖率检查集成到持续集成（CI）流程中，当覆盖率低于阈值时，构建失败，从而强制保证代码质量。

**本文档引用的文件**
- [README.md](file://README.md#L521-L527)

## 测试数据管理

有效的测试数据管理是保证测试稳定性和可重复性的关键。

### 策略

1.  **数据库初始化**：
    - **Flyway**：项目使用 Flyway 进行数据库版本管理。在执行集成测试前，Flyway 会自动应用所有迁移脚本，确保数据库结构是最新的。
    - **测试专用脚本**：在 `eplus-flyway` 模块的 `src/main/resources/db/migration/test` 目录下，可以存放专门用于测试环境的 SQL 脚本，用于插入测试所需的静态数据或配置。
2.  **测试数据清理**：
    - **事务回滚**：如前所述，使用 `@Transactional` 和 `@Rollback` 是最简单有效的清理方式，它能自动回滚测试中产生的所有数据变更。
    - **Podam**：`yudao-spring-boot-starter-test` 引入了 Podam 库，它可以为 POJO 对象随机生成符合约束的数据。这有助于快速创建大量测试数据，同时避免了硬编码数据带来的维护问题。
    - **`@Sql` 注解**：可以使用 `@Sql(scripts = "/cleanup.sql", executionPhase = Sql.ExecutionPhase.AFTER_TEST_METHOD)` 在测试方法执行后执行清理脚本。

**本文档引用的文件**
- [eplus-flyway/pom.xml](file://eplus-flyway/pom.xml#L32-L42)
- [yudao-framework/yudao-spring-boot-starter-test/pom.xml](file://yudao-framework/yudao-spring-boot-starter-test/pom.xml#L56-L58)

## 常用测试工具与框架

eplus-admin-server 项目通过 `yudao-spring-boot-starter-test` 统一集成了以下核心测试工具和框架：

| 工具/框架 | 用途 | 说明 |
| :--- | :--- | :--- |
| **Spring Boot Test** | 测试基础 | 提供 `@SpringBootTest`, `@WebMvcTest` 等核心注解，用于加载 Spring 上下文和进行 Web 层测试。 |
| **Mockito** | 依赖模拟 | 用于创建模拟对象（Mock），预设其行为，并验证方法调用。是单元测试的核心。 |
| **H2 Database** | 内存数据库 | 作为集成测试的数据库，速度快，无需外部依赖，数据在内存中，测试后自动销毁。 |
| **Jedis-Mock** | 内嵌 Redis | 用于模拟 Redis 服务器，使得与 Redis 的交互可以在无真实 Redis 服务的情况下进行测试。 |
| **Podam** | 数据生成 | 自动为 Java Bean 生成随机但有效的测试数据，减少手动创建测试数据的工作量。 |

**本文档引用的文件**
- [yudao-framework/yudao-spring-boot-starter-test/pom.xml](file://yudao-framework/yudao-spring-boot-starter-test/pom.xml)

## 编写高质量测试用例的技巧

1.  **保持测试用例简短**：一个测试用例只关注一个特定的场景。过长的测试用例难以阅读和维护。
2.  **使用有意义的断言**：断言信息应清晰地描述预期结果，例如 `assertEquals("User name should be 'John'", "John", user.getName())`。
3.  **避免测试逻辑**：测试代码本身应尽可能简单，避免在测试中使用复杂的条件判断或循环，这会增加测试本身的出错风险。
4.  **测试边界条件**：不仅要测试正常流程，还要重点测试边界值、空值、异常输入等边界条件。
5.  **定期重构测试**：随着业务代码的演进，测试代码也需要同步更新和重构，以保持其有效性和可读性。

## 结论

eplus-admin-server 项目建立了一套健全的测试体系，涵盖了从单元到端到端的各个层面。通过使用 `yudao-spring-boot-starter-test` 统一的测试框架，结合 Mockito、H2、JaCoCo 等成熟工具，开发者可以高效地编写和执行测试。遵循本文档中的规范和最佳实践，能够有效提升代码质量，降低系统风险，为项目的长期稳定运行提供坚实保障。