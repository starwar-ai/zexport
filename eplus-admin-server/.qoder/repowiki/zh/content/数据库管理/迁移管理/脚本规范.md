# 脚本规范

<cite>
**本文档引用的文件**
- [V1_0_0_001__框架初始化.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_001__框架初始化.sql)
- [V1_0_0_002__Eplus初始化.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_002__Eplus初始化.sql)
- [R__字典相关.sql](file://eplus-flyway/src/main/resources/db/migration/common/R__字典相关.sql)
- [afterMigrateError__清除失败的运行记录.sql](file://eplus-flyway/src/main/resources/db/migration/common/afterMigrateError__清除失败的运行记录.sql)
</cite>

## 目录
1. [引言](#引言)
2. [命名规则](#命名规则)
3. [文件结构](#文件结构)
4. [SQL语句编写标准](#sql语句编写标准)
5. [事务管理与错误处理](#事务管理与错误处理)
6. [脚本模板与示例](#脚本模板与示例)
7. [脚本审核清单](#脚本审核清单)
8. [结论](#结论)

## 引言

本文档旨在为数据库迁移脚本的编写提供全面的规范指导。通过分析现有代码库中的迁移脚本，我们将详细介绍迁移脚本的命名规则、文件结构、内容要求以及最佳实践。文档将涵盖版本号命名规范、SQL语句编写标准、事务管理、错误处理和数据一致性保障措施，并提供实用的脚本模板和审核清单，帮助开发人员创建高质量的迁移脚本。

**Section sources**
- [V1_0_0_001__框架初始化.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_001__框架初始化.sql)
- [V1_0_0_002__Eplus初始化.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_002__Eplus初始化.sql)

## 命名规则

数据库迁移脚本的命名遵循严格的规范，以确保版本控制的清晰性和可追溯性。命名模式为`V{主版本号}_{次版本号}_{修订号}_{序列号}__{描述性名称}.sql`。

- **V**: 表示版本化脚本（Versioned Script），与可重复执行的脚本（Repeatable Script）相区别。
- **主版本号、次版本号、修订号**: 用于标识应用程序的主要版本、次要版本和修订版本。
- **序列号**: 三位数字，用于在同一版本内对多个脚本进行排序。
- **双下划线 (__)**: 分隔版本信息和描述性名称。
- **描述性名称**: 使用中文描述脚本的主要功能，便于理解和维护。

例如，`V1_0_0_001__框架初始化.sql`表示这是1.0.0版本的第一个脚本，用于框架的初始化。

**Section sources**
- [V1_0_0_001__框架初始化.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_001__框架初始化.sql)
- [V1_0_0_002__Eplus初始化.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_002__Eplus初始化.sql)

## 文件结构

迁移脚本通常位于`eplus-flyway/src/main/resources/db/migration/common/`目录下。脚本文件的结构应清晰，包含必要的SQL语句和注释。

### 基本结构

1. **字符集和外键设置**:
   ```sql
   SET NAMES utf8mb4;
   SET FOREIGN_KEY_CHECKS = 0;
   ```

2. **表结构定义**:
   使用`DROP TABLE IF EXISTS`和`CREATE TABLE`语句来定义表结构，确保脚本可以重复执行。

3. **数据初始化**:
   使用`INSERT INTO`语句插入初始数据。

4. **事务控制**:
   对于数据修改操作，使用`BEGIN;`和`COMMIT;`来包裹，确保数据一致性。

**Section sources**
- [V1_0_0_001__框架初始化.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_001__框架初始化.sql)
- [R__字典相关.sql](file://eplus-flyway/src/main/resources/db/migration/common/R__字典相关.sql)

## SQL语句编写标准

### DDL操作最佳实践

- **使用`IF EXISTS`和`IF NOT EXISTS`**: 避免因表或列已存在而导致的错误。
- **明确指定字符集和排序规则**: 如`CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci`。
- **使用`AUTO_INCREMENT`**: 为自增主键指定起始值。
- **添加注释**: 使用`COMMENT`关键字为表和列添加描述。

### DML操作最佳实践

- **批量插入**: 使用单个`INSERT INTO`语句插入多行数据，提高效率。
- **避免硬编码**: 使用参数化查询或配置文件来管理常量。
- **数据类型匹配**: 确保插入的数据类型与表定义一致。

**Section sources**
- [V1_0_0_001__框架初始化.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_001__框架初始化.sql)
- [R__字典相关.sql](file://eplus-flyway/src/main/resources/db/migration/common/R__字典相关.sql)

## 事务管理与错误处理

### 事务管理

对于涉及多个表或复杂逻辑的数据修改操作，必须使用事务来保证数据的一致性。

```sql
BEGIN;
-- 多个SQL操作
INSERT INTO table1 VALUES (...);
UPDATE table2 SET ...;
COMMIT;
```

### 错误处理

- **使用`IGNORE`关键字**: 在删除操作中使用`DELETE IGNORE`可以忽略因外键约束等原因导致的错误。
- **错误恢复脚本**: 提供专门的脚本来清理失败的迁移记录，如`afterMigrateError__清除失败的运行记录.sql`。

```sql
-- 清理flyway元数据表中失败的执行记录
DELETE IGNORE FROM `${flyway-table}` WHERE success = 0;
```

**Section sources**
- [R__字典相关.sql](file://eplus-flyway/src/main/resources/db/migration/common/R__字典相关.sql)
- [afterMigrateError__清除失败的运行记录.sql](file://eplus-flyway/src/main/resources/db/migration/common/afterMigrateError__清除失败的运行记录.sql)

## 脚本模板与示例

### 模板

```sql
SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ----------------------------
-- Table structure for {table_name}
-- ----------------------------
DROP TABLE IF EXISTS `{table_name}`;
CREATE TABLE `{table_name}`
(
    `id`          bigint NOT NULL AUTO_INCREMENT COMMENT '主键',
    -- 其他字段定义
    `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `deleted`     bit(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
    PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 1 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci COMMENT = '{table_comment}';

-- ----------------------------
-- Records of {table_name}
-- ----------------------------
BEGIN;
INSERT INTO `{table_name}` VALUES (...);
COMMIT;
```

### 示例

```sql
-- 创建客户表
DROP TABLE IF EXISTS `crm_cust`;
CREATE TABLE `crm_cust`
(
    `id`          bigint NOT NULL AUTO_INCREMENT COMMENT '主键',
    `name`        varchar(100) NOT NULL COMMENT '企业名称',
    `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    `deleted`     bit(1) NOT NULL DEFAULT b'0' COMMENT '是否删除',
    PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB AUTO_INCREMENT = 1 CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci COMMENT = '客户资料表';
```

**Section sources**
- [V1_0_0_001__框架初始化.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_001__框架初始化.sql)
- [V1_0_0_002__Eplus初始化.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_002__Eplus初始化.sql)

## 脚本审核清单

在提交迁移脚本之前，请使用以下清单进行审核：

- [ ] 脚本命名符合规范
- [ ] 包含必要的字符集和外键设置
- [ ] 使用`DROP TABLE IF EXISTS`和`CREATE TABLE`确保可重复执行
- [ ] 字段定义完整，包含主键、创建时间、更新时间和删除标记
- [ ] 数据初始化操作使用`BEGIN;`和`COMMIT;`包裹
- [ ] 避免硬编码，使用参数化查询
- [ ] 添加了足够的注释
- [ ] 经过充分的测试，确保在目标环境中可以正确执行

**Section sources**
- [V1_0_0_001__框架初始化.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_001__框架初始化.sql)
- [R__字典相关.sql](file://eplus-flyway/src/main/resources/db/migration/common/R__字典相关.sql)

## 结论

遵循本文档中的规范和最佳实践，开发人员可以创建出高质量、可维护的数据库迁移脚本。这不仅有助于确保数据库结构的一致性和数据的完整性，还能提高团队协作的效率。通过使用提供的模板和审核清单，可以进一步减少错误，加快开发和部署过程。