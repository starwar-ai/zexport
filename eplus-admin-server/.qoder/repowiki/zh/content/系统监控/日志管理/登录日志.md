# 登录日志

<cite>
**本文档引用文件**   
- [LoginLogApiImpl.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/api/logger/LoginLogApiImpl.java)
- [LoginLogServiceImpl.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/service/logger/LoginLogServiceImpl.java)
- [LoginLogMapper.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/dal/mysql/logger/LoginLogMapper.java)
- [LoginLogService.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/service/logger/LoginLogService.java)
- [LoginLogDO.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/dal/dataobject/logger/LoginLogDO.java)
- [LoginLogCreateReqDTO.java](file://yudao-module-system/yudao-module-system-api/src/main/java/cn/iocoder/yudao/module/system/api/logger/dto/LoginLogCreateReqDTO.java)
- [LoginLogTypeEnum.java](file://yudao-module-system/yudao-module-system-api/src/main/java/cn/iocoder/yudao/module/system/enums/logger/LoginLogTypeEnum.java)
- [LoginResultEnum.java](file://yudao-module-system/yudao-module-system-api/src/main/java/cn/iocoder/yudao/module/system/enums/logger/LoginResultEnum.java)
- [AdminAuthServiceImpl.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/service/auth/AdminAuthServiceImpl.java)
- [IPUtils.java](file://yudao-framework/yudao-spring-boot-starter-ip/src/main/java/cn/iocoder/yudao/framework/ip/core/utils/IPUtils.java)
- [AreaUtils.java](file://yudao-framework/yudao-spring-boot-starter-ip/src/main/java/cn/iocoder/yudao/framework/ip/core/utils/AreaUtils.java)
- [Area.java](file://yudao-framework/yudao-spring-boot-starter-ip/src/main/java/cn/iocoder/yudao/framework/ip/core/Area.java)
- [system_login_log.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_001__框架初始化.sql)
</cite>

## 目录
1. [简介](#简介)
2. [登录日志数据结构](#登录日志数据结构)
3. [登录日志记录机制](#登录日志记录机制)
4. [异常登录检测与安全审计](#异常登录检测与安全审计)
5. [IP地址解析与地理信息](#ip地址解析与地理信息)
6. [登录日志统计分析](#登录日志统计分析)
7. [系统集成与归档策略](#系统集成与归档策略)

## 简介
登录日志系统全面记录和分析用户登录行为，包括登录、登出和登录失败事件。系统捕获用户的IP地址、设备信息和登录结果，提供异常登录检测、安全审计和统计分析功能。通过与第三方安全系统的集成，实现全面的安全监控和长期数据归档。

## 登录日志数据结构
登录日志系统的核心数据结构定义了记录用户登录行为所需的所有信息字段。

### 登录日志数据库表结构
登录日志存储在 `system_login_log` 表中，包含以下字段：

```mermaid
erDiagram
system_login_log {
bigint id PK "访问ID"
bigint log_type "日志类型"
varchar(64) trace_id "链路追踪编号"
bigint user_id "用户编号"
tinyint user_type "用户类型"
varchar(50) username "用户账号"
tinyint result "登陆结果"
varchar(50) user_ip "用户 IP"
varchar(512) user_agent "浏览器 UA"
varchar(64) creator "创建者"
datetime create_time "创建时间"
varchar(64) updater "更新者"
datetime update_time "更新时间"
bit(1) deleted "是否删除"
bigint tenant_id "租户编号"
}
```

**图示来源**
- [system_login_log.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_001__框架初始化.sql#L213-L235)

### 登录日志数据对象
`LoginLogDO` 类定义了登录日志的数据对象，与数据库表结构对应。

```mermaid
classDiagram
class LoginLogDO {
+Long id
+Integer logType
+String traceId
+Long userId
+Integer userType
+String username
+Integer result
+String userIp
+String userAgent
}
```

**图示来源**
- [LoginLogDO.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/dal/dataobject/logger/LoginLogDO.java#L1-L72)

### 登录结果枚举
`LoginResultEnum` 枚举定义了所有可能的登录结果。

```mermaid
classDiagram
class LoginResultEnum {
+SUCCESS(0)
+BAD_CREDENTIALS(10)
+USER_DISABLED(20)
+CAPTCHA_NOT_FOUND(30)
+CAPTCHA_CODE_ERROR(31)
}
```

**图示来源**
- [LoginResultEnum.java](file://yudao-module-system/yudao-module-system-api/src/main/java/cn/iocoder/yudao/module/system/enums/logger/LoginResultEnum.java#L1-L26)

### 登录类型枚举
`LoginLogTypeEnum` 枚举定义了所有可能的登录类型。

```mermaid
classDiagram
class LoginLogTypeEnum {
+LOGIN_USERNAME(100)
+LOGIN_SOCIAL(101)
+LOGIN_MOBILE(103)
+LOGIN_SMS(104)
+LOGOUT_SELF(200)
+LOGOUT_DELETE(202)
}
```

**图示来源**
- [LoginLogTypeEnum.java](file://yudao-module-system/yudao-module-system-api/src/main/java/cn/iocoder/yudao/module/system/enums/logger/LoginLogTypeEnum.java#L1-L27)

## 登录日志记录机制
登录日志系统通过一系列服务和接口实现用户登录行为的记录。

### 登录日志服务接口
`LoginLogService` 接口定义了登录日志的核心操作。

```mermaid
classDiagram
class LoginLogService {
+PageResult<LoginLogDO> getLoginLogPage(LoginLogPageReqVO pageReqVO)
+void createLoginLog(LoginLogCreateReqDTO reqDTO)
}
```

**图示来源**
- [LoginLogService.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/service/logger/LoginLogService.java#L1-L30)

### 登录日志服务实现
`LoginLogServiceImpl` 类实现了登录日志服务接口，负责具体的业务逻辑。

```mermaid
classDiagram
class LoginLogServiceImpl {
-LoginLogMapper loginLogMapper
+PageResult<LoginLogDO> getLoginLogPage(LoginLogPageReqVO pageReqVO)
+void createLoginLog(LoginLogCreateReqDTO reqDTO)
}
```

**图示来源**
- [LoginLogServiceImpl.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/service/logger/LoginLogServiceImpl.java#L1-L35)

### 登录日志数据访问
`LoginLogMapper` 接口定义了与数据库交互的方法。

```mermaid
classDiagram
class LoginLogMapper {
+PageResult<LoginLogDO> selectPage(LoginLogPageReqVO reqVO)
}
```

**图示来源**
- [LoginLogMapper.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/dal/mysql/logger/LoginLogMapper.java#L1-L28)

### 登录日志API接口
`LoginLogApiImpl` 类提供了登录日志的API实现。

```mermaid
classDiagram
class LoginLogApiImpl {
-LoginLogService loginLogService
+void createLoginLog(LoginLogCreateReqDTO reqDTO)
}
```

**图示来源**
- [LoginLogApiImpl.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/api/logger/LoginLogApiImpl.java#L1-L27)

### 登录日志创建请求DTO
`LoginLogCreateReqDTO` 类定义了创建登录日志所需的请求数据。

```mermaid
classDiagram
class LoginLogCreateReqDTO {
+Integer logType
+String traceId
+Long userId
+Integer userType
+String username
+Integer result
+String userIp
+String userAgent
}
```

**图示来源**
- [LoginLogCreateReqDTO.java](file://yudao-module-system/yudao-module-system-api/src/main/java/cn/iocoder/yudao/module/system/api/logger/dto/LoginLogCreateReqDTO.java#L1-L62)

### 登录日志记录流程
当用户进行登录操作时，系统通过认证服务记录登录日志。

```mermaid
sequenceDiagram
participant User as "用户"
participant AuthService as "认证服务"
participant LoginLogService as "登录日志服务"
participant Database as "数据库"
User->>AuthService : 提交登录请求
AuthService->>AuthService : 验证用户凭证
AuthService->>LoginLogService : 创建登录日志
LoginLogService->>LoginLogService : 构建日志数据
LoginLogService->>Database : 存储日志记录
Database-->>LoginLogService : 确认存储
LoginLogService-->>AuthService : 确认记录
AuthService-->>User : 返回登录结果
Note over AuthService,Database : 记录登录时间、IP地址、设备信息等
```

**图示来源**
- [AdminAuthServiceImpl.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/service/auth/AdminAuthServiceImpl.java#L116-L144)

## 异常登录检测与安全审计
系统通过分析登录日志来检测异常登录行为并执行安全审计。

### 登录失败处理
当用户登录失败时，系统会记录相应的登录日志。

```mermaid
flowchart TD
Start([开始登录]) --> ValidateCredentials["验证用户凭证"]
ValidateCredentials --> CredentialsValid{"凭证有效?"}
CredentialsValid --> |否| RecordFailure["记录登录失败日志"]
RecordFailure --> ReturnError["返回错误响应"]
CredentialsValid --> |是| CheckUserStatus["检查用户状态"]
CheckUserStatus --> UserActive{"用户激活?"}
UserActive --> |否| RecordDisabled["记录用户禁用日志"]
RecordDisabled --> ReturnError
UserActive --> |是| CreateSuccessLog["记录登录成功日志"]
CreateSuccessLog --> GenerateToken["生成访问令牌"]
GenerateToken --> ReturnSuccess["返回成功响应"]
style RecordFailure fill:#f9f,stroke:#333
style RecordDisabled fill:#f9f,stroke:#333
```

**图示来源**
- [AdminAuthServiceImpl.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/service/auth/AdminAuthServiceImpl.java#L68-L85)

### 登出日志记录
当用户登出时，系统会记录登出日志。

```mermaid
sequenceDiagram
participant User as "用户"
participant AuthService as "认证服务"
participant TokenService as "令牌服务"
participant LoginLogService as "登录日志服务"
User->>AuthService : 发送登出请求
AuthService->>TokenService : 删除访问令牌
TokenService-->>AuthService : 返回令牌信息
AuthService->>LoginLogService : 创建登出日志
LoginLogService->>Database : 存储登出记录
Database-->>LoginLogService : 确认存储
LoginLogService-->>AuthService : 确认记录
AuthService-->>User : 返回登出成功
Note over AuthService,LoginLogService : 记录登出时间和IP地址
```

**图示来源**
- [AdminAuthServiceImpl.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/service/auth/AdminAuthServiceImpl.java#L153-L178)

## IP地址解析与地理信息
系统使用IP地址解析技术来获取用户地理位置信息。

### IP地址工具类
`IPUtils` 类提供了IP地址解析功能。

```mermaid
classDiagram
class IPUtils {
-static Searcher SEARCHER
+Integer getAreaId(String ip)
+Area getArea(String ip)
}
```

**图示来源**
- [IPUtils.java](file://yudao-framework/yudao-spring-boot-starter-ip/src/main/java/cn/iocoder/yudao/framework/ip/core/utils/IPUtils.java#L1-L87)

### 地区数据结构
`Area` 类定义了地区信息的数据结构。

```mermaid
classDiagram
class Area {
+Integer id
+String name
+Integer type
+String areaCode
+Area parent
+List<Area> children
}
```

**图示来源**
- [Area.java](file://yudao-framework/yudao-spring-boot-starter-ip/src/main/java/cn/iocoder/yudao/framework/ip/core/Area.java#L1-L60)

### 地区工具类
`AreaUtils` 类提供了地区信息的处理功能。

```mermaid
classDiagram
class AreaUtils {
-static Map<Integer, Area> areas
+Area getArea(Integer id)
+String format(Integer id)
}
```

**图示来源**
- [AreaUtils.java](file://yudao-framework/yudao-spring-boot-starter-ip/src/main/java/cn/iocoder/yudao/framework/ip/core/utils/AreaUtils.java#L1-L36)

### IP地址解析流程
系统通过IP地址解析获取用户地理位置。

```mermaid
flowchart TD
Start([获取用户IP]) --> QueryIP["查询IP地址"]
QueryIP --> SearchArea["在IP数据库中搜索"]
SearchArea --> GetAreaId["获取地区编号"]
GetAreaId --> FindArea["在地区树中查找"]
FindArea --> ReturnArea["返回地区信息"]
ReturnArea --> UseInLog["在日志中使用"]
style SearchArea fill:#bbf,stroke:#333
style FindArea fill:#bbf,stroke:#333
```

**图示来源**
- [IPUtils.java](file://yudao-framework/yudao-spring-boot-starter-ip/src/main/java/cn/iocoder/yudao/framework/ip/core/utils/IPUtils.java#L46-L86)

## 登录日志统计分析
系统提供多种统计分析功能，帮助了解用户登录行为。

### 活跃用户分析
通过登录日志分析活跃用户。

```mermaid
flowchart TD
Start([开始分析]) --> QueryLoginLogs["查询登录日志"]
QueryLoginLogs --> GroupByUser["按用户分组"]
GroupByUser --> CountLogins["统计登录次数"]
CountLogins --> FilterActive["筛选活跃用户"]
FilterActive --> GenerateReport["生成活跃用户报告"]
GenerateReport --> DisplayResult["显示结果"]
style FilterActive fill:#f96,stroke:#333
```

### 登录成功率分析
计算登录成功率。

```mermaid
flowchart TD
Start([开始计算]) --> QueryAllLogs["查询所有登录日志"]
QueryAllLogs --> CountTotal["统计总登录次数"]
QueryAllLogs --> CountSuccess["统计成功登录次数"]
CountSuccess --> CalculateRate["计算成功率"]
CalculateRate --> FormatResult["格式化结果"]
FormatResult --> DisplayRate["显示成功率"]
style CalculateRate fill:#6f9,stroke:#333
```

### 地域分布分析
分析用户登录的地域分布。

```mermaid
flowchart TD
Start([开始分析]) --> QueryLogs["查询登录日志"]
QueryLogs --> ExtractIPs["提取IP地址"]
ExtractIPs --> ResolveLocations["解析地理位置"]
ResolveLocations --> GroupByRegion["按地区分组"]
GroupByRegion --> CountByRegion["统计各地区登录次数"]
CountByRegion --> GenerateMap["生成地域分布图"]
GenerateMap --> DisplayMap["显示分布图"]
style ResolveLocations fill:#96f,stroke:#333
style GenerateMap fill:#96f,stroke:#333
```

## 系统集成与归档策略
系统支持与第三方安全系统集成，并实施长期归档策略。

### 与SIEM系统集成
登录日志可以与SIEM（安全信息和事件管理）系统集成。

```mermaid
flowchart LR
LoginSystem["登录系统"] --> |发送日志| SIEM["SIEM系统"]
SIEM --> |实时监控| SecurityTeam["安全团队"]
SIEM --> |告警| AlertSystem["告警系统"]
SIEM --> |分析| Analytics["分析平台"]
style LoginSystem fill:#69f,stroke:#333
style SIEM fill:#f69,stroke:#333
```

### 长期归档策略
实施登录日志的长期归档策略。

```mermaid
flowchart TD
Start([日志生成]) --> StoreInDB["存储在数据库"]
StoreInDB --> CheckAge["检查日志年龄"]
CheckAge --> IsOld{"超过归档期限?"}
IsOld --> |是| CompressLog["压缩日志数据"]
CompressLog --> MoveToArchive["移动到归档存储"]
MoveToArchive --> UpdateIndex["更新索引"]
UpdateIndex --> Complete["归档完成"]
IsOld --> |否| KeepInDB["保留在数据库"]
style CompressLog fill:#696,stroke:#333
style MoveToArchive fill:#696,stroke:#333
```