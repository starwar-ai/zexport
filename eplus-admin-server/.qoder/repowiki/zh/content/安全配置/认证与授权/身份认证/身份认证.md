# 身份认证

<cite>
**本文档引用的文件**   
- [SecurityFrameworkUtils.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/core/util/SecurityFrameworkUtils.java)
- [TokenAuthenticationFilter.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/core/filter/TokenAuthenticationFilter.java)
- [YudaoWebSecurityConfigurerAdapter.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/config/YudaoWebSecurityConfigurerAdapter.java)
- [AdminAuthServiceImpl.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/service/auth/AdminAuthServiceImpl.java)
- [AuthController.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/controller/admin/auth/AuthController.java)
- [SecurityProperties.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/config/SecurityProperties.java)
- [SecurityFrameworkService.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/core/service/SecurityFrameworkService.java)
- [SecurityFrameworkServiceImpl.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/core/service/SecurityFrameworkServiceImpl.java)
- [TransmittableThreadLocalSecurityContextHolderStrategy.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/core/context/TransmittableThreadLocalSecurityContextHolderStrategy.java)
- [AuthenticationEntryPointImpl.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/core/handler/AuthenticationEntryPointImpl.java)
- [AccessDeniedHandlerImpl.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/core/handler/AccessDeniedHandlerImpl.java)
- [LoginResultEnum.java](file://yudao-module-system/yudao-module-system-api/src/main/java/cn/iocoder/yudao/module/system/enums/logger/LoginResultEnum.java)
- [AuthLoginRespVO.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/controller/admin/auth/vo/AuthLoginRespVO.java)
</cite>

## 目录
1. [简介](#简介)
2. [认证架构概述](#认证架构概述)
3. [核心组件分析](#核心组件分析)
4. [用户名密码登录流程](#用户名密码登录流程)
5. [JWT令牌生成与验证](#jwt令牌生成与验证)
6. [会话管理机制](#会话管理机制)
7. [安全上下文实现](#安全上下文实现)
8. [SecurityFrameworkService核心作用](#securityframeworkservice核心作用)
9. [多种认证方式实现](#多种认证方式实现)
10. [安全策略](#安全策略)
11. [扩展机制](#扩展机制)

## 简介
本文档详细描述了基于Spring Security的用户认证机制，重点介绍系统中的身份认证体系。系统采用基于JWT的无状态认证模式，通过OAuth2协议实现令牌管理，支持多种认证方式，包括传统的用户名密码认证、社交登录等。认证体系与权限管理紧密结合，为系统提供安全可靠的身份验证服务。

## 认证架构概述

```mermaid
graph TB
subgraph "客户端"
A[浏览器/移动端]
end
subgraph "API网关"
B[HTTP请求]
end
subgraph "认证服务"
C[TokenAuthenticationFilter]
D[SecurityFrameworkUtils]
E[OAuth2TokenApi]
F[AdminAuthServiceImpl]
end
subgraph "数据存储"
G[Redis]
H[数据库]
end
A --> B --> C --> D
D --> E --> G
C --> F --> H
F --> G
```

**图示来源**
- [TokenAuthenticationFilter.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/core/filter/TokenAuthenticationFilter.java)
- [SecurityFrameworkUtils.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/core/util/SecurityFrameworkUtils.java)
- [AdminAuthServiceImpl.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/service/auth/AdminAuthServiceImpl.java)

## 核心组件分析

### 认证过滤器
系统通过自定义的`TokenAuthenticationFilter`实现JWT令牌的验证。该过滤器在请求处理链中优先执行，负责从请求头或参数中提取JWT令牌，验证其有效性，并将认证信息设置到Spring Security上下文中。

```mermaid
classDiagram
class TokenAuthenticationFilter {
+SecurityProperties securityProperties
+GlobalExceptionHandler globalExceptionHandler
+OAuth2TokenApi oauth2TokenApi
+doFilterInternal(HttpServletRequest, HttpServletResponse, FilterChain)
+buildLoginUserByToken(String, Integer)
+mockLoginUser(HttpServletRequest, String, Integer)
}
class SecurityFrameworkUtils {
+String AUTHORIZATION_BEARER
+setLoginUser(LoginUser, HttpServletRequest)
+obtainAuthorization(HttpServletRequest, String, String)
+getLoginUser()
}
TokenAuthenticationFilter --> SecurityFrameworkUtils : "使用"
TokenAuthenticationFilter --> OAuth2TokenApi : "调用"
```

**图示来源**
- [TokenAuthenticationFilter.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/core/filter/TokenAuthenticationFilter.java)
- [SecurityFrameworkUtils.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/core/util/SecurityFrameworkUtils.java)

### 安全配置
系统通过`YudaoWebSecurityConfigurerAdapter`配置Spring Security的核心行为，包括禁用CSRF保护、采用无状态会话管理策略，以及配置自定义的认证入口点和访问拒绝处理器。

```mermaid
classDiagram
class YudaoWebSecurityConfigurerAdapter {
+AuthenticationEntryPoint authenticationEntryPoint
+AccessDeniedHandler accessDeniedHandler
+SecurityProperties securityProperties
+configure(HttpSecurity)
+configure(AuthenticationManagerBuilder)
}
class AuthenticationEntryPointImpl {
+commence(HttpServletRequest, HttpServletResponse, AuthenticationException)
}
class AccessDeniedHandlerImpl {
+handle(HttpServletRequest, HttpServletResponse, AccessDeniedException)
}
YudaoWebSecurityConfigurerAdapter --> AuthenticationEntryPointImpl
YudaoWebSecurityConfigurerAdapter --> AccessDeniedHandlerImpl
```

**图示来源**
- [YudaoWebSecurityConfigurerAdapter.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/config/YudaoWebSecurityConfigurerAdapter.java)
- [AuthenticationEntryPointImpl.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/core/handler/AuthenticationEntryPointImpl.java)
- [AccessDeniedHandlerImpl.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/core/handler/AccessDeniedHandlerImpl.java)

## 用户名密码登录流程

```mermaid
sequenceDiagram
participant Client as "客户端"
participant AuthController as "AuthController"
participant AdminAuthServiceImpl as "AdminAuthServiceImpl"
participant UserService as "AdminUserService"
participant OAuth2TokenService as "OAuth2TokenService"
participant LoginLogService as "LoginLogService"
Client->>AuthController : POST /system/auth/login
AuthController->>AdminAuthServiceImpl : login(AuthLoginReqVO)
AdminAuthServiceImpl->>UserService : getUserByUsername(username)
UserService-->>AdminAuthServiceImpl : AdminUserDO
alt 用户不存在或密码错误
AdminAuthServiceImpl->>LoginLogService : createLoginLog(失败记录)
AdminAuthServiceImpl-->>AuthController : 抛出异常
AuthController-->>Client : 返回错误响应
else 认证成功
AdminAuthServiceImpl->>LoginLogService : createLoginLog(成功记录)
AdminAuthServiceImpl->>OAuth2TokenService : createAccessToken(userId)
OAuth2TokenService-->>AdminAuthServiceImpl : OAuth2AccessTokenDO
AdminAuthServiceImpl-->>AuthController : AuthLoginRespVO
AuthController-->>Client : 返回令牌信息
end
```

**图示来源**
- [AuthController.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/controller/admin/auth/AuthController.java)
- [AdminAuthServiceImpl.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/service/auth/AdminAuthServiceImpl.java)

## JWT令牌生成与验证

### 令牌生成流程
当用户成功登录后，系统会生成JWT令牌并返回给客户端。令牌的生成由`OAuth2TokenService`负责，包含用户ID、用户类型、租户ID和权限范围等信息。

```mermaid
flowchart TD
A[用户登录成功] --> B[调用createTokenAfterLoginSuccess]
B --> C[创建LoginLogCreateReqDTO]
C --> D[调用oauth2TokenService.createAccessToken]
D --> E[生成OAuth2AccessTokenDO]
E --> F[转换为AuthLoginRespVO]
F --> G[返回给客户端]
```

**图示来源**
- [AdminAuthServiceImpl.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/service/auth/AdminAuthServiceImpl.java)
- [AuthLoginRespVO.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/controller/admin/auth/vo/AuthLoginRespVO.java)

### 令牌验证流程
每次请求到达服务器时，`TokenAuthenticationFilter`会拦截请求并验证JWT令牌的有效性。验证过程包括检查令牌格式、从OAuth2服务验证令牌有效性，以及比对用户类型。

```mermaid
flowchart TD
A[收到HTTP请求] --> B[TokenAuthenticationFilter拦截]
B --> C[从Header或参数获取token]
C --> D[token是否为空?]
D --> |是| E[继续处理链]
D --> |否| F[调用oauth2TokenApi.checkAccessToken]
F --> G[令牌有效?]
G --> |否| H[返回401错误]
G --> |是| I[比对用户类型]
I --> J[构建LoginUser对象]
J --> K[设置到SecurityContext]
K --> L[继续处理链]
```

**图示来源**
- [TokenAuthenticationFilter.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/core/filter/TokenAuthenticationFilter.java)
- [SecurityFrameworkUtils.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/core/util/SecurityFrameworkUtils.java)

## 会话管理机制
系统采用无状态的会话管理机制，不依赖于传统的服务器端会话存储。所有认证信息都包含在JWT令牌中，服务器端通过Redis存储令牌的元数据，实现令牌的吊销和过期管理。

```mermaid
classDiagram
class SecurityProperties {
+String tokenHeader
+String tokenParameter
+Boolean mockEnable
+String mockSecret
+String[] permitAllUrls
+Integer passwordEncoderLength
}
class TransmittableThreadLocalSecurityContextHolderStrategy {
+ThreadLocal~SecurityContext~ CONTEXT_HOLDER
+clearContext()
+getContext()
+setContext(SecurityContext)
+createEmptyContext()
}
SecurityProperties --> TransmittableThreadLocalSecurityContextHolderStrategy : "配置"
```

**图示来源**
- [SecurityProperties.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/config/SecurityProperties.java)
- [TransmittableThreadLocalSecurityContextHolderStrategy.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/core/context/TransmittableThreadLocalSecurityContextHolderStrategy.java)

## 安全上下文实现
系统通过`SecurityFrameworkUtils`工具类管理安全上下文，提供设置和获取当前登录用户的方法。安全上下文使用`TransmittableThreadLocal`实现，确保在异步调用和线程池中也能正确传递认证信息。

```mermaid
classDiagram
class LoginUser {
+Long id
+Integer userType
+Long tenantId
+Set~String~ scopes
+getId()
+setId(Long)
+getUserType()
+setUserType(Integer)
+getTenantId()
+setTenantId(Long)
+getScopes()
+setScopes(Set~String~)
}
class SecurityFrameworkUtils {
+String AUTHORIZATION_BEARER
+setLoginUser(LoginUser, HttpServletRequest)
+getLoginUser()
+obtainAuthorization(HttpServletRequest, String, String)
}
SecurityFrameworkUtils --> LoginUser : "包含"
```

**图示来源**
- [SecurityFrameworkUtils.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/core/util/SecurityFrameworkUtils.java)
- [LoginUser.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/core/LoginUser.java)

## SecurityFrameworkService核心作用
`SecurityFrameworkService`是系统权限校验的核心接口，提供了一系列方法用于检查用户权限、角色和授权范围。该服务的实现类`SecurityFrameworkServiceImpl`通过远程调用权限API完成实际的权限验证。

```mermaid
classDiagram
class SecurityFrameworkService {
<<interface>>
+hasPermission(String... permission)
+hasAnyPermissions(String... permissions)
+hasRole(String role)
+hasAnyRoles(String... roles)
+hasScope(String scope)
+hasAnyScopes(String... scope)
}
class SecurityFrameworkServiceImpl {
+PermissionApi permissionApi
+hasPermission(String... permission)
+hasAnyPermissions(String... permissions)
+hasRole(String role)
+hasAnyRoles(String... roles)
+hasScope(String scope)
+hasAnyScopes(String... scope)
}
class PermissionApi {
+hasAnyPermissions(Long userId, String... permissions)
+hasAnyRoles(Long userId, String... roles)
}
SecurityFrameworkService <|-- SecurityFrameworkServiceImpl
SecurityFrameworkServiceImpl --> PermissionApi : "调用"
```

**图示来源**
- [SecurityFrameworkService.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/core/service/SecurityFrameworkService.java)
- [SecurityFrameworkServiceImpl.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/core/service/SecurityFrameworkServiceImpl.java)

## 多种认证方式实现

### 社交登录流程
系统支持通过第三方平台（如微信）进行社交登录。用户通过授权码获取访问令牌，系统验证令牌后查找对应的内部用户账户，并生成本地认证令牌。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant AuthController as "AuthController"
participant AdminAuthServiceImpl as "AdminAuthServiceImpl"
participant WechatService as "WechatService"
participant UserService as "AdminUserService"
participant OAuth2TokenService as "OAuth2TokenService"
Client->>AuthController : GET /system/auth/social-auth-redirect
AuthController->>WechatService : getAuthorizeUrl
WechatService-->>AuthController : 授权URL
AuthController-->>Client : 重定向到授权页面
Client->>Wechat : 用户授权
Wechat-->>Client : 返回授权码
Client->>AuthController : POST /system/auth/social-login
AuthController->>AdminAuthServiceImpl : socialLogin(AuthSocialLoginReqVO)
AdminAuthServiceImpl->>WechatService : getAccessToken
WechatService-->>AdminAuthServiceImpl : AccessToken
AdminAuthServiceImpl->>WechatService : getUserIdByCode
WechatService-->>AdminAuthServiceImpl : WechatUser
AdminAuthServiceImpl->>UserService : getAdminUserIdByWechatUserId
UserService-->>AdminAuthServiceImpl : AdminUserDO
AdminAuthServiceImpl->>OAuth2TokenService : createAccessToken
OAuth2TokenService-->>AdminAuthServiceImpl : OAuth2AccessTokenDO
AdminAuthServiceImpl-->>AuthController : AuthLoginRespVO
AuthController-->>Client : 返回令牌信息
```

**图示来源**
- [AuthController.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/controller/admin/auth/AuthController.java)
- [AdminAuthServiceImpl.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/service/auth/AdminAuthServiceImpl.java)

## 安全策略

### 登录失败处理
系统对登录失败情况进行详细记录，并返回相应的错误码。登录失败可能由多种原因引起，包括账号或密码错误、用户被禁用、验证码错误等。

```mermaid
classDiagram
class LoginResultEnum {
<<enumeration>>
+SUCCESS(0)
+BAD_CREDENTIALS(10)
+USER_DISABLED(20)
+CAPTCHA_NOT_FOUND(30)
+CAPTCHA_CODE_ERROR(31)
}
class ErrorCodeConstants {
<<interface>>
+AUTH_LOGIN_BAD_CREDENTIALS
+AUTH_LOGIN_USER_DISABLED
+AUTH_LOGIN_CAPTCHA_NOT_FOUND
+AUTH_LOGIN_CAPTCHA_CODE_ERROR
}
LoginResultEnum --> ErrorCodeConstants : "对应"
```

**图示来源**
- [LoginResultEnum.java](file://yudao-module-system/yudao-module-system-api/src/main/java/cn/iocoder/yudao/module/system/enums/logger/LoginResultEnum.java)
- [ErrorCodeConstants.java](file://yudao-module-system/yudao-module-system-api/src/main/java/cn/iocoder/yudao/module/system/enums/ErrorCodeConstants.java)

### 密码加密存储
系统使用BCryptPasswordEncoder对用户密码进行加密存储，确保即使数据库泄露，攻击者也无法轻易获取原始密码。密码加密的强度可以通过配置项进行调整。

```mermaid
flowchart TD
A[用户注册] --> B[输入密码]
B --> C[系统调用BCryptPasswordEncoder]
C --> D[生成加密后的密码]
D --> E[存储到数据库]
F[用户登录] --> G[输入密码]
G --> H[系统调用BCryptPasswordEncoder.matches]
H --> I[验证密码是否匹配]
I --> J[返回验证结果]
```

**图示来源**
- [YudaoSecurityAutoConfiguration.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/config/YudaoSecurityAutoConfiguration.java)

## 扩展机制

### 自定义认证过滤器
开发者可以通过继承`OncePerRequestFilter`创建自定义的认证过滤器，并将其注册到Spring Security的过滤器链中，以实现特定的认证需求。

```mermaid
classDiagram
class OncePerRequestFilter {
<<abstract>>
+doFilter(ServletRequest, ServletResponse, FilterChain)
+doFilterInternal(HttpServletRequest, HttpServletResponse, FilterChain)
}
class TokenAuthenticationFilter {
+doFilterInternal(HttpServletRequest, HttpServletResponse, FilterChain)
+buildLoginUserByToken(String, Integer)
+mockLoginUser(HttpServletRequest, String, Integer)
}
OncePerRequestFilter <|-- TokenAuthenticationFilter
```

**图示来源**
- [TokenAuthenticationFilter.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/core/filter/TokenAuthenticationFilter.java)

### 认证成功/失败处理器
系统提供了自定义认证成功和失败处理器的扩展点，开发者可以实现`AuthenticationSuccessHandler`和`AuthenticationFailureHandler`接口，以定制认证成功或失败后的处理逻辑。

```mermaid
classDiagram
class AuthenticationSuccessHandler {
<<interface>>
+onAuthenticationSuccess(HttpServletRequest, HttpServletResponse, Authentication)
}
class AuthenticationFailureHandler {
<<interface>>
+onAuthenticationFailure(HttpServletRequest, HttpServletResponse, AuthenticationException)
}
class AuthenticationEntryPointImpl {
+commence(HttpServletRequest, HttpServletResponse, AuthenticationException)
}
class AccessDeniedHandlerImpl {
+handle(HttpServletRequest, HttpServletResponse, AccessDeniedException)
}
AuthenticationEntryPointImpl --> AuthenticationFailureHandler
AccessDeniedHandlerImpl --> AuthenticationFailureHandler
```

**图示来源**
- [AuthenticationEntryPointImpl.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/core/handler/AuthenticationEntryPointImpl.java)
- [AccessDeniedHandlerImpl.java](file://yudao-framework/yudao-spring-boot-starter-security/src/main/java/cn/iocoder/yudao/framework/security/core/handler/AccessDeniedHandlerImpl.java)