# 客户认领

<cite>
**本文档引用的文件**  
- [CustClaimItem.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/dal/dataobject/custclaim/CustClaimItem.java)
- [CustClaimItemMapper.xml](file://eplus-module-fms/eplus-module-fms-biz/src/main/resources/mapper/CustClaimItemMapper.xml)
- [BankRegistrationDO.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/dal/dataobject/bankregistration/BankRegistrationDO.java)
- [fms_cust_claim_item.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_002__Eplus初始化.sql)
- [fms_bank_registration.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_005__新建银行登记表.sql)
- [fms_receipt.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_002__Eplus初始化.sql)
- [CustClaimServiceImpl.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/service/custclaim/CustClaimServiceImpl.java)
- [CollectionPlanStepEnum.java](file://eplus-framework/eplus-common/src/main/java/com/syj/eplus/framework/common/enums/CollectionPlanStepEnum.java)
</cite>

## 目录
1. [引言](#引言)
2. [客户认领数据模型](#客户认领数据模型)
3. [核心表结构设计](#核心表结构设计)
4. [处理流程与核销逻辑](#处理流程与核销逻辑)
5. [复杂场景处理](#复杂场景处理)
6. [关键功能数据设计](#关键功能数据设计)
7. [SQL建表语句示例](#sql建表语句示例)
8. [MyBatis关联查询配置](#mybatis关联查询配置)
9. [最佳实践](#最佳实践)

## 引言

客户认领是财务管理中的核心环节，用于将银行入账的款项与具体的客户合同、收款计划进行匹配和核销。本文档详细描述了客户认领的数据模型设计，包括客户认领明细表、银行登记表和收款计划表之间的关系。文档重点阐述了认领金额、认领日期、收款方式、银行信息等关键字段的定义，以及多笔认领对应单笔收款的复杂场景处理。此外，还详细说明了认领差异处理、认领冲正和认领审批等关键功能的数据设计，为开发者提供客户认领功能开发的全面指导和最佳实践。

## 客户认领数据模型

客户认领数据模型围绕三个核心实体构建：银行登记（Bank Registration）、客户认领明细（Cust Claim Item）和收款计划（Collection Plan）。该模型旨在实现银行入账款项与客户应收款项的精确匹配和核销。

银行登记表记录了银行入账的原始信息，包括入账金额、币种、银行账号、入账日期等。客户认领明细表是核销的核心，它记录了每笔认领的具体信息，如认领金额、认领日期、对应的合同和收款计划。收款计划表则定义了销售合同的应收款项结构，包括各期的收款比例、预计收款日期和应收金额。

这三个实体通过外键关联形成一个完整的核销链路。一笔银行入账（银行登记）可以被拆分为多笔认领（客户认领明细），每笔认领对应一个具体的收款计划。这种设计支持了“多对一”和“一对多”的复杂核销场景，确保了财务数据的准确性和可追溯性。

**Section sources**
- [CustClaimItem.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/dal/dataobject/custclaim/CustClaimItem.java)
- [BankRegistrationDO.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/dal/dataobject/bankregistration/BankRegistrationDO.java)

## 核心表结构设计

### 客户认领明细表 (fms_cust_claim_item)

客户认领明细表是整个认领流程的核心数据表，存储了每一笔认领的详细信息。

```mermaid
erDiagram
fms_cust_claim_item {
bigint id PK "主键"
varchar(20) contractCode "订单合同号"
varchar(20) custCode "客户编号"
varchar(100) custName "客户名称"
varchar(10) currency "订单币别"
bigint settlementId "收款方式主键"
varchar(100) settlementName "收款方式名称"
int sourceType "来源"
decimal(19,6) receivableAmount "应收金额"
decimal(19,6) receivedAmount "已收金额"
decimal(19,6) claimedAmount "本次认领金额"
decimal(19,6) contractAmount "订单币种认领金额"
decimal(19,6) differenceAmount "差异总金额"
int completedFlag "收款完成标识"
json claimPerson "认领员工"
datetime claimDate "认领日期"
json differenceReason "差异原因"
bigint registrationId FK "登记主键"
bigint itemId "明细主键"
varchar(50) source "来源描述"
int type "认领类型"
int otherFeeType "其他收费类型"
varchar(20) receiptCode "收款单编号"
json financeAmount "财务费用"
varchar(100) invoiceCode "出运发票号"
decimal(19,6) collectionRatio "收款比例"
int saleType "销售类型"
varchar(500) remark "备注"
}
```

**Diagram sources**
- [CustClaimItem.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/dal/dataobject/custclaim/CustClaimItem.java)
- [fms_cust_claim_item.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_002__Eplus初始化.sql)

### 银行登记表 (fms_bank_registration)

银行登记表记录了从银行获取的入账信息，是客户认领的起点。

```mermaid
erDiagram
fms_bank_registration {
bigint id PK "主键"
varchar(20) code "编号"
json registeredBy "登记人"
datetime registrationDate "登记日期"
bigint companyId "入账单位id"
varchar(100) companyName "入账单位名称"
varchar(100) companyTitle "公司抬头"
datetime bankPostingDate "银行入账日期"
varchar(100) bank "银行"
varchar(100) bankAccount "银行账号"
varchar(200) bankAddress "开户行地址"
varchar(100) bankPoc "开户行联系人"
varchar(100) bankCode "银行行号"
varchar(10) currency "入账币别"
decimal(19,6) amount "入账金额"
varchar(500) remark "备注"
varchar(20) custCode "客户编号"
varchar(100) custName "客户名称"
json manager "业务员"
json claimManager "认领业务员"
tinyint claimStatus "认领状态"
datetime claimDate "认领日期"
varchar(500) linkSaleContractCode "关联外销合同号"
decimal(19,6) claimedAmount "已认领金额"
int status "状态"
json managerList "业务员列表"
json custList "客户列表"
}
```

**Diagram sources**
- [BankRegistrationDO.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/dal/dataobject/bankregistration/BankRegistrationDO.java)
- [fms_bank_registration.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_005__新建银行登记表.sql)

### 收款计划表 (sms_collection_plan)

收款计划表定义了销售合同的应收款项结构，是认领的依据。

```mermaid
erDiagram
sms_collection_plan {
bigint id PK "主键"
bigint contract_id FK "合同id"
tinyint step "步骤"
tinyint payment_method "支付方式"
tinyint date_type "起始点"
datetime start_date "起始日"
int days "天数"
datetime expected_receipt_date "预计收款日"
decimal(19,6) collection_ratio "收款比例"
json receivable_amount "应收金额"
json received_amount "实收金额"
tinyint control_purchase_flag "是否控制采购"
tinyint exe_status "状态"
}
```

**Diagram sources**
- [CollectionPlanStepEnum.java](file://eplus-framework/eplus-common/src/main/java/com/syj/eplus/framework/common/enums/CollectionPlanStepEnum.java)
- [fms_cust_claim_item.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_002__Eplus初始化.sql)

## 处理流程与核销逻辑

客户认领的处理流程始于银行登记。当财务人员在系统中录入一笔银行入账信息后，系统会创建一条银行登记记录。随后，认领流程启动，系统会根据银行登记中的“公司抬头”等信息，查找可能的关联客户和合同。

核销逻辑的核心是将银行登记的“入账金额”分配到一个或多个收款计划上。在 `CustClaimServiceImpl` 中，`getCustClaim` 方法负责获取可认领的明细。该方法首先查询银行登记信息，然后通过 `custApi` 根据公司抬头获取客户信息，最后通过 `custClaimItemMapper` 查询所有可被认领的收款计划项。

核销时，用户选择一个或多个收款计划，并输入本次认领的金额。系统会根据以下逻辑进行处理：
1.  **金额匹配**：认领金额不能超过该收款计划的未收金额。
2.  **状态更新**：认领成功后，更新收款计划的“已收金额”和“执行状态”。
3.  **生成认领明细**：创建一条或多条 `CustClaimItem` 记录，记录本次认领的详细信息。
4.  **更新银行登记**：更新银行登记的“已认领金额”和“认领状态”。

**Section sources**
- [CustClaimServiceImpl.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/service/custclaim/CustClaimServiceImpl.java)

## 复杂场景处理

### 多笔认领对应单笔收款

在实际业务中，一笔大额的银行入账可能需要分多次、分多个合同进行认领。本系统通过 `fms_cust_claim_item` 表的 `registrationId` 字段与 `fms_bank_registration` 表的 `id` 字段关联，完美支持了这一场景。

当一笔银行入账（`fms_bank_registration` 的一条记录）被认领时，系统会创建多条 `fms_cust_claim_item` 记录，每条记录的 `registrationId` 都指向同一个银行登记ID。这实现了“一对多”的关系。系统通过 `claimedAmount` 字段实时跟踪银行登记的已认领总额，确保不会超额认领。

### 认领金额与应收金额不一致

当认领金额与应收金额存在差异时，系统通过 `differenceAmount` 和 `differenceReason` 字段进行处理。`differenceAmount` 记录差异的金额，而 `differenceReason` 是一个JSON类型的字段，用于存储差异原因的详细信息，支持多条原因记录。这为后续的财务对账和审计提供了完整的数据支持。

## 关键功能数据设计

### 认领差异处理

认领差异处理的数据设计主要体现在 `CustClaimItem` 实体上。`differenceAmount` 字段直接存储差异金额，而 `differenceReason` 字段使用了自定义的 `DifferenceReasonListHandler` 类型处理器，能够将Java中的 `List<DifferenceReason>` 对象与数据库中的JSON字段进行双向转换。`DifferenceReason` 是一个包含原因代码和描述的实体，确保了差异信息的结构化和可扩展性。

### 认领冲正

认领冲正（即撤销认领）功能通过 `CustClaimService` 接口的 `cancelCustClaim` 方法实现。该方法接收一个认领明细ID，然后执行以下操作：
1.  删除对应的 `fms_cust_claim_item` 记录。
2.  回滚相关收款计划的“已收金额”和“执行状态”。
3.  更新银行登记的“已认领金额”和“认领状态”。

这种设计保证了数据的一致性和事务的完整性。

### 认领审批

认领审批流程的数据设计主要依赖于状态字段。`fms_bank_registration` 表的 `claimStatus` 字段用于标识认领的当前状态（如待认领、认领中、已认领）。当认领操作需要审批时，系统会将状态设置为“待审批”，审批通过后才更新为“已认领”。相关的审批人和审批时间信息则存储在通用的审计字段（`creator`, `create_time`, `updater`, `update_time`）中。

## SQL建表语句示例

以下是客户认领明细表的核心建表语句：

```sql
CREATE TABLE IF NOT EXISTS `fms_cust_claim_item` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键',
  `contract_code` varchar(20) NOT NULL DEFAULT '' COMMENT '订单合同号',
  `cust_code` varchar(20) NOT NULL DEFAULT '' COMMENT '客户编号',
  `cust_name` varchar(100) NOT NULL DEFAULT '' COMMENT '客户名称',
  `currency` varchar(10) NOT NULL DEFAULT '' COMMENT '订单币别',
  `settlement_id` bigint NULL DEFAULT NULL COMMENT '收款方式主键',
  `settlement_name` varchar(100) NOT NULL DEFAULT '' COMMENT '收款方式名称',
  `source_type` int NULL DEFAULT NULL COMMENT '来源',
  `receivable_amount` decimal(19,6) NOT NULL DEFAULT '0.000000' COMMENT '应收金额',
  `received_amount` decimal(19,6) NOT NULL DEFAULT '0.000000' COMMENT '已收金额',
  `claimed_amount` decimal(19,6) NOT NULL DEFAULT '0.000000' COMMENT '本次认领金额',
  `contract_amount` decimal(19,6) NOT NULL DEFAULT '0.000000' COMMENT '订单币种认领金额',
  `difference_amount` decimal(19,6) NOT NULL DEFAULT '0.000000' COMMENT '差异总金额',
  `completed_flag` int NULL DEFAULT NULL COMMENT '收款完成标识',
  `claim_person` json NOT NULL DEFAULT (JSON_OBJECT()) COMMENT '认领员工',
  `claim_date` datetime NULL DEFAULT NULL COMMENT '认领日期',
  `difference_reason` json NULL DEFAULT NULL COMMENT '差异原因',
  `registration_id` bigint NULL DEFAULT NULL COMMENT '登记主键',
  `item_id` bigint NULL DEFAULT NULL COMMENT '明细主键',
  `source` varchar(50) NOT NULL DEFAULT '' COMMENT '来源',
  `type` int NULL DEFAULT NULL COMMENT '认领类型 0:回款认领 1：其他收费',
  `other_fee_type` int NULL DEFAULT NULL COMMENT '其他收费类型 1:证书费  2:模具费  3:样品费  4:快递费 5:验货费 ',
  `receipt_code` varchar(20) NULL DEFAULT NULL COMMENT '收款单编号',
  `finance_amount` json NOT NULL DEFAULT (JSON_OBJECT()) COMMENT '财务费用',
  `invoice_code` varchar(100) NOT NULL DEFAULT '' COMMENT '出运发票号',
  `collection_ratio` decimal(19,6) NULL DEFAULT NULL COMMENT '收款比例',
  `sale_type` tinyint NULL DEFAULT NULL COMMENT '销售类型',
  `remark` varchar(500) NOT NULL DEFAULT '' COMMENT '备注',
  `creator` int UNSIGNED NULL DEFAULT NULL COMMENT '创建人',
  `create_time` datetime NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updater` int UNSIGNED NULL DEFAULT NULL COMMENT '修改人',
  `update_time` datetime NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  `deleted` tinyint(1) NOT NULL DEFAULT '0' COMMENT '删除',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci COMMENT='客户认领明细表';
```

## MyBatis关联查询配置

在 `CustClaimItemMapper.xml` 中，通过自定义的 `ResultMapWithJson` 实现了对JSON字段的映射。关键配置如下：

```xml
<resultMap id="ResultMapWithJson" type="com.syj.eplus.module.fms.dal.dataobject.custclaim.CustClaimItem"
           extends="BaseResultMap">
    <result column="differenceReason" property="differenceReason" 
            javaType="com.syj.eplus.framework.common.entity.DifferenceReason"
            typeHandler="com.syj.eplus.framework.common.config.handler.DifferenceReasonListHandler"/>
</resultMap>
```

同时，在 `CustClaimItemMapper` 接口中，使用了复杂的SQL查询来获取可认领的明细项，该查询通过UNION操作合并了来自销售合同收款计划和加项的数据：

```java
@Select("""
        <script>
        SELECT ... FROM sms_sale_contract t1
        LEFT JOIN sms_collection_plan t2 ON t1.id = t2.contract_id
        ...
        WHERE t1.STATUS IN ( 3, 4, 5, 6 ) 
        AND t2.deleted = 0 AND t2.exe_status != 1
        AND t1.company_id = #{companyId}
        ...
        UNION
        SELECT ... FROM sms_sale_contract t3
        LEFT JOIN sms_add_sub_term t4 ON t3.CODE = t4.contract_code
        ...
        </script>
        """)
List<CustClaimItem> getCustClaimItemList(@Param("custCodes") List<String> custCodes, @Param("companyId")Long companyId);
```

**Section sources**
- [CustClaimItemMapper.xml](file://eplus-module-fms/eplus-module-fms-biz/src/main/resources/mapper/CustClaimItemMapper.xml)
- [CustClaimItemMapper.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/dal/mysql/custclaim/CustClaimItemMapper.java)

## 最佳实践

1.  **数据一致性**：在进行认领和冲正操作时，务必使用数据库事务，确保银行登记、收款计划和认领明细三者之间的数据一致性。
2.  **性能优化**：对于 `getCustClaimItemList` 这类复杂查询，应确保相关字段（如 `contract_id`, `deleted`, `exe_status`, `company_id`）上有适当的数据库索引。
3.  **枚举使用**：对于 `sourceType`, `claimStatus`, `otherFeeType` 等字段，应严格使用预定义的枚举值，避免硬编码，提高代码的可维护性。
4.  **JSON字段处理**：对于 `differenceReason` 和 `financeAmount` 等JSON字段，应使用自定义的TypeHandler进行处理，避免在业务逻辑中直接操作JSON字符串。
5.  **审计追踪**：充分利用 `BaseDO` 中的 `creator`, `create_time`, `updater`, `update_time` 字段，为所有关键操作提供完整的审计追踪能力。