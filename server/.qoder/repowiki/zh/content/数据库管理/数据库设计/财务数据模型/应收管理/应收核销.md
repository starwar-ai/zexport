# 应收核销

<cite>
**本文档引用文件**  
- [CustClaimItem.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/dal/dataobject/custclaim/CustClaimItem.java)
- [V1_0_0_002__Eplus初始化.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_002__Eplus初始化.sql)
- [V1_0_0_013__新增客户认领明细表.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_013__新增客户认领明细表.sql)
- [CustClaimController.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/controller/admin/custclaim/CustClaimController.java)
- [CustClaimService.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/service/custclaim/CustClaimService.java)
- [CustClaimServiceImpl.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/service/custclaim/CustClaimServiceImpl.java)
- [V1_0_0_561__回款认领明细增加备注.java](file://eplus-flyway/src/main/java/db/migration/common/V1_0_0_561__回款认领明细增加备注.java)
- [system_collection_plan.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_002__Eplus初始化.sql#L2776-L2796)
</cite>

## 目录
1. [引言](#引言)
2. [应收核销数据模型设计](#应收核销数据模型设计)
3. [应收核销业务流程](#应收核销业务流程)
4. [实体关系图（ER图）](#实体关系图er图)
5. [复杂业务场景处理](#复杂业务场景处理)
6. [SQL建表语句示例](#sql建表语句示例)
7. [MyBatis事务处理配置](#mybatis事务处理配置)
8. [开发最佳实践](#开发最佳实践)

## 引言

应收核销是企业财务管理中的核心环节，用于将客户付款与应收账款进行匹配和冲销。本文档详细描述了应收核销的数据模型设计、业务流程、实体关系以及复杂业务场景的处理逻辑，旨在为开发者提供完整的开发指导和最佳实践。

## 应收核销数据模型设计

应收核销的核心数据模型主要围绕客户认领明细表（`fms_cust_claim_item`）展开，该表记录了每次核销的详细信息，包括核销金额、核销日期、关联单据、操作人员等关键字段。

### 核心字段定义

- **核销金额**：包括`claimed_amount`（本次入账币种认领金额）、`contract_amount`（订单币种认领金额）和`difference_amount`（差异总金额）。
- **核销日期**：`claim_date`字段记录了认领发生的日期。
- **关联单据**：`contract_code`（订单合同号）、`receipt_code`（收款单编号）和`invoice_code`（出运发票号）用于关联相关业务单据。
- **操作人员**：`claim_person`字段以JSON格式存储认领员工信息，`creator`和`updater`记录了创建和修改人员ID。

### 数据结构特点

- 使用`BaseDO`作为基础数据对象，继承了创建时间、修改时间、创建人、修改人等通用字段。
- 采用`@TableField(typeHandler = JsonUserDeptTypeHandler.class)`等自定义类型处理器，支持JSON格式数据的存储和读取。
- 通过`registrationId`和`itemId`等字段与收款登记表建立关联。

**本节来源**  
- [CustClaimItem.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/dal/dataobject/custclaim/CustClaimItem.java#L33-L182)

## 应收核销业务流程

应收核销业务流程主要包括自动核销、手动核销和部分核销三种场景。

### 自动核销规则

系统根据预设的收款计划（`system_collection_plan`）和客户付款信息，自动匹配并生成核销记录。核销比例由`collection_ratio`字段控制，系统会根据合同金额和收款金额自动计算核销金额。

### 手动核销操作

用户可以通过管理后台手动创建核销记录。操作流程如下：
1. 选择需要核销的收款单
2. 选择关联的销售合同或应收单据
3. 输入核销金额
4. 系统自动计算差异金额并提示
5. 提交核销申请

### 部分核销处理

系统支持对单笔应收进行多次部分核销。每次核销后，系统会更新`received_amount`（已收金额）和`unclaimedAmount`（待认领金额），确保数据的准确性和一致性。

**本节来源**  
- [CustClaimService.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/service/custclaim/CustClaimService.java#L17-L31)
- [CustClaimServiceImpl.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/service/custclaim/CustClaimServiceImpl.java#L56-L349)

## 实体关系图（ER图）

```mermaid
erDiagram
fms_cust_claim_item {
bigint id PK
varchar(20) contract_code
varchar(20) cust_code
varchar(200) cust_name
varchar(10) currency
bigint settlement_id
VARCHAR(100) settlement_name
tinyint source_type
decimal(19, 6) receivable_amount
decimal(19, 6) received_amount
decimal(19, 6) claimed_amount
decimal(19, 6) contract_amount
decimal(19, 6) difference_amount
tinyint completed_flag
json difference_reason
json claim_person
datetime claim_date
int creator
datetime create_time
int updater
tinyint deleted
datetime update_time
varchar(500) remark
}
fms_receipt {
bigint id PK
varchar(100) code
bigint company_id
varchar(100) bank
varchar(100) bank_address
varchar(100) bank_account
varchar(100) bank_poc
varchar(100) bank_code
varchar(100) amount
varchar(100) rate
datetime receipt_time
varchar(100) remark
varchar(100) receipt_user
varchar(100) approver
datetime approval_time
tinyint business_type
varchar(30) business_code
tinyint business_subject_type
varchar(30) business_subject_code
tinyint status
tinyint receipt_type
int creator
datetime create_time
int updater
datetime update_time
tinyint deleted
}
system_collection_plan {
bigint id PK
bigint settlement_id
tinyint step
tinyint date_type
int days
decimal(19, 6) collection_ratio
tinyint control_purchase_flag
tinyint exe_status
int creator
datetime create_time
int updater
tinyint deleted
datetime update_time
}
fms_cust_claim_item ||--o{ fms_receipt : "关联收款单"
fms_cust_claim_item ||--o{ system_collection_plan : "关联收款计划"
```

**图表来源**  
- [V1_0_0_013__新增客户认领明细表.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_013__新增客户认领明细表.sql#L1-L30)
- [V1_0_0_002__Eplus初始化.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_002__Eplus初始化.sql#L1529-L1568)
- [system_collection_plan.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_002__Eplus初始化.sql#L2776-L2796)

## 复杂业务场景处理

### 核销冲回

当核销操作需要撤销时，系统通过`cancelCustClaim`方法实现核销冲回。该操作会：
1. 删除对应的核销明细记录
2. 恢复应收单据的未核销金额
3. 记录操作日志和审计信息

### 核销调整

对于核销金额需要调整的场景，系统不直接修改原有记录，而是采用"冲销+重新核销"的方式，确保数据变更的可追溯性。

### 跨期核销

系统支持跨会计期间的核销操作。在生成财务凭证时，会根据`claim_date`确定所属会计期间，并相应调整财务报表数据。

**本节来源**  
- [CustClaimController.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/controller/admin/custclaim/CustClaimController.java#L62-L68)
- [CustClaimServiceImpl.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/service/custclaim/CustClaimServiceImpl.java#L326-L338)

## SQL建表语句示例

```sql
CREATE TABLE IF NOT EXISTS `fms_cust_claim_item` (
    `id`                bigint         NOT NULL AUTO_INCREMENT COMMENT '主键',
    `contract_code`     varchar(20)    NOT NULL DEFAULT '' COMMENT '订单合同号',
    `cust_code`         varchar(20)    NOT NULL DEFAULT '' COMMENT '客户编号',
    `cust_name`         varchar(200)   NOT NULL DEFAULT '' COMMENT '客户名称',
    `currency`          varchar(10)    NOT NULL DEFAULT '' COMMENT '订单币别',
    `settlement_id`     bigint         NULL     DEFAULT NULL COMMENT '收款方式主键',
    `settlement_name`   VARCHAR(100)   NOT NULL DEFAULT '' COMMENT '收款方式名称',
    `source_type`       tinyint        NULL     DEFAULT NULL COMMENT '来源',
    `receivable_amount` decimal(19, 6) NOT NULL DEFAULT 0 COMMENT '应收金额',
    `received_amount`   decimal(19, 6) NOT NULL DEFAULT 0 COMMENT '已收金额',
    `claimed_amount`    decimal(19, 6) NOT NULL DEFAULT 0 COMMENT '本次入账币种认领金额',
    `contract_amount`   decimal(19, 6) NOT NULL DEFAULT 0 COMMENT '订单币种认领金额',
    `difference_amount` decimal(19, 6) NOT NULL DEFAULT 0 COMMENT '差异总金额',
    `completed_flag`    tinyint        NOT NULL DEFAULT 0 COMMENT '收款完成标识',
    `difference_reason` json           NOT NULL DEFAULT (JSON_OBJECT()) COMMENT '差异原因',
    `claim_person`      json           NOT NULL DEFAULT (JSON_OBJECT()) COMMENT '认领员工',
    `claim_date`        datetime       NULL     DEFAULT CURRENT_TIMESTAMP COMMENT '认领日期',
    `creator`           int UNSIGNED   NULL     DEFAULT NULL COMMENT '创建人',
    `create_time`       datetime       NULL     DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updater`           int UNSIGNED   NULL     DEFAULT NULL COMMENT '修改人',
    `deleted`           tinyint(1)     NOT NULL DEFAULT 0 COMMENT '删除',
    `update_time`       datetime       NULL     DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
    `remark`            varchar(500)   NOT NULL DEFAULT '' COMMENT '备注',
    PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB
  AUTO_INCREMENT = 1
  CHARACTER SET = utf8mb4
  COLLATE = utf8mb4_general_ci COMMENT = '客户认领明细表'
  ROW_FORMAT = DYNAMIC;
```

**本节来源**  
- [V1_0_0_013__新增客户认领明细表.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_013__新增客户认领明细表.sql#L1-L30)
- [V1_0_0_561__回款认领明细增加备注.java](file://eplus-flyway/src/main/java/db/migration/common/V1_0_0_561__回款认领明细增加备注.java#L1-L15)

## MyBatis事务处理配置

在应收核销功能中，涉及多个数据表的更新操作，必须使用事务确保数据一致性。以下是MyBatis事务处理的配置示例：

```java
@Service
public class CustClaimServiceImpl implements CustClaimService {
    
    @Resource
    private CustClaimItemMapper custClaimItemMapper;
    
    @Resource
    private BankRegistrationMapper bankRegistrationMapper;
    
    @Transactional(rollbackFor = Exception.class)
    @Override
    public void createCustClaim(CustClaimSaveReqVO custClaimSaveReqVO) {
        // 1. 创建客户认领明细
        List<CustClaimItem> custClaimItems = convertToCustClaimItems(custClaimSaveReqVO);
        custClaimItemMapper.insertBatch(custClaimItems);
        
        // 2. 更新收款登记状态
        updateBankRegistrationStatus(custClaimSaveReqVO.getId());
        
        // 3. 更新应收单据的已收金额
        updateReceivableAmount(custClaimItems);
        
        // 4. 生成财务凭证
        generateAccountingVoucher(custClaimItems);
    }
}
```

**本节来源**  
- [CustClaimServiceImpl.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/service/custclaim/CustClaimServiceImpl.java#L56-L349)

## 开发最佳实践

1. **数据一致性**：所有涉及金额变更的操作必须在事务中执行，确保数据一致性。
2. **审计追踪**：保留所有核销操作的历史记录，便于审计和追溯。
3. **性能优化**：对于大批量核销操作，采用批量插入和更新，避免逐条处理。
4. **异常处理**：完善的异常处理机制，确保系统在异常情况下能够正确回滚。
5. **权限控制**：严格的权限控制，确保只有授权人员才能执行核销操作。

**本节来源**  
- [CustClaimService.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/service/custclaim/CustClaimService.java#L17-L31)
- [CustClaimServiceImpl.java](file://eplus-module-fms/eplus-module-fms-biz/src/main/java/com/syj/eplus/module/fms/service/custclaim/CustClaimServiceImpl.java#L56-L349)