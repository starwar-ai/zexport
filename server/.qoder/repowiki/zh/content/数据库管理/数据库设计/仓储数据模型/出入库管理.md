# 出入库管理

<cite>
**本文档引用文件**   
- [StockNoticeDO.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/dal/dataobject/stockNotice/StockNoticeDO.java)
- [StockNoticeItemDO.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/dal/dataobject/stockNotice/StockNoticeItemDO.java)
- [BillDO.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/dal/dataobject/bill/BillDO.java)
- [BillItemDO.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/dal/dataobject/bill/BillItemDO.java)
- [NoticeStatusEnum.java](file://eplus-module-wms/eplus-module-wms-api/src/main/java/com/syj/eplus/module/wms/enums/NoticeStatusEnum.java)
- [StockBillStatusEnum.java](file://eplus-module-wms/eplus-module-wms-api/src/main/java/com/syj/eplus/module/wms/enums/StockBillStatusEnum.java)
- [StockStatusEnum.java](file://eplus-module-wms/eplus-module-wms-api/src/main/java/com/syj/eplus/module/wms/enums/StockStatusEnum.java)
- [StockTypeEnum.java](file://eplus-module-wms/eplus-module-wms-api/src/main/java/com/syj/eplus/module/wms/enums/StockTypeEnum.java)
- [V1_0_0_002__Eplus初始化.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_002__Eplus初始化.sql)
- [StockNoticeMapper.xml](file://eplus-module-wms/eplus-module-wms-biz/src/main/resources/mapper/stockNotice/StockNoticeMapper.xml)
- [BillMapper.xml](file://eplus-module-wms/eplus-module-wms-biz/src/main/resources/mapper/bill/BillMapper.xml)
</cite>

## 目录
1. [引言](#引言)
2. [核心实体设计](#核心实体设计)
3. [出入库状态管理](#出入库状态管理)
4. [数据模型ER图](#数据模型er图)
5. [出入库业务流程](#出入库业务流程)
6. [SQL建表语句](#sql建表语句)
7. [MyBatis Mapper配置](#mybatis-mapper配置)
8. [最佳实践](#最佳实践)

## 引言
本文档详细描述了出入库管理系统的数据模型设计，重点介绍出入库通知单、出入库单据等核心实体的设计与实现。系统通过精细化的状态管理和完整的数据流转机制，支持入库通知、出库通知、调拨通知等多种操作。文档包含实体关系图、状态枚举、SQL建表语句和MyBatis配置示例，为开发者提供出入库数据建模的最佳实践指导。

## 核心实体设计

出入库管理系统的核心实体主要包括出入库通知单（StockNotice）、出入库通知单明细（StockNoticeItem）、出入库单（Bill）和出入库单明细（BillItem）。这些实体构成了出入库业务的数据基础。

**出入库通知单（StockNotice）** 是出入库业务的起点，记录了出入库的基本信息，包括通知类型、状态、时间、公司信息等。通知单可以是入库通知或出库通知，通过noticeType字段区分。

**出入库通知单明细（StockNoticeItem）** 记录了通知单中每个产品的详细信息，包括产品信息、数量、重量、体积等。一个通知单可以包含多个明细项，通过noticeId与主表关联。

**出入库单（Bill）** 是实际执行出入库操作的单据，由通知单转换而来。它记录了出入库的实际执行情况，包括出入库时间、仓库信息、状态等。

**出入库单明细（BillItem）** 记录了出入库单中每个产品的实际出入库情况，包括实际数量、箱数、重量、体积等。

这些实体通过合理的字段设计和关系关联，完整地记录了出入库业务的全过程。

**本节来源**
- [StockNoticeDO.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/dal/dataobject/stockNotice/StockNoticeDO.java)
- [StockNoticeItemDO.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/dal/dataobject/stockNotice/StockNoticeItemDO.java)
- [BillDO.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/dal/dataobject/bill/BillDO.java)
- [BillItemDO.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/dal/dataobject/bill/BillItemDO.java)

## 出入库状态管理

出入库管理系统通过多个枚举类来管理不同实体的状态，确保业务流程的准确性和可追溯性。

### 通知单状态管理（NoticeStatusEnum）
通知单状态枚举定义了出入库通知单的生命周期状态：
- **UN_CONVERT(1,"未转")**: 通知单创建后但尚未转换为出入库单
- **CONVERTED(2,"已转")**: 通知单已完全转换为出入库单
- **CANCEL(3,"作废")**: 通知单被取消或作废
- **PART_CONVERT(4,"部分转")**: 通知单部分转换为出入库单
- **IN_CONVERT(5,"转单中")**: 通知单正在转换过程中

### 出入库单状态管理（StockBillStatusEnum）
出入库单状态枚举定义了出入库单的处理状态：
- **UN_CONFIRM(1,"未确认")**: 出入库单创建后但尚未确认
- **CONFIRMED(2,"已确认")**: 出入库单已确认，出入库操作已完成
- **CANCEL(3,"作废")**: 出入库单被取消或作废

### 出入库状态管理（StockStatusEnum）
出入库状态枚举定义了具体产品出入库的完成状态：
- **NOT(1,"未收/出货")**: 产品尚未进行出入库操作
- **PART(2,"部分收/出货")**: 产品部分完成出入库操作
- **ALL(3,"完全收/出货")**: 产品完全完成出入库操作

这些状态枚举通过清晰的状态定义和转换规则，确保了出入库业务流程的可控性和可追踪性。

**本节来源**
- [NoticeStatusEnum.java](file://eplus-module-wms/eplus-module-wms-api/src/main/java/com/syj/eplus/module/wms/enums/NoticeStatusEnum.java)
- [StockBillStatusEnum.java](file://eplus-module-wms/eplus-module-wms-api/src/main/java/com/syj/eplus/module/wms/enums/StockBillStatusEnum.java)
- [StockStatusEnum.java](file://eplus-module-wms/eplus-module-wms-api/src/main/java/com/syj/eplus/module/wms/enums/StockStatusEnum.java)

## 数据模型ER图

```mermaid
erDiagram
STOCK_NOTICE {
bigint id PK
varchar(20) code UK
tinyint notice_type
tinyint notice_status
datetime notice_time
datetime expect_date
bigint company_id FK
varchar(100) company_name
decimal(19,6) total_volume
json total_weight
tinyint print_flag
int print_times
varchar(500) remark
datetime create_time
datetime update_time
tinyint deleted
}
STOCK_NOTICE_ITEM {
bigint id PK
bigint notice_id FK
int sort_num
int source_sort_num
tinyint notice_item_status
bigint sku_id FK
varchar(20) sku_code
varchar(100) sku_name
varchar(20) csku_code
bigint vender_id FK
varchar(20) vender_code
varchar(100) vender_name
bigint cust_id FK
varchar(20) cust_code
varchar(100) cust_name
varchar(100) cust_po
int order_quantity
int order_box_quantity
int qty_per_outerbox
decimal(19,6) total_volume
json total_weight
decimal(19,6) pallet_volume
json pallet_weight
varchar(500) remark
datetime create_time
datetime update_time
tinyint deleted
}
BILL {
bigint id PK
varchar(20) code UK
tinyint bill_type
tinyint bill_status
varchar(20) notice_code FK
bigint sale_contract_id FK
varchar(20) sale_contract_code
datetime bill_time
bigint warehouse_id FK
varchar(100) warehouse_name
tinyint print_flag
int print_times
bigint company_id FK
varchar(100) companyName
varchar(500) remark
datetime create_time
datetime update_time
tinyint deleted
}
BILL_ITEM {
bigint id PK
bigint source_id FK
tinyint source_type
tinyint bill_type
int sort_num
int source_sort_num
tinyint notice_item_status
bigint sku_id FK
varchar(20) sku_code
varchar(100) sku_name
varchar(20) csku_code
bigint warehouse_id FK
varchar(100) warehouse_name
varchar(500) position
bigint vender_id FK
varchar(20) vender_code
varchar(100) vender_name
bigint cust_id FK
varchar(20) cust_code
varchar(100) cust_name
varchar(100) cust_po
int order_quantity
int order_box_quantity
int qty_per_outerbox
int act_quantity
int act_box_quantity
decimal(19,6) total_volume
json total_weight
decimal(19,6) pallet_volume
json pallet_weight
bigint company_id FK
varchar(100) company_name
varchar(500) remark
datetime create_time
datetime update_time
tinyint deleted
}
STOCK_NOTICE ||--o{ STOCK_NOTICE_ITEM : "包含"
STOCK_NOTICE ||--o{ BILL : "转换为"
BILL ||--o{ BILL_ITEM : "包含"
```

**图表来源**
- [V1_0_0_002__Eplus初始化.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_002__Eplus初始化.sql)
- [StockNoticeDO.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/dal/dataobject/stockNotice/StockNoticeDO.java)
- [StockNoticeItemDO.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/dal/dataobject/stockNotice/StockNoticeItemDO.java)
- [BillDO.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/dal/dataobject/bill/BillDO.java)
- [BillItemDO.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/dal/dataobject/bill/BillItemDO.java)

## 出入库业务流程

出入库业务流程从创建通知单开始，经过审核、转换、执行等环节，最终完成出入库操作。以下是主要业务流程的数据流转：

1. **创建出入库通知单**: 用户创建出入库通知单，填写基本信息和明细项。系统生成通知单主表（wms_notice）和明细表（wms_notice_item）记录。

2. **通知单审核**: 通知单提交后进入审核流程，审核状态通过auditStatus字段记录，流程实例ID通过processInstanceId字段关联。

3. **转换为出入库单**: 审核通过的通知单可以转换为出入库单。系统根据通知单信息创建出入库单（wms_bill）和明细（wms_bill_item），同时更新通知单状态为"已转"或"部分转"。

4. **执行出入库操作**: 仓库人员根据出入库单执行实际的出入库操作，记录实际出入库数量、时间等信息。

5. **更新库存**: 出入库操作完成后，系统更新库存明细（wms_stock）中的可用数量、已用数量等信息。

6. **状态同步**: 各环节的状态变化通过状态枚举进行管理，确保业务流程的完整性和一致性。

在整个流程中，系统通过外键关联、状态字段和业务规则，确保数据的一致性和完整性。

**本节来源**
- [StockNoticeDO.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/dal/dataobject/stockNotice/StockNoticeDO.java)
- [BillDO.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/dal/dataobject/bill/BillDO.java)
- [NoticeStatusEnum.java](file://eplus-module-wms/eplus-module-wms-api/src/main/java/com/syj/eplus/module/wms/enums/NoticeStatusEnum.java)
- [StockBillStatusEnum.java](file://eplus-module-wms/eplus-module-wms-api/src/main/java/com/syj/eplus/module/wms/enums/StockBillStatusEnum.java)

## SQL建表语句

以下是出入库管理系统核心表的SQL建表语句：

```sql
-- 出入库通知单表
CREATE TABLE IF NOT EXISTS `wms_notice` (
    `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',
    `code` varchar(20) NOT NULL DEFAULT '' COMMENT '单号',
    `notice_type` tinyint DEFAULT NULL COMMENT '通知类型 1-入库通知单、2-出库通知单',
    `notice_status` tinyint DEFAULT NULL COMMENT '通知单状态 1-未转 2-已转 3-作废',
    `notice_time` datetime DEFAULT NULL COMMENT '通知时间',
    `expect_date` datetime DEFAULT NULL COMMENT '预计到/出货日期',
    `company_id` bigint DEFAULT NULL COMMENT '归属公司主键',
    `company_name` varchar(100) DEFAULT NULL COMMENT '归属公司名称',
    `total_volume` decimal(19,6) DEFAULT NULL COMMENT '总体积(cm³)',
    `total_weight` json DEFAULT NULL COMMENT '总毛重（{数量,单位}）',
    `print_flag` tinyint DEFAULT NULL COMMENT '打印状态 0-未打印 1-已打印',
    `print_times` int NOT NULL DEFAULT 0 COMMENT '打印次数',
    `remark` varchar(500) DEFAULT NULL COMMENT '备注',
    `creator` int unsigned DEFAULT NULL COMMENT '创建人',
    `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updater` int unsigned DEFAULT NULL COMMENT '修改人',
    `update_time` datetime DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
    `deleted` tinyint NOT NULL DEFAULT '0' COMMENT '删除  0-有效 1-删除',
    PRIMARY KEY (`id`),
    UNIQUE KEY `idx_code` (`code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci COMMENT='仓储管理-入(出)库通知单';

-- 出入库通知单明细表
CREATE TABLE IF NOT EXISTS `wms_notice_item` (
    `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',
    `notice_id` bigint DEFAULT NULL COMMENT '入/出库通知单主键',
    `sort_num` int DEFAULT NULL COMMENT '序号',
    `source_sort_num` int DEFAULT NULL COMMENT '来源单据明细序号',
    `notice_item_status` tinyint DEFAULT NULL COMMENT '入/出库状态（未收/出货、部分收/出货、完全收/出货）',
    `sku_id` bigint DEFAULT NULL COMMENT '产品主键',
    `sku_code` varchar(20) DEFAULT NULL COMMENT '产品编号',
    `sku_name` varchar(100) DEFAULT NULL COMMENT '产品中文名称',
    `csku_code` varchar(20) DEFAULT NULL COMMENT '客户货号',
    `vender_id` bigint DEFAULT NULL COMMENT '供应商主键',
    `vender_code` varchar(20) DEFAULT NULL COMMENT '供应商编码',
    `vender_name` varchar(100) DEFAULT NULL COMMENT '供应商名称',
    `cust_id` bigint DEFAULT NULL COMMENT '客户主键',
    `cust_code` varchar(20) DEFAULT NULL COMMENT '客户编码',
    `cust_name` varchar(100) DEFAULT NULL COMMENT '客户名称',
    `cust_po` varchar(100) DEFAULT NULL COMMENT '客户PO号',
    `order_quantity` int DEFAULT NULL COMMENT '应收/出数量',
    `order_box_quantity` int DEFAULT NULL COMMENT '应收/出箱数',
    `qty_per_outerbox` int DEFAULT NULL COMMENT '外箱装量',
    `total_volume` decimal(19,6) DEFAULT NULL COMMENT '总体积(单箱体积x箱数cm³)',
    `total_weight` json DEFAULT NULL COMMENT '总毛重（单箱毛重x箱数 {数量,单位}）',
    `pallet_volume` decimal(19,6) DEFAULT NULL COMMENT '单托体积（cm³）',
    `pallet_weight` json DEFAULT NULL COMMENT '单托毛重（{数量,单位}）',
    `remark` varchar(500) DEFAULT NULL COMMENT '备注',
    `creator` int unsigned DEFAULT NULL COMMENT '创建人',
    `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updater` int unsigned DEFAULT NULL COMMENT '修改人',
    `update_time` datetime DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
    `deleted` tinyint NOT NULL DEFAULT '0' COMMENT '删除  0-有效 1-删除',
    PRIMARY KEY (`id`),
    KEY `idx_notice_id` (`notice_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci COMMENT='仓储管理-入(出)库通知单-明细';

-- 出入库单表
CREATE TABLE IF NOT EXISTS `wms_bill` (
    `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '主键',
    `code` varchar(20) NOT NULL DEFAULT '' COMMENT '单号',
    `bill_type` tinyint DEFAULT NULL COMMENT '入/出库类型 1-入库单、2-出库单',
    `bill_status` tinyint DEFAULT NULL COMMENT '单据状态1-未确认 2-已确认 3-作废',
    `notice_code` varchar(20) DEFAULT NULL COMMENT '入/出库通知单号',
    `sale_contract_id` bigint DEFAULT NULL COMMENT '销售合同主键',
    `sale_contract_code` varchar(20) DEFAULT NULL COMMENT '销售合同号',
    `bill_time` datetime DEFAULT NULL COMMENT '入/出库时间',
    `warehouse_id` bigint DEFAULT NULL COMMENT '仓库主键',
    `warehouse_name` varchar(100) DEFAULT NULL COMMENT '仓库名称',
    `print_flag` tinyint DEFAULT NULL COMMENT '打印状态 0-未打印 1-已打印',
    `print_times` int NOT NULL DEFAULT 0 COMMENT '打印次数',
    `company_id` bigint DEFAULT NULL COMMENT '归属公司主键',
    `company_name` varchar(100) DEFAULT NULL COMMENT '归属公司名称',
    `remark` varchar(500) DEFAULT NULL COMMENT '备注',
    `creator` int unsigned DEFAULT NULL COMMENT '创建人',
    `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updater` int unsigned DEFAULT NULL COMMENT '修改人',
    `update_time` datetime DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
    `deleted` tinyint NOT NULL DEFAULT '0' COMMENT '删除  0-有效 1-删除',
    PRIMARY KEY (`id`),
    UNIQUE KEY `idx_code` (`code`),
    KEY `idx_notice_code` (`notice_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci COMMENT='仓储管理-入(出)库单';
```

**本节来源**
- [V1_0_0_002__Eplus初始化.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_002__Eplus初始化.sql)

## MyBatis Mapper配置

以下是出入库管理系统核心Mapper的配置示例：

```xml
<!-- 出入库通知单Mapper -->
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.syj.eplus.module.wms.dal.mysql.stockNotice.StockNoticeMapper">
    <!-- 一般情况下，尽可能使用 Mapper 进行 CRUD 增删改查即可。
         无法满足的场景，例如说多表关联查询，才使用 XML 编写 SQL。
         代码生成器暂时只生成 Mapper XML 文件本身，更多推荐 MybatisX 快速开发插件来生成查询。
         文档可见：https://www.iocoder.cn/MyBatis/x-plugins/ -->
</mapper>

<!-- 出入库单Mapper -->
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.syj.eplus.module.wms.dal.mysql.bill.BillMapper">
    <!-- 一般情况下，尽可能使用 Mapper 进行 CRUD 增删改查即可。
         无法满足的场景，例如说多表关联查询，才使用 XML 编写 SQL。
         代码生成器暂时只生成 Mapper XML 文件本身，更多推荐 MybatisX 快速开发插件来生成查询。
         文档可见：https://www.iocoder.cn/MyBatis/x-plugins/ -->
</mapper>
```

在实际开发中，建议使用MyBatis Plus的BaseMapper进行基本的CRUD操作，对于复杂的查询可以使用MybatisX插件生成对应的XML配置。

**本节来源**
- [StockNoticeMapper.xml](file://eplus-module-wms/eplus-module-wms-biz/src/main/resources/mapper/stockNotice/StockNoticeMapper.xml)
- [BillMapper.xml](file://eplus-module-wms/eplus-module-wms-biz/src/main/resources/mapper/bill/BillMapper.xml)

## 最佳实践

在出入库数据建模和开发过程中，建议遵循以下最佳实践：

1. **状态管理**: 使用枚举类管理业务状态，确保状态值的类型安全和可维护性。避免使用魔法值。

2. **数据一致性**: 通过外键约束和业务逻辑确保主表与明细表的数据一致性。在转换通知单为出入库单时，应验证数据完整性。

3. **性能优化**: 为常用查询字段创建索引，如单号、状态、时间等字段。避免N+1查询问题。

4. **扩展性设计**: 使用JSON字段存储复杂数据结构（如重量、金额等），便于未来扩展。对于可能变化的业务规则，考虑使用配置表管理。

5. **审计跟踪**: 保留创建人、创建时间、修改人、修改时间等审计字段，便于问题追踪和数据分析。

6. **软删除**: 使用deleted字段实现软删除，避免数据丢失，同时保持业务连续性。

7. **事务管理**: 在涉及多个表操作的业务场景中（如通知单转出入库单），使用事务确保数据一致性。

8. **缓存策略**: 对于频繁查询但不常变更的数据（如产品信息、供应商信息），考虑使用Redis等缓存机制提升性能。

遵循这些最佳实践，可以构建稳定、高效、可维护的出入库管理系统。

**本节来源**
- [StockNoticeDO.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/dal/dataobject/stockNotice/StockNoticeDO.java)
- [BillDO.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/dal/dataobject/bill/BillDO.java)
- [V1_0_0_002__Eplus初始化.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_002__Eplus初始化.sql)