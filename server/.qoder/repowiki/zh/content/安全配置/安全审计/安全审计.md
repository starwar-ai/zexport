# 安全审计

<cite>
**本文档引用的文件**  
- [OperateLogAspect.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/aop/OperateLogAspect.java)
- [OperateLog.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/annotations/OperateLog.java)
- [OperateTypeEnum.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/enums/OperateTypeEnum.java)
- [LoginLogDO.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/dal/dataobject/logger/LoginLogDO.java)
- [LoginLogTypeEnum.java](file://yudao-module-system/yudao-module-system-api/src/main/java/cn/iocoder/yudao/module/system/enums/logger/LoginLogTypeEnum.java)
- [LoginResultEnum.java](file://yudao-module-system/yudao-module-system-api/src/main/java/cn/iocoder/yudao/module/system/enums/logger/LoginResultEnum.java)
- [OperateLogFrameworkService.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/service/OperateLogFrameworkService.java)
- [OperateLogFrameworkServiceImpl.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/service/OperateLogFrameworkServiceImpl.java)
- [OperateLogUtils.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/util/OperateLogUtils.java)
- [ApiErrorLog.java](file://yudao-framework/yudao-spring-boot-starter-web/src/main/java/cn/iocoder/yudao/framework/apilog/core/service/ApiErrorLog.java)
- [GlobalExceptionHandler.java](file://yudao-framework/yudao-spring-boot-starter-web/src/main/java/cn/iocoder/yudao/framework/web/core/handler/GlobalExceptionHandler.java)
- [V1_0_0_001__框架初始化.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_001__框架初始化.sql)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 引言
本安全审计文档全面覆盖系统中的审计日志功能，包括登录日志、操作日志和异常日志的记录机制。文档详细说明了`@OperateLog`注解的使用方法和配置选项，描述了审计日志的数据结构、存储策略和查询接口。此外，还提供了审计日志的分析方法、监控告警配置、敏感操作的特殊审计要求、合规性考虑、数据保留策略和归档方案，并指导开发者如何添加自定义审计点。

## 项目结构
系统采用模块化架构，安全审计功能主要集中在`yudao-framework`模块下的`yudao-spring-boot-starter-operatelog`组件中。该组件通过AOP切面实现操作日志的自动记录。登录日志和异常日志分别由系统模块和Web框架模块处理。审计日志数据存储在数据库的`system_login_log`、`system_operate_log`和`system_api_error_log`表中。

```mermaid
graph TB
subgraph "审计日志模块"
OperateLog[操作日志]
LoginLog[登录日志]
ErrorLog[异常日志]
end
subgraph "核心框架"
AOP[切面编程]
Web[Web框架]
DB[数据库]
end
OperateLog --> AOP
LoginLog --> Web
ErrorLog --> Web
AOP --> DB
Web --> DB
```

**图示来源**
- [OperateLogAspect.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/aop/OperateLogAspect.java)
- [GlobalExceptionHandler.java](file://yudao-framework/yudao-spring-boot-starter-web/src/main/java/cn/iocoder/yudao/framework/web/core/handler/GlobalExceptionHandler.java)
- [V1_0_0_001__框架初始化.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_001__框架初始化.sql)

**章节来源**
- [OperateLogAspect.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/aop/OperateLogAspect.java)
- [GlobalExceptionHandler.java](file://yudao-framework/yudao-spring-boot-starter-web/src/main/java/cn/iocoder/yudao/framework/web/core/handler/GlobalExceptionHandler.java)

## 核心组件
安全审计系统的核心组件包括操作日志切面`OperateLogAspect`、操作日志注解`@OperateLog`、登录日志实体`LoginLogDO`和异常日志处理`GlobalExceptionHandler`。这些组件协同工作，实现了全面的审计功能。

**章节来源**
- [OperateLogAspect.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/aop/OperateLogAspect.java)
- [LoginLogDO.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/dal/dataobject/logger/LoginLogDO.java)
- [GlobalExceptionHandler.java](file://yudao-framework/yudao-spring-boot-starter-web/src/main/java/cn/iocoder/yudao/framework/web/core/handler/GlobalExceptionHandler.java)

## 架构概述
系统审计架构采用分层设计，上层为注解和API，中层为切面和处理器，底层为数据存储。操作日志通过`@OperateLog`注解触发，由`OperateLogAspect`切面捕获并记录。登录日志在用户认证过程中生成。异常日志在全局异常处理器中捕获并记录。

```mermaid
graph TD
A[应用层] --> B[控制层]
B --> C[服务层]
C --> D[持久层]
E[@OperateLog] --> F[OperateLogAspect]
G[登录/登出] --> H[LoginLogService]
I[异常] --> J[GlobalExceptionHandler]
F --> K[OperateLogFrameworkService]
H --> L[LoginLogMapper]
J --> M[ApiErrorLogService]
K --> N[system_operate_log]
L --> O[system_login_log]
M --> P[system_api_error_log]
```

**图示来源**
- [OperateLogAspect.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/aop/OperateLogAspect.java)
- [OperateLogFrameworkService.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/service/OperateLogFrameworkService.java)
- [LoginLogDO.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/dal/dataobject/logger/LoginLogDO.java)
- [GlobalExceptionHandler.java](file://yudao-framework/yudao-spring-boot-starter-web/src/main/java/cn/iocoder/yudao/framework/web/core/handler/GlobalExceptionHandler.java)

## 详细组件分析

### 操作日志组件分析
操作日志是系统审计的核心，通过`@OperateLog`注解实现方法级别的操作记录。该注解支持模块、操作名、操作类型等配置，可灵活控制日志记录行为。

#### 操作日志类图
```mermaid
classDiagram
class OperateLogAspect {
+ThreadLocal<String> CONTENT
+ThreadLocal<Map<String, Object>> EXTS
-OperateLogFrameworkService operateLogFrameworkService
+around(ProceedingJoinPoint, Operation)
+around(ProceedingJoinPoint, OperateLog)
-around0(ProceedingJoinPoint, OperateLog, Operation)
-log0(ProceedingJoinPoint, OperateLog, Operation, LocalDateTime, Object, Throwable)
-fillUserFields(OperateLog)
-fillModuleFields(OperateLog, ProceedingJoinPoint, OperateLog, Operation)
-fillRequestFields(OperateLog)
-fillMethodFields(OperateLog, ProceedingJoinPoint, OperateLog, LocalDateTime, Object, Throwable)
-isLogEnable(ProceedingJoinPoint, OperateLog)
}
class OperateLog {
+String module()
+String name()
+OperateTypeEnum[] type()
+boolean enable()
+boolean logArgs()
+boolean logResultData()
}
class OperateTypeEnum {
+Integer type
+GET(1)
+CREATE(2)
+UPDATE(3)
+DELETE(4)
+EXPORT(5)
+IMPORT(6)
+OTHER(0)
+PRINT(7)
}
class OperateLogFrameworkService {
+createOperateLog(OperateLog)
}
class OperateLogFrameworkServiceImpl {
-OperateLogApi operateLogApi
+createOperateLog(OperateLog)
}
class OperateLogUtils {
+addOperateLog(List<ChangeRecord>, String, String)
+setContent(String)
+addExt(String, Object)
+addOperateLog(String, String, String)
}
OperateLogAspect --> OperateLogFrameworkService : "使用"
OperateLogAspect --> OperateLog : "处理"
OperateLogAspect --> OperateTypeEnum : "引用"
OperateLogFrameworkServiceImpl --> OperateLogApi : "调用"
OperateLogUtils --> OperateLogAspect : "设置上下文"
```

**图示来源**
- [OperateLogAspect.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/aop/OperateLogAspect.java)
- [OperateLog.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/annotations/OperateLog.java)
- [OperateTypeEnum.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/enums/OperateTypeEnum.java)
- [OperateLogFrameworkService.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/service/OperateLogFrameworkService.java)
- [OperateLogFrameworkServiceImpl.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/service/OperateLogFrameworkServiceImpl.java)
- [OperateLogUtils.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/util/OperateLogUtils.java)

**章节来源**
- [OperateLogAspect.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/aop/OperateLogAspect.java)
- [OperateLog.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/annotations/OperateLog.java)
- [OperateTypeEnum.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/enums/OperateTypeEnum.java)

### 登录日志组件分析
登录日志记录用户的登录和登出行为，包括成功和失败的登录尝试。这些日志对于安全审计和用户行为分析至关重要。

#### 登录日志类图
```mermaid
classDiagram
class LoginLogDO {
+Long id
+Integer logType
+String traceId
+Long userId
+Integer userType
+String username
+Integer result
+String userIp
+String userAgent
}
class LoginLogTypeEnum {
+Integer type
+LOGIN_USERNAME(100)
+LOGIN_SOCIAL(101)
+LOGIN_MOBILE(103)
+LOGIN_SMS(104)
+LOGOUT_SELF(200)
+LOGOUT_DELETE(202)
}
class LoginResultEnum {
+Integer result
+SUCCESS(0)
+BAD_CREDENTIALS(10)
+USER_DISABLED(20)
+CAPTCHA_NOT_FOUND(30)
+CAPTCHA_CODE_ERROR(31)
}
LoginLogDO --> LoginLogTypeEnum : "引用"
LoginLogDO --> LoginResultEnum : "引用"
```

**图示来源**
- [LoginLogDO.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/dal/dataobject/logger/LoginLogDO.java)
- [LoginLogTypeEnum.java](file://yudao-module-system/yudao-module-system-api/src/main/java/cn/iocoder/yudao/module/system/enums/logger/LoginLogTypeEnum.java)
- [LoginResultEnum.java](file://yudao-module-system/yudao-module-system-api/src/main/java/cn/iocoder/yudao/module/system/enums/logger/LoginResultEnum.java)

**章节来源**
- [LoginLogDO.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/dal/dataobject/logger/LoginLogDO.java)
- [LoginLogTypeEnum.java](file://yudao-module-system/yudao-module-system-api/src/main/java/cn/iocoder/yudao/module/system/enums/logger/LoginLogTypeEnum.java)
- [LoginResultEnum.java](file://yudao-module-system/yudao-module-system-api/src/main/java/cn/iocoder/yudao/module/system/enums/logger/LoginResultEnum.java)

### 异常日志组件分析
异常日志自动捕获系统运行时的异常信息，包括异常类型、消息、堆栈跟踪等详细信息，为故障排查提供重要依据。

#### 异常日志处理流程
```mermaid
sequenceDiagram
participant Client as "客户端"
participant Controller as "控制器"
participant ExceptionHandler as "全局异常处理器"
participant ErrorLogService as "错误日志服务"
participant DB as "数据库"
Client->>Controller : 发送请求
Controller->>Controller : 执行业务逻辑
Controller->>ExceptionHandler : 抛出异常
ExceptionHandler->>ExceptionHandler : initExceptionLog()
ExceptionHandler->>ErrorLogService : createApiErrorLog()
ErrorLogService->>DB : 保存异常日志
ExceptionHandler-->>Client : 返回错误响应
```

**图示来源**
- [GlobalExceptionHandler.java](file://yudao-framework/yudao-spring-boot-starter-web/src/main/java/cn/iocoder/yudao/framework/web/core/handler/GlobalExceptionHandler.java)
- [ApiErrorLog.java](file://yudao-framework/yudao-spring-boot-starter-web/src/main/java/cn/iocoder/yudao/framework/apilog/core/service/ApiErrorLog.java)

**章节来源**
- [GlobalExceptionHandler.java](file://yudao-framework/yudao-spring-boot-starter-web/src/main/java/cn/iocoder/yudao/framework/web/core/handler/GlobalExceptionHandler.java)

## 依赖分析
安全审计系统依赖于多个核心组件，包括AOP框架、Web框架、数据库访问层和分布式追踪系统。这些依赖关系确保了审计功能的完整性和可靠性。

```mermaid
graph TD
A[操作日志] --> B[Spring AOP]
A --> C[MyBatis]
A --> D[Redis]
B --> E[Spring Framework]
C --> F[MySQL]
D --> G[Redis Server]
H[登录日志] --> I[Spring Security]
H --> C
J[异常日志] --> K[Spring MVC]
J --> C
A --> L[TracerUtils]
H --> L
J --> L
```

**图示来源**
- [OperateLogAspect.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/aop/OperateLogAspect.java)
- [GlobalExceptionHandler.java](file://yudao-framework/yudao-spring-boot-starter-web/src/main/java/cn/iocoder/yudao/framework/web/core/handler/GlobalExceptionHandler.java)
- [LoginLogDO.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/dal/dataobject/logger/LoginLogDO.java)

**章节来源**
- [OperateLogAspect.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/aop/OperateLogAspect.java)
- [GlobalExceptionHandler.java](file://yudao-framework/yudao-spring-boot-starter-web/src/main/java/cn/iocoder/yudao/framework/web/core/handler/GlobalExceptionHandler.java)

## 性能考虑
审计日志的记录采用异步方式，避免阻塞主业务流程。操作日志通过`@Async`注解实现异步持久化，确保不影响系统响应时间。同时，系统提供了灵活的配置选项，允许根据需要开启或关闭特定类型的日志记录，以平衡审计需求和系统性能。

## 故障排除指南
当审计日志功能出现问题时，应首先检查相关组件的配置和依赖关系。常见问题包括日志未记录、日志内容不完整或日志存储失败。通过查看系统日志和调试信息，可以快速定位和解决问题。

**章节来源**
- [OperateLogAspect.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/aop/OperateLogAspect.java)
- [GlobalExceptionHandler.java](file://yudao-framework/yudao-spring-boot-starter-web/src/main/java/cn/iocoder/yudao/framework/web/core/handler/GlobalExceptionHandler.java)

## 结论
本安全审计文档全面介绍了系统的审计日志功能，包括登录日志、操作日志和异常日志的实现机制。通过`@OperateLog`注解和AOP切面，系统实现了灵活且强大的操作日志记录功能。登录日志和异常日志为安全审计提供了重要支持。建议在实际使用中根据业务需求合理配置日志级别和存储策略，以确保系统的安全性和性能。