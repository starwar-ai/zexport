# 操作日志查询与分析

<cite>
**本文档引用的文件**  
- [OperateLogAspect.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/aop/OperateLogAspect.java)
- [OperateLog.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/annotations/OperateLog.java)
- [OperateLogFrameworkServiceImpl.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/service/OperateLogFrameworkServiceImpl.java)
- [OperateLogApi.java](file://yudao-module-system/yudao-module-system-api/src/main/java/cn/iocoder/yudao/module/system/api/logger/OperateLogApi.java)
- [OperateLogService.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/service/logger/OperateLogService.java)
- [OperateLogServiceImpl.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/service/logger/OperateLogServiceImpl.java)
- [OperateLogMapper.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/dal/mysql/logger/OperateLogMapper.java)
- [OperateLogDO.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/dal/dataobject/logger/OperateLogDO.java)
- [OperateLogController.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/controller/admin/logger/OperateLogController.java)
- [OperateLogPageReqVO.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/controller/admin/logger/vo/operatelog/OperateLogPageReqVO.java)
- [OperateLogConvert.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/convert/logger/OperateLogConvert.java)
- [OperateLogFormatDict.java](file://eplus-framework/eplus-common/src/main/java/com/syj/eplus/framework/common/dict/OperateLogFormatDict.java)
</cite>

## 目录
1. [简介](#简介)
2. [操作日志架构概述](#操作日志架构概述)
3. [核心组件分析](#核心组件分析)
4. [操作日志查询接口](#操作日志查询接口)
5. [过滤条件详解](#过滤条件详解)
6. [分页处理与性能优化](#分页处理与性能优化)
7. [常用查询场景示例](#常用查询场景示例)
8. [日志分析工具功能](#日志分析工具功能)
9. [异常操作检测](#异常操作检测)
10. [结论](#结论)

## 简介

操作日志系统是企业级应用中重要的审计和监控组件，用于记录用户在系统中的各种操作行为。本文档详细介绍了操作日志的查询接口、过滤条件、分页处理、性能优化策略以及高级分析功能。通过本系统，管理员可以审计特定用户的操作行为、追踪数据变更历史、检测异常操作等，确保系统的安全性和可追溯性。

**本文档引用的文件**  
- [OperateLogAspect.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/aop/OperateLogAspect.java)
- [OperateLog.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/annotations/OperateLog.java)

## 操作日志架构概述

操作日志系统采用分层架构设计，主要包括以下几个核心组件：

```mermaid
graph TD
A[前端界面] --> B[OperateLogController]
B --> C[OperateLogService]
C --> D[OperateLogMapper]
D --> E[数据库]
F[业务方法] --> G[OperateLogAspect]
G --> C
G --> H[OperateLogFrameworkService]
H --> I[OperateLogApi]
I --> C
```

**图示来源**  
- [OperateLogController.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/controller/admin/logger/OperateLogController.java)
- [OperateLogService.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/service/logger/OperateLogService.java)
- [OperateLogMapper.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/dal/mysql/logger/OperateLogMapper.java)
- [OperateLogAspect.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/aop/OperateLogAspect.java)

## 核心组件分析

### 操作日志切面（OperateLogAspect）

操作日志切面是系统的核心组件，负责拦截带有`@OperateLog`注解的方法调用，自动记录操作日志。

```mermaid
classDiagram
class OperateLogAspect {
+static final ThreadLocal<String> CONTENT
+static final ThreadLocal<Map<String, Object>> EXTS
-OperateLogFrameworkService operateLogFrameworkService
+around(ProceedingJoinPoint, Operation)
+around(ProceedingJoinPoint, OperateLog)
-around0(ProceedingJoinPoint, OperateLog, Operation)
-log(ProceedingJoinPoint, OperateLog, Operation, LocalDateTime, Object, Throwable)
-log0(ProceedingJoinPoint, OperateLog, Operation, LocalDateTime, Object, Throwable)
-fillUserFields(OperateLog)
-fillModuleFields(OperateLog, ProceedingJoinPoint, OperateLog, Operation)
-fillRequestFields(OperateLog)
-fillMethodFields(OperateLog, ProceedingJoinPoint, OperateLog, LocalDateTime, Object, Throwable)
-isLogEnable(ProceedingJoinPoint, OperateLog)
+setContent(String)
+addExt(String, Object)
-clearThreadLocal()
}
class OperateLogFrameworkService {
+createOperateLog(OperateLog)
}
OperateLogAspect --> OperateLogFrameworkService : "依赖"
```

**图示来源**  
- [OperateLogAspect.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/aop/OperateLogAspect.java)
- [OperateLogFrameworkService.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/service/OperateLogFrameworkService.java)

### 操作日志数据对象（OperateLogDO）

操作日志数据对象定义了存储在数据库中的日志记录结构。

```mermaid
classDiagram
class OperateLogDO {
+Long id
+String traceId
+Long userId
+Integer userType
+String module
+String name
+String type
+String content
+Map<String, Object> exts
+String requestMethod
+String requestUrl
+String userIp
+String userAgent
+String javaMethod
+String javaMethodArgs
+LocalDateTime startTime
+Integer duration
+Integer resultCode
+String resultMsg
+String resultData
}
class BaseDO {
+Long id
+LocalDateTime createTime
+Integer deleted
}
OperateLogDO --|> BaseDO : "继承"
```

**图示来源**  
- [OperateLogDO.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/dal/dataobject/logger/OperateLogDO.java)
- [BaseDO.java](file://yudao-framework/yudao-spring-boot-starter-mybatis/src/main/java/cn/iocoder/yudao/framework/mybatis/core/dataobject/BaseDO.java)

## 操作日志查询接口

### 查询接口定义

操作日志查询接口提供了分页查询和导出功能。

```mermaid
sequenceDiagram
participant 前端 as 前端界面
participant 控制器 as OperateLogController
participant 服务层 as OperateLogService
participant 数据访问层 as OperateLogMapper
participant 数据库 as 数据库
前端->>控制器 : GET /system/operate-log/page
控制器->>服务层 : getOperateLogPage(pageReqVO)
服务层->>数据访问层 : selectPage(pageReqVO, userIds)
数据访问层->>数据库 : 执行SQL查询
数据库-->>数据访问层 : 返回查询结果
数据访问层-->>服务层 : 返回分页结果
服务层-->>控制器 : 返回分页结果
控制器-->>前端 : 返回CommonResult<PageResult<OperateLogRespVO>>
```

**图示来源**  
- [OperateLogController.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/controller/admin/logger/OperateLogController.java)
- [OperateLogService.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/service/logger/OperateLogService.java)
- [OperateLogMapper.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/dal/mysql/logger/OperateLogMapper.java)

### 接口参数说明

| 参数 | 类型 | 描述 | 示例 |
|------|------|------|------|
| module | String | 操作模块，模糊匹配 | "订单" |
| userNickname | String | 用户昵称，模糊匹配 | "管理员" |
| type | Integer | 操作类型 | 1 |
| success | Boolean | 操作状态 | true |
| startTime | LocalDateTime[] | 开始时间范围 | ["2022-07-01 00:00:00", "2022-07-01 23:59:59"] |
| pageNum | Integer | 页码 | 1 |
| pageSize | Integer | 每页大小 | 10 |

**本文档引用的文件**  
- [OperateLogPageReqVO.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/controller/admin/logger/vo/operatelog/OperateLogPageReqVO.java)

## 过滤条件详解

### 时间范围过滤

时间范围过滤允许用户查询特定时间段内的操作日志。

```mermaid
flowchart TD
Start([开始]) --> ValidateTimeRange["验证时间范围"]
ValidateTimeRange --> TimeRangeValid{"时间范围有效?"}
TimeRangeValid --> |否| ReturnError["返回错误信息"]
TimeRangeValid --> |是| BuildQuery["构建查询条件"]
BuildQuery --> AddTimeCondition["添加时间条件到查询"]
AddTimeCondition --> ExecuteQuery["执行查询"]
ExecuteQuery --> ReturnResult["返回查询结果"]
ReturnError --> End([结束])
ReturnResult --> End
```

**图示来源**  
- [OperateLogMapper.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/dal/mysql/logger/OperateLogMapper.java)
- [OperateLogServiceImpl.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/service/logger/OperateLogServiceImpl.java)

### 操作人员过滤

操作人员过滤通过用户昵称进行模糊匹配，支持多用户查询。

```java
// 在 OperateLogServiceImpl.java 中的实现
@Override
public PageResult<OperateLogDO> getOperateLogPage(OperateLogPageReqVO pageReqVO) {
    // 处理基于用户昵称的查询
    Collection<Long> userIds = null;
    if (StrUtil.isNotEmpty(pageReqVO.getUserNickname())) {
        userIds = convertSet(userService.getUserListByNickname(pageReqVO.getUserNickname()), AdminUserDO::getId);
        if (CollUtil.isEmpty(userIds)) {
            return PageResult.empty();
        }
    }
    // 查询分页
    return operateLogMapper.selectPage(pageReqVO, userIds);
}
```

**本文档引用的文件**  
- [OperateLogServiceImpl.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/service/logger/OperateLogServiceImpl.java)

### 操作类型过滤

操作类型过滤支持按操作分类进行查询，如创建、更新、删除等。

```java
// 在 OperateLogMapper.java 中的实现
default PageResult<OperateLogDO> selectPage(OperateLogPageReqVO reqVO, Collection<Long> userIds) {
    LambdaQueryWrapperX<OperateLogDO> query = new LambdaQueryWrapperX<OperateLogDO>()
            .likeIfPresent(OperateLogDO::getModule, reqVO.getModule())
            .inIfPresent(OperateLogDO::getUserId, userIds)
            .eqIfPresent(OperateLogDO::getType, reqVO.getType())
            .betweenIfPresent(OperateLogDO::getStartTime, reqVO.getStartTime());
    // ... 其他条件
    return selectPage(reqVO, query);
}
```

**本文档引用的文件**  
- [OperateLogMapper.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/dal/mysql/logger/OperateLogMapper.java)

### 业务模块过滤

业务模块过滤支持按功能模块进行查询，如订单、用户、权限等。

```java
// 在 OperateLogMapper.java 中的实现
LambdaQueryWrapperX<OperateLogDO> query = new LambdaQueryWrapperX<OperateLogDO>()
        .likeIfPresent(OperateLogDO::getModule, reqVO.getModule())
        // ... 其他条件
```

**本文档引用的文件**  
- [OperateLogMapper.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/dal/mysql/logger/OperateLogMapper.java)

## 分页处理与性能优化

### 分页处理机制

系统采用标准的分页机制，支持大数量日志数据的高效查询。

```mermaid
flowchart TD
Start([开始]) --> CheckPagination["检查分页参数"]
CheckPagination --> Valid{"参数有效?"}
Valid --> |否| ReturnError["返回错误信息"]
Valid --> |是| BuildQuery["构建查询条件"]
BuildQuery --> ExecutePagedQuery["执行分页查询"]
ExecutePagedQuery --> ProcessResult["处理查询结果"]
ProcessResult --> ReturnPagedResult["返回分页结果"]
ReturnError --> End([结束])
ReturnPagedResult --> End
```

**图示来源**  
- [OperateLogMapper.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/dal/mysql/logger/OperateLogMapper.java)
- [OperateLogServiceImpl.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/service/logger/OperateLogServiceImpl.java)

### 性能优化策略

系统采用多种性能优化策略，确保在大数据量下的查询效率。

```mermaid
graph TD
A[查询优化] --> B[索引优化]
A --> C[查询条件优化]
A --> D[分页优化]
A --> E[缓存优化]
B --> B1[为常用查询字段创建索引]
B --> B2[复合索引优化]
C --> C1[避免全表扫描]
C --> C2[使用合适的查询条件]
D --> D1[限制单页数据量]
D --> D2[深度分页优化]
E --> E1[用户信息缓存]
E --> E2[查询结果缓存]
```

**本文档引用的文件**  
- [OperateLogMapper.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/dal/mysql/logger/OperateLogMapper.java)
- [OperateLogServiceImpl.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/service/logger/OperateLogServiceImpl.java)

## 常用查询场景示例

### 审计特定用户的操作行为

审计特定用户的操作行为是常见的安全审计需求。

```mermaid
sequenceDiagram
participant 管理员 as 管理员
participant 系统 as 操作日志系统
管理员->>系统 : 查询用户"张三"的操作日志
系统->>系统 : 根据用户昵称查找用户ID
系统->>系统 : 查询该用户ID的所有操作日志
系统->>管理员 : 返回操作日志列表
管理员->>系统 : 查看具体操作详情
系统->>管理员 : 返回详细操作信息
```

**图示来源**  
- [OperateLogServiceImpl.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/service/logger/OperateLogServiceImpl.java)

### 追踪数据变更历史

追踪数据变更历史对于问题排查和数据恢复非常重要。

```mermaid
sequenceDiagram
participant 开发人员 as 开发人员
participant 系统 as 操作日志系统
开发人员->>系统 : 查询订单ID为12345的变更历史
系统->>系统 : 在扩展字段中查找orderId=12345的日志
系统->>系统 : 按时间顺序排序查询结果
系统->>开发人员 : 返回变更历史列表
开发人员->>系统 : 查看每次变更的详细信息
系统->>开发人员 : 返回详细变更信息
```

**图示来源**  
- [OperateLogServiceImpl.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/service/logger/OperateLogServiceImpl.java)

## 日志分析工具功能

### 操作频率统计

操作频率统计功能可以帮助管理员了解系统的使用情况。

```mermaid
flowchart TD
Start([开始]) --> SelectTimeRange["选择时间范围"]
SelectTimeRange --> GroupByUser["按用户分组"]
GroupByUser --> CountOperations["统计操作次数"]
CountOperations --> SortByCount["按操作次数排序"]
SortByCount --> GenerateReport["生成统计报告"]
GenerateReport --> DisplayResult["显示结果"]
DisplayResult --> End([结束])
```

**图示来源**  
- [OperateLogServiceImpl.java](file://yudao-module-system/yudao-module-system-biz/src/main/java/cn/iocoder/yudao/module/system/service/logger/OperateLogServiceImpl.java)

### 异常操作检测

异常操作检测功能可以及时发现潜在的安全威胁。

```mermaid
flowchart TD
Start([开始]) --> DefineRules["定义异常规则"]
DefineRules --> MonitorOperations["监控操作日志"]
MonitorOperations --> CheckRules["检查是否违反规则"]
CheckRules --> ViolationDetected{"发现异常?"}
ViolationDetected --> |是| GenerateAlert["生成告警"]
ViolationDetected --> |否| ContinueMonitoring["继续监控"]
GenerateAlert --> NotifyAdmin["通知管理员"]
NotifyAdmin --> LogIncident["记录事件"]
LogIncident --> End([结束])
ContinueMonitoring --> MonitorOperations
```

**图示来源**  
- [OperateLogAspect.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/aop/OperateLogAspect.java)

## 异常操作检测

### 检测规则配置

系统支持灵活的异常操作检测规则配置。

```java
// 在 OperateLogAspect.java 中的异常处理
private void log(ProceedingJoinPoint joinPoint,
                cn.iocoder.yudao.framework.operatelog.core.annotations.OperateLog operateLog,
                Operation operation,
                LocalDateTime startTime, Object result, Throwable exception) {
    try {
        // 判断不记录的情况
        if (!isLogEnable(joinPoint, operateLog)) {
            return;
        }
        // 真正记录操作日志
        this.log0(joinPoint, operateLog, operation, startTime, result, exception);
    } catch (Throwable ex) {
        log.error("[log][记录操作日志时，发生异常，其中参数是 joinPoint({}) operateLog({}) apiOperation({}) result({}) exception({}) ]",
                joinPoint, operateLog, operation, result, exception, ex);
    }
}
```

**本文档引用的文件**  
- [OperateLogAspect.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/aop/OperateLogAspect.java)

### 告警通知机制

当检测到异常操作时，系统会触发告警通知。

```mermaid
sequenceDiagram
participant 系统 as 操作日志系统
participant 告警中心 as 告警中心
participant 管理员 as 管理员
系统->>系统 : 检测到异常操作
系统->>告警中心 : 发送告警信息
告警中心->>告警中心 : 处理告警
告警中心->>管理员 : 发送通知
管理员->>系统 : 登录系统查看详情
系统->>管理员 : 显示异常操作详情
```

**图示来源**  
- [OperateLogAspect.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/aop/OperateLogAspect.java)

## 结论

本文档详细介绍了操作日志查询与分析系统的架构、核心组件、查询接口、过滤条件、分页处理、性能优化策略以及高级分析功能。通过本系统，管理员可以有效地审计用户操作、追踪数据变更、检测异常行为，确保系统的安全性和可追溯性。系统采用分层架构设计，具有良好的扩展性和维护性，能够满足企业级应用的复杂需求。

**本文档引用的文件**  
- [OperateLogAspect.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/aop/OperateLogAspect.java)
- [OperateLog.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/annotations/OperateLog.java)
- [OperateLogFrameworkServiceImpl.java](file://yudao-framework/yudao-spring-boot-starter-operatelog/src/main/java/cn/iocoder/yudao/framework/operatelog/core/service/OperateLogFrameworkServiceImpl.java)