# 库存锁定

<cite>
**本文档引用的文件**   
- [StockLockServiceImpl.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/service/stocklock/StockLockServiceImpl.java)
- [StockLockDO.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/dal/dataobject/stocklock/StockLockDO.java)
- [StockLockVO.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/controller/admin/stocklock/vo/StockLockVO.java)
- [SaleContractServiceImpl.java](file://eplus-module-sms/eplus-module-sms-biz/src/main/java/com/syj/eplus/module/sms/service/salecontract/SaleContractServiceImpl.java)
- [PurchasePlanServiceImpl.java](file://eplus-module-scm/eplus-module-scm-biz/src/main/java/com/syj/eplus/module/scm/service/purchaseplan/PurchasePlanServiceImpl.java)
- [StockApiImpl.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/api/stock/StockApiImpl.java)
- [StockApi.java](file://eplus-module-wms/eplus-module-wms-api/src/main/java/com/syj/eplus/module/wms/api/stock/IStockApi.java)
- [StockLockSourceTypeEnum.java](file://eplus-module-wms/eplus-module-wms-api/src/main/java/com/syj/eplus/module/wms/enums/StockLockSourceTypeEnum.java)
- [V1_0_0_002__Eplus初始化.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_002__Eplus初始化.sql)
</cite>

## 目录
1. [库存锁定机制概述](#库存锁定机制概述)
2. [核心组件分析](#核心组件分析)
3. [库存锁定创建与释放流程](#库存锁定创建与释放流程)
4. [业务场景中的库存预占实现](#业务场景中的库存预占实现)
5. [锁定状态与可用库存计算关系](#锁定状态与可用库存计算关系)
6. [锁定优先级处理规则](#锁定优先级处理规则)
7. [锁定冲突解决策略](#锁定冲突解决策略)
8. [性能优化建议](#性能优化建议)

## 库存锁定机制概述

库存锁定机制是企业资源规划系统中的关键功能，用于在销售合同、采购订单、生产计划等业务场景中实现库存预占。该机制通过在数据库中创建锁定记录来确保特定数量的库存被预留，防止其他业务流程占用，从而保证业务的顺利执行。系统支持多种业务单据类型的库存锁定，包括销售合同、采购计划、加工单和调拨单等。

**Section sources**
- [StockLockSourceTypeEnum.java](file://eplus-module-wms/eplus-module-wms-api/src/main/java/com/syj/eplus/module/wms/enums/StockLockSourceTypeEnum.java#L1-L24)
- [V1_0_0_002__Eplus初始化.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_002__Eplus初始化.sql#L2405-L2427)

## 核心组件分析

库存锁定功能由多个核心组件构成，包括数据对象、服务实现、API接口和控制器。这些组件协同工作，实现了完整的库存锁定生命周期管理。

```mermaid
classDiagram
class StockLockDO {
+Long id
+Long stockId
+String batchCode
+Long sourceOrderId
+String sourceOrderCode
+Integer sourceOrderType
+Integer lockType
+Integer lockQuantity
+LocalDateTime lockTime
+Long lockByUserId
+String lockByUserName
+String remark
}
class StockLockServiceImpl {
+Long createStockLock(StockLockSaveReqVO)
+void deleteStockLock(Long)
+StockLockRespVO getStockLock(Long)
+PageResult~StockLockDO~ getStockLockPage(StockLockPageReqVO)
+Boolean cancel(Long)
+Long batchCreateStockLock(StockLockSaveReqVO[])
}
class IStockApi {
+Boolean batchLockStock(StockLockSaveReqVO[])
+Boolean cancelStockLock(String, Collection~Long~, Integer)
+Map~Long, Integer~ getLockCountBySaleContractCode(String)
+StockLockRespVO[] getStockLockListBySaleCode(String)
}
class StockLockController {
+CommonResult~Long~ createStockLock(StockLockSaveReqVO)
+CommonResult~Boolean~ createBatch(StockLockSaveReqVO[])
+CommonResult~Boolean~ cancel(Long)
}
StockLockDO --> StockLockServiceImpl : "被使用"
StockLockServiceImpl --> IStockApi : "实现"
StockLockController --> StockLockServiceImpl : "调用"
```

**Diagram sources **
- [StockLockDO.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/dal/dataobject/stocklock/StockLockDO.java#L1-L25)
- [StockLockServiceImpl.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/service/stocklock/StockLockServiceImpl.java#L53-L393)
- [StockApi.java](file://eplus-module-wms/eplus-module-wms-api/src/main/java/com/syj/eplus/module/wms/api/stock/IStockApi.java#L1-L246)
- [StockLockController.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/controller/admin/stocklock/StockLockController.java#L35-L61)

**Section sources**
- [StockLockDO.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/dal/dataobject/stocklock/StockLockDO.java#L1-L25)
- [StockLockServiceImpl.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/service/stocklock/StockLockServiceImpl.java#L53-L393)
- [StockApi.java](file://eplus-module-wms/eplus-module-wms-api/src/main/java/com/syj/eplus/module/wms/api/stock/IStockApi.java#L1-L246)
- [StockLockController.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/controller/admin/stocklock/StockLockController.java#L35-L61)

## 库存锁定创建与释放流程

库存锁定的创建和释放是通过一系列协调的操作完成的，确保数据的一致性和业务的完整性。创建流程首先验证库存可用性，然后更新库存数量并创建锁定记录；释放流程则相反，先删除锁定记录，再更新库存数量。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Controller as "StockLockController"
participant Service as "StockLockServiceImpl"
participant Mapper as "StockLockMapper"
participant StockService as "StockService"
Client->>Controller : createStockLock(请求)
Controller->>Service : 调用createStockLock
Service->>StockService : 获取库存信息
StockService-->>Service : 返回库存信息
Service->>Service : 计算锁定数量和可用数量
Service->>Service : 验证锁定数量是否超出限制
alt 数量超出限制
Service-->>Controller : 抛出异常
Controller-->>Client : 返回错误
else 数量有效
Service->>StockService : 更新库存数量
StockService-->>Service : 更新结果
Service->>Mapper : 插入锁定记录
Mapper-->>Service : 返回插入ID
Service-->>Controller : 返回成功
Controller-->>Client : 返回成功响应
end
```

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Controller as "StockLockController"
participant Service as "StockLockServiceImpl"
participant Mapper as "StockLockMapper"
participant StockService as "StockService"
Client->>Controller : cancel(锁定ID)
Controller->>Service : 调用cancel
Service->>Mapper : 获取锁定记录
Mapper-->>Service : 返回锁定记录
Service->>StockService : 获取库存信息
StockService-->>Service : 返回库存信息
Service->>StockService : 计算新的锁定数量
Service->>StockService : 更新库存数量
StockService-->>Service : 更新结果
Service->>Mapper : 删除锁定记录
Mapper-->>Service : 删除结果
Service-->>Controller : 返回结果
Controller-->>Client : 返回响应
```

**Diagram sources **
- [StockLockServiceImpl.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/service/stocklock/StockLockServiceImpl.java#L73-L150)
- [StockApiImpl.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/api/stock/StockApiImpl.java#L184-L206)

**Section sources**
- [StockLockServiceImpl.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/service/stocklock/StockLockServiceImpl.java#L73-L150)
- [StockApiImpl.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/api/stock/StockApiImpl.java#L184-L206)

## 业务场景中的库存预占实现

在不同的业务场景中，库存预占的实现方式有所不同。销售合同、采购计划等业务模块通过调用库存API来实现库存锁定，确保业务流程的顺利进行。

```mermaid
sequenceDiagram
participant SaleContract as "销售合同服务"
participant StockApi as "库存API"
participant StockLockService as "库存锁定服务"
SaleContract->>StockApi : cancelStockLock(合同编号)
StockApi->>StockLockService : 查询锁定记录
StockLockService-->>StockApi : 返回锁定记录
StockApi->>StockLockService : 逐个取消锁定
loop 每个锁定记录
StockLockService->>StockLockService : cancel(锁定ID)
end
StockApi-->>SaleContract : 返回结果
SaleContract->>StockApi : batchLockStock(锁定请求列表)
StockApi->>StockLockService : 批量创建锁定
StockLockService-->>StockApi : 返回结果
StockApi-->>SaleContract : 返回结果
```

```mermaid
flowchart TD
A[销售合同创建/更新] --> B[释放原有锁定]
B --> C{是否存在锁定批次?}
C --> |是| D[构建锁定请求列表]
C --> |否| E[更新销售明细]
D --> F[调用批量锁定API]
F --> G[更新销售明细锁定信息]
G --> H[完成销售合同处理]
E --> H
```

**Diagram sources **
- [SaleContractServiceImpl.java](file://eplus-module-sms/eplus-module-sms-biz/src/main/java/com/syj/eplus/module/sms/service/salecontract/SaleContractServiceImpl.java#L763-L793)
- [PurchasePlanServiceImpl.java](file://eplus-module-scm/eplus-module-scm-biz/src/main/java/com/syj/eplus/module/scm/service/purchaseplan/PurchasePlanServiceImpl.java#L649-L686)

**Section sources**
- [SaleContractServiceImpl.java](file://eplus-module-sms/eplus-module-sms-biz/src/main/java/com/syj/eplus/module/sms/service/salecontract/SaleContractServiceImpl.java#L763-L793)
- [PurchasePlanServiceImpl.java](file://eplus-module-scm/eplus-module-scm-biz/src/main/java/com/syj/eplus/module/scm/service/purchaseplan/PurchasePlanServiceImpl.java#L649-L686)

## 锁定状态与可用库存计算关系

库存锁定状态与可用库存的计算关系是库存管理的核心逻辑。系统通过维护库存的多个数量字段来精确跟踪库存状态，确保库存数据的准确性和一致性。

```mermaid
classDiagram
class StockDO {
+Long id
+Integer initQuantity
+Integer producingQuantity
+Integer usedQuantity
+Integer lockQuantity
+Integer availableQuantity
+BigDecimal price
}
class StockLockDO {
+Long id
+Long stockId
+Integer lockQuantity
+LocalDateTime lockTime
+String sourceOrderCode
+Integer sourceOrderType
}
class CalculationLogic {
+totalQuantity = initQuantity - producingQuantity
+availableQuantity = totalQuantity - usedQuantity
+lockedQuantity = existingLockQuantity + newLockQuantity
+验证 : lockedQuantity ≤ producingQuantity + availableQuantity
}
StockDO "1" --> "0..*" StockLockDO : 包含
CalculationLogic --> StockDO : 计算基于
```

```mermaid
flowchart TD
A[库存记录] --> B[初始数量 initQuantity]
A --> C[在制数量 producingQuantity]
A --> D[已用数量 usedQuantity]
A --> E[锁定数量 lockQuantity]
A --> F[可用数量 availableQuantity]
G[总可用库存] --> H[总数量 = 初始数量 - 在制数量]
H --> I[可用数量 = 总数量 - 已用数量]
I --> J[锁定验证]
J --> K{锁定数量 ≤ 在制数量 + 可用数量?}
K --> |是| L[允许锁定]
K --> |否| M[抛出异常 STOCK_LOCK_EXCEED]
```

**Diagram sources **
- [StockLockServiceImpl.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/service/stocklock/StockLockServiceImpl.java#L81-L91)
- [StockDO.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/dal/dataobject/stock/StockDO.java)

**Section sources**
- [StockLockServiceImpl.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/service/stocklock/StockLockServiceImpl.java#L81-L91)

## 锁定优先级处理规则

系统通过多种因素来确定库存锁定的优先级，包括订单紧急程度、客户等级等业务属性。这些规则在业务逻辑层实现，确保高优先级的订单能够优先获得库存资源。

```mermaid
classDiagram
class StockLockSourceTypeEnum {
+SALE_CONTRACT(1, "销售合同")
+PROCESSING(2, "加工单")
+TRANSFER_ORDER(3, "调拨单")
+PURCHASE_PLAN(4, "采购计划")
+OUT_STOCK(5, "出库通知单")
}
class PriorityRule {
+客户等级权重
+订单紧急程度权重
+业务类型权重
+创建时间权重
+综合优先级 = Σ(权重 × 值)
}
class LockAllocation {
+按优先级排序待锁定请求
+逐个处理高优先级请求
+为高优先级订单预留库存
+低优先级订单等待或部分锁定
}
PriorityRule --> StockLockSourceTypeEnum : 参考
LockAllocation --> PriorityRule : 使用
```

```mermaid
flowchart TD
A[锁定请求] --> B[提取业务属性]
B --> C[客户等级]
B --> D[订单紧急程度]
B --> E[业务类型]
B --> F[创建时间]
C --> G[计算优先级分数]
D --> G
E --> G
F --> G
G --> H{优先级排序}
H --> I[高优先级锁定]
I --> J[检查库存可用性]
J --> K{库存充足?}
K --> |是| L[执行锁定]
K --> |否| M[部分锁定或等待]
L --> N[更新库存]
M --> N
N --> O[完成锁定流程]
```

**Diagram sources **
- [StockLockSourceTypeEnum.java](file://eplus-module-wms/eplus-module-wms-api/src/main/java/com/syj/eplus/module/wms/enums/StockLockSourceTypeEnum.java#L1-L24)
- [SaleContractServiceImpl.java](file://eplus-module-sms/eplus-module-sms-biz/src/main/java/com/syj/eplus/module/sms/service/salecontract/SaleContractServiceImpl.java)
- [PurchasePlanServiceImpl.java](file://eplus-module-scm/eplus-module-scm-biz/src/main/java/com/syj/eplus/module/scm/service/purchaseplan/PurchasePlanServiceImpl.java)

**Section sources**
- [StockLockSourceTypeEnum.java](file://eplus-module-wms/eplus-module-wms-api/src/main/java/com/syj/eplus/module/wms/enums/StockLockSourceTypeEnum.java#L1-L24)

## 锁定冲突解决策略

当多个业务流程同时尝试锁定同一库存时，系统通过事务管理和冲突检测机制来解决锁定冲突，确保数据的一致性和业务的正确性。

```mermaid
sequenceDiagram
participant SystemA as "业务系统A"
participant SystemB as "业务系统B"
participant LockService as "锁定服务"
SystemA->>LockService : 请求锁定库存X
LockService->>LockService : 开始事务
LockService->>LockService : 检查库存可用性
LockService-->>SystemA : 处理中...
SystemB->>LockService : 请求锁定库存X
LockService->>LockService : 开始事务
LockService->>LockService : 检查库存可用性
alt 库存已被锁定
LockService-->>SystemB : 返回冲突错误
else 库存仍可用
LockService-->>SystemB : 处理中...
end
LockService->>LockService : 更新库存数量
LockService->>LockService : 创建锁定记录
LockService->>LockService : 提交事务
LockService-->>SystemA : 返回成功
```

```mermaid
flowchart TD
A[锁定请求] --> B[获取数据库行级锁]
B --> C{能否获取锁?}
C --> |能| D[执行锁定逻辑]
C --> |不能| E[等待或超时]
E --> F{等待超时?}
F --> |是| G[返回失败]
F --> |否| H[继续等待]
D --> I[验证库存可用性]
I --> J{库存充足?}
J --> |是| K[更新库存并创建锁定]
J --> |否| L[回滚事务]
K --> M[提交事务]
L --> N[返回失败]
M --> O[返回成功]
```

**Diagram sources **
- [StockLockServiceImpl.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/service/stocklock/StockLockServiceImpl.java#L72-L73)
- [StockLockServiceImpl.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/service/stocklock/StockLockServiceImpl.java#L133-L134)

**Section sources**
- [StockLockServiceImpl.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/service/stocklock/StockLockServiceImpl.java#L72-L73)
- [StockLockServiceImpl.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/service/stocklock/StockLockServiceImpl.java#L133-L134)

## 性能优化建议

为了确保库存锁定功能在高并发场景下的性能和稳定性，系统采用了多种优化策略，包括批量操作、缓存机制和数据库优化等。

```mermaid
classDiagram
class PerformanceOptimization {
+批量锁定操作
+数据库连接池
+行级锁优化
+缓存常用数据
+异步处理非关键操作
+索引优化
}
class BatchOperation {
+batchCreateStockLock()
+batchLockStock()
+减少数据库往返次数
+提高吞吐量
}
class CacheStrategy {
+缓存库存信息
+缓存用户信息
+减少数据库查询
+提高响应速度
}
class DatabaseOptimization {
+wms_stock_lock表索引
+source_order_code索引
+stock_id索引
+复合索引优化查询
}
PerformanceOptimization --> BatchOperation : 包含
PerformanceOptimization --> CacheStrategy : 包含
PerformanceOptimization --> DatabaseOptimization : 包含
```

```mermaid
flowchart TD
A[性能瓶颈] --> B[大量单条锁定请求]
B --> C[优化方案]
C --> D[批量锁定]
D --> E[减少事务开销]
D --> F[减少网络往返]
C --> G[数据库优化]
G --> H[添加适当索引]
H --> I[wms_stock_lock.source_order_code]
H --> J[wms_stock_lock.stock_id]
H --> K[复合索引]
C --> L[缓存机制]
L --> M[缓存库存数据]
L --> N[缓存用户数据]
L --> O[减少数据库查询]
C --> P[连接池优化]
P --> Q[合理配置连接池]
P --> R[避免连接耗尽]
C --> S[异步处理]
S --> T[非关键操作异步化]
S --> U[提高响应速度]
```

**Diagram sources **
- [StockLockServiceImpl.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/service/stocklock/StockLockServiceImpl.java#L153-L199)
- [StockApi.java](file://eplus-module-wms/eplus-module-wms-api/src/main/java/com/syj/eplus/module/wms/api/stock/IStockApi.java#L38-L39)
- [V1_0_0_002__Eplus初始化.sql](file://eplus-flyway/src/main/resources/db/migration/common/V1_0_0_002__Eplus初始化.sql#L2405-L2427)

**Section sources**
- [StockLockServiceImpl.java](file://eplus-module-wms/eplus-module-wms-biz/src/main/java/com/syj/eplus/module/wms/service/stocklock/StockLockServiceImpl.java#L153-L199)
- [StockApi.java](file://eplus-module-wms/eplus-module-wms-api/src/main/java/com/syj/eplus/module/wms/api/stock/IStockApi.java#L38-L39)