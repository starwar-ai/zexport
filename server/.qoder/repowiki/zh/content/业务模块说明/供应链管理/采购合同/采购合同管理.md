# 采购合同管理

<cite>
**本文档引用文件**  
- [PurchaseContractApi.java](file://eplus-module-scm/eplus-module-scm-api/src/main/java/com/syj/eplus/module/scm/api/purchasecontract/PurchaseContractApi.java)
- [SavePurchaseContractReqVO.java](file://eplus-module-scm/eplus-module-scm-api/src/main/java/com/syj/eplus/module/scm/api/purchasecontract/dto/SavePurchaseContractReqVO.java)
- [PurchaseContractAllDTO.java](file://eplus-module-scm/eplus-module-scm-api/src/main/java/com/syj/eplus/module/scm/api/purchasecontract/dto/PurchaseContractAllDTO.java)
- [PurchaseContractStatusEnum.java](file://eplus-framework/eplus-common/src/main/java/com/syj/eplus/framework/common/enums/PurchaseContractStatusEnum.java)
- [PurchaseContractServiceImpl.java](file://eplus-module-scm/eplus-module-scm-biz/src/main/java/com/syj/eplus/module/scm/service/purchasecontract/PurchaseContractServiceImpl.java)
- [PurchaseContractController.java](file://eplus-module-scm/eplus-module-scm-biz/src/main/java/com/syj/eplus/module/scm/controller/admin/purchasecontract/PurchaseContractController.java)
</cite>

## 目录
1. [引言](#引言)
2. [采购合同数据模型](#采购合同数据模型)
3. [采购合同全生命周期管理](#采购合同全生命周期管理)
4. [采购合同状态机](#采购合同状态机)
5. [采购合同与采购计划关联机制](#采购合同与采购计划关联机制)
6. [高级功能](#高级功能)
7. [业务场景示例](#业务场景示例)

## 引言
采购合同管理是供应链管理中的核心环节，负责管理从合同创建到关闭的全生命周期。本文档详细说明了采购合同的创建、编辑、审批、执行和关闭等流程，以及合同基本信息的录入规则和校验逻辑。

## 采购合同数据模型

### 核心字段说明
采购合同数据模型包含以下关键字段：

```mermaid
erDiagram
PURCHASE_CONTRACT {
string code PK "合同编号"
long venderId FK "供应商主键"
long purchaseUserId "采购员编码"
integer contractStatus "合同状态"
integer auditStatus "审核状态"
JsonAmount totalAmount "采购总金额"
string venderCode "供应商编码"
string saleContractCode "销售合同编号"
string purchasePlanCode "采购计划编号"
integer auxiliaryFlag "是否辅料采购"
LocalDateTime purchaseTime "采购时间"
LocalDateTime deliveryDate "交货日期"
}
PURCHASE_CONTRACT_ITEM {
long id PK "主键"
string purchaseContractCode FK "采购合同编号"
long skuId "产品主键"
string skuCode "产品编码"
integer quantity "采购数量"
JsonAmount withTaxPrice "含税单价"
string saleItemUniqueCode "销售明细唯一标识"
}
PURCHASE_PAYMENT_PLAN {
long id PK "主键"
string contractCode FK "合同编号"
integer step "付款阶段"
BigDecimal paymentRatio "付款比例"
JsonAmount receivableAmount "应付金额"
}
PURCHASE_CONTRACT ||--o{ PURCHASE_CONTRACT_ITEM : "包含"
PURCHASE_CONTRACT ||--o{ PURCHASE_PAYMENT_PLAN : "包含"
```

**图源**
- [SavePurchaseContractReqVO.java](file://eplus-module-scm/eplus-module-scm-api/src/main/java/com/syj/eplus/module/scm/api/purchasecontract/dto/SavePurchaseContractReqVO.java)
- [PurchaseContractAllDTO.java](file://eplus-module-scm/eplus-module-scm-api/src/main/java/com/syj/eplus/module/scm/api/purchasecontract/dto/PurchaseContractAllDTO.java)

### 关键字段详细说明
| 字段名称 | 字段说明 | 数据类型 | 约束条件 |
|--------|--------|--------|--------|
| **合同编号** | 采购合同的唯一标识符，由系统自动生成 | string | 必填，唯一 |
| **供应商** | 采购合同的供应商信息 | long/string | 必填，关联供应商主键和编码 |
| **合同金额** | 采购合同的总金额，包含币种信息 | JsonAmount | 必填，包含金额和币种 |
| **币种** | 采购合同使用的货币类型 | string | 必填，与供应商默认币种一致 |
| **税率** | 采购合同适用的税率 | integer | 必填，从供应商税务信息获取 |
| **采购员** | 负责该采购合同的采购人员 | long/string | 必填，关联采购员编码和名称 |
| **跟单员** | 负责跟进该采购合同执行的人员 | UserDept | 可选，包含用户ID和部门信息 |
| **交货日期** | 合同约定的货物交付日期 | LocalDateTime | 必填，不能早于当前日期 |
| **付款状态** | 合同的付款进度状态 | integer | 必填，枚举值 |
| **开票状态** | 合同的开票进度状态 | integer | 必填，枚举值 |

**节源**
- [SavePurchaseContractReqVO.java](file://eplus-module-scm/eplus-module-scm-api/src/main/java/com/syj/eplus/module/scm/api/purchasecontract/dto/SavePurchaseContractReqVO.java)

## 采购合同全生命周期管理

### 创建流程
采购合同的创建流程如下：

```mermaid
sequenceDiagram
participant 用户 as "用户"
participant 控制器 as "PurchaseContractController"
participant 服务 as "PurchaseContractServiceImpl"
participant 数据库 as "数据库"
用户->>控制器 : 提交创建请求
控制器->>服务 : 调用createPurchaseContract
服务->>服务 : 验证供应商存在性
服务->>服务 : 生成合同编号
服务->>服务 : 计算总金额
服务->>服务 : 设置默认状态
服务->>数据库 : 插入采购合同主表
数据库-->>服务 : 返回合同ID
服务->>数据库 : 插入采购合同明细
数据库-->>服务 : 返回结果
服务->>服务 : 处理费用分摊
服务->>服务 : 创建订单流
服务->>控制器 : 返回创建结果
控制器-->>用户 : 返回成功响应
```

**图源**
- [PurchaseContractServiceImpl.java](file://eplus-module-scm/eplus-module-scm-biz/src/main/java/com/syj/eplus/module/scm/service/purchasecontract/PurchaseContractServiceImpl.java)
- [PurchaseContractController.java](file://eplus-module-scm/eplus-module-scm-biz/src/main/java/com/syj/eplus/module/scm/controller/admin/purchasecontract/PurchaseContractController.java)

### 编辑流程
采购合同的编辑流程遵循以下规则：
1. 只有在"待提交"或"已驳回"状态下才能进行编辑
2. 编辑时需要重新计算总金额和总数量
3. 修改明细时会记录操作日志
4. 支持批量修改付款计划

### 审批流程
采购合同的审批流程通过工作流引擎实现，主要步骤包括：
1. 提交审批：将合同状态变更为"审批中"
2. 审批通过：将合同状态变更为"待下单"
3. 审批驳回：将合同状态变更为"已驳回"

### 执行流程
采购合同的执行流程包括：
1. 下单：将合同状态变更为"待到货"
2. 生产完成：更新合同明细的入库状态
3. 整单完成：将合同状态变更为"已完成"

### 关闭流程
采购合同的关闭流程包括：
1. 作废：将合同状态变更为"已结案"
2. 反作废：将合同状态恢复为"待提交"

## 采购合同状态机

### 状态定义
采购合同的状态由`PurchaseContractStatusEnum`枚举定义：

```mermaid
classDiagram
class PurchaseContractStatusEnum {
+READY_TO_SUBMIT(1, "待提交")
+AWAITING_APPROVAL(2, "待审批")
+REJECTED(3, "已驳回")
+AWAITING_ORDER(4, "待下单")
+EXPECTING_DELIVERY(5, "待到货")
+FINISHED(6, "已完成")
+CASE_SETTLED(7, "已结案")
}
```

**图源**
- [PurchaseContractStatusEnum.java](file://eplus-framework/eplus-common/src/main/java/com/syj/eplus/framework/common/enums/PurchaseContractStatusEnum.java)

### 状态转换图
采购合同的状态转换关系如下：

```mermaid
stateDiagram-v2
[*] --> 待提交
待提交 --> 待审批 : 提交
待审批 --> 已驳回 : 驳回
待审批 --> 待下单 : 通过
已驳回 --> 待提交 : 编辑
待下单 --> 待到货 : 下单
待到货 --> 已完成 : 整单完成
已完成 --> 已结案 : 作废
待提交 --> 已结案 : 作废
待审批 --> 待提交 : 反审核
待下单 --> 待提交 : 反作废
待到货 --> 待下单 : 反下单
已完成 --> 待到货 : 反整单完成
```

**图源**
- [PurchaseContractServiceImpl.java](file://eplus-module-scm/eplus-module-scm-biz/src/main/java/com/syj/eplus/module/scm/service/purchasecontract/PurchaseContractServiceImpl.java)

### 状态转换条件
| 当前状态 | 目标状态 | 触发条件 | 业务规则 |
|--------|--------|--------|--------|
| **待提交** | **待审批** | 提交审批 | 验证必填字段完整性 |
| **待审批** | **已驳回** | 审批驳回 | 记录驳回原因 |
| **待审批** | **待下单** | 审批通过 | 回写销售合同采购价格 |
| **待下单** | **待到货** | 采购下单 | 生成在制库存 |
| **待到货** | **已完成** | 整单完成 | 验证所有明细已入库 |
| **已完成** | **已结案** | 作废 | 验证无对公支付 |
| **已驳回** | **待提交** | 编辑 | 允许修改合同内容 |

**节源**
- [PurchaseContractServiceImpl.java](file://eplus-module-scm/eplus-module-scm-biz/src/main/java/com/syj/eplus/module/scm/service/purchasecontract/PurchaseContractServiceImpl.java)

## 采购合同与采购计划关联机制

### 关联关系
采购合同与采购计划的关联通过以下字段实现：
- `purchasePlanId`: 采购计划主键
- `purchasePlanCode`: 采购计划编号
- `sourceUniqueCode`: 源唯一标识，用于关联采购计划明细

### 关联流程
采购合同与采购计划的关联流程如下：

```mermaid
flowchart TD
A[采购计划] --> B{是否拆分?}
B --> |是| C[生成多个采购合同]
B --> |否| D[生成单个采购合同]
C --> E[每个合同关联不同计划明细]
D --> F[合同关联所有计划明细]
E --> G[维护sourceUniqueCode映射]
F --> G
G --> H[订单流关联]
```

**图源**
- [PurchaseContractServiceImpl.java](file://eplus-module-scm/eplus-module-scm-biz/src/main/java/com/syj/eplus/module/scm/service/purchasecontract/PurchaseContractServiceImpl.java)

### 数据同步
采购合同与采购计划之间的数据同步规则：
1. 采购合同创建时，同步采购计划的供应商、采购员等基本信息
2. 采购合同审批通过后，回写采购计划的转换状态
3. 采购合同作废时，恢复采购计划的待采购状态

## 高级功能

### 合同拆分
合同拆分功能允许将一个采购计划拆分为多个采购合同：

```mermaid
flowchart LR
A[原始采购计划] --> B[拆分规则]
B --> C[采购合同1]
B --> D[采购合同2]
B --> E[采购合同3]
C --> F[维护sourceUniqueCode]
D --> F
E --> F
```

### 合同合并
合同合并功能允许将多个采购合同合并为一个：

```mermaid
flowchart TB
A[采购合同A] --> C[合并]
B[采购合同B] --> C
C --> D[新采购合同]
D --> E[继承原合同信息]
D --> F[更新订单流]
```

### 变更管理
采购合同的变更管理流程：

```mermaid
sequenceDiagram
participant 用户 as "用户"
participant 服务 as "PurchaseContractServiceImpl"
participant 变更表 as "变更表"
participant 审批流 as "审批流"
用户->>服务 : 发起变更
服务->>服务 : 比对变更字段
服务->>变更表 : 创建变更记录
变更表-->>服务 : 返回变更ID
服务->>审批流 : 提交变更审批
审批流-->>服务 : 返回审批结果
服务->>服务 : 应用变更
服务-->>用户 : 返回结果
```

**节源**
- [PurchaseContractServiceImpl.java](file://eplus-module-scm/eplus-module-scm-biz/src/main/java/com/syj/eplus/module/scm/service/purchasecontract/PurchaseContractServiceImpl.java)

## 业务场景示例

### 标准采购合同创建
```mermaid
flowchart TD
A[选择采购计划] --> B[生成采购合同]
B --> C[填写合同信息]
C --> D[添加采购明细]
D --> E[设置付款计划]
E --> F[提交审批]
F --> G[审批通过]
G --> H[采购下单]
```

### 辅料采购合同处理
辅料采购合同的特殊处理流程：

```mermaid
flowchart LR
A[辅料采购标志] --> B{是否辅料?}
B --> |是| C[特殊审批流程]
B --> |否| D[标准审批流程]
C --> E[费用分摊处理]
E --> F[生成归集信息]
D --> G[标准处理]
```

**节源**
- [PurchaseContractServiceImpl.java](file://eplus-module-scm/eplus-module-scm-biz/src/main/java/com/syj/eplus/module/scm/service/purchasecontract/PurchaseContractServiceImpl.java)